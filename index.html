<<<<<<< HEAD
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>芋圆机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: #FFFFFF;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        @keyframes fade-in-scale {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s ease-out forwards;
        }
        
        .iphone-container {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            background-color: #f8f5f9;
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .status-bar {
            height: 50px;
            background-color: #f8f5f9;
            padding: 0 26px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #787785;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 1px solid rgba(120,119,133,0.1);
        }
        
        .time {
            font-weight: 700;
        }
        
        .status-icons i {
            margin-left: 6px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-overflow-scrolling: touch;
        }

        .home-screen {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .frost-widget {
            width: 88%;
            height: 120px;
            background: #f6f2f1;
            border-radius: 26px;
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: 0 12px 30px rgba(120, 119, 133, 0.08);
        }

        .widget-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #787785;
        }

        .widget-weather {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .widget-weather i {
            color: #debeeb;
            font-size: 22px;
        }

        .widget-temp {
            font-size: 22px;
            font-weight: 700;
            color: #debeeb;
        }

        .widget-greeting {
            font-size: 14px;
            color: #787785;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .widget-greeting:focus {
            outline: none;
            background: #FFFFFF;
            color: #787785;
        }


        .home-header {
            width: 88%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .home-title {
            font-size: 15px;
            font-weight: 600;
            color: #787785;
        }
        
        .avatar-section {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            z-index: 2;
        }
        
        .avatar {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid white;
            box-shadow: 0 6px 16px rgba(120, 119, 133, 0.12);
            z-index: 3;
            overflow: hidden;
        }
        
        .avatar i {
            font-size: 40px;
            color: white;
        }
        
        .info-card {
            width: 90%;
            height: 100px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            position: absolute;
            top: 40px;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 15px;
        }
        
        .user-info {
            text-align: left;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 700;
            color: #787785;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 14px;
            color: #f0d6d7;
            font-weight: 500;
        }
        
        .icons-section {
            width: 90%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }
        
        .left-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 20px rgba(240, 214, 215, 0.3);
            color: white;
            font-size: 28px;
            cursor: pointer;
        }
        
        .right-icons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 15px;
            width: 130px;
        }
        
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }
        
        .app-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-grid {
            width: 88%;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-auto-rows: 100px;
            gap: 16px;
            justify-items: center;
            align-items: start;
        }

        .app-grid-offset {
            margin-top: 24px;
        }

        .app-item {
            width: 100%;
            max-width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
        }

        .app-item:hover .app-icon {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-name {
            font-size: 12px;
            color: #787785;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }



        .message-icon { background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); }
        .feixin-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        .book-icon { background: linear-gradient(135deg, #debeeb 0%, #f0d6d7 100%); }
        .settings-icon { background: linear-gradient(135deg, #debb7b 0%, #debb7b 100%); }
        .brush-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        
        .dock {
            height: 96px;
            min-height: 96px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.75) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(120, 119, 133, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 24px 16px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 -8px 24px rgba(120, 119, 133, 0.06);
        }
        
        .dock-icon {
            width: 75px;
            height: 75px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
            transition: transform 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }
        
        .dock-icon:hover {
            transform: scale(1.05);
        }
        
        .phone-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        .novel-icon { background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); }
        .forum-icon { background: linear-gradient(135deg, #debeeb 0%, #f0d6d7 100%); }
        
        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        /* API 配置弹窗全屏（手机内）样式 */
        #apiModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #apiModal .modal-header {
            border-bottom: 1px solid #f0f0f4;
            /* padding由统一适配逻辑控制 */
        }

        #apiModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 22px 26px;
        }

        #apiModal .form-control {
            border-radius: 14px;
        }

        #apiModal .btn {
            border-radius: 14px;
        }

        .model-picker {
            position: relative;
            width: 100%;
        }

        .model-picker-button {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border: 1px solid #ddd;
            border-radius: 14px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .model-picker-button:focus-visible {
            outline: none;
            border-color: #f0d6d7;
            box-shadow: 0 0 0 2px rgba(240, 214, 215, 0.12);
        }

        .model-picker-button .caret {
            margin-left: 10px;
            font-size: 12px;
            color: #999;
        }

        .model-picker-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            max-height: 260px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 14px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .model-picker-list.is-open {
            display: block;
        }

        .model-picker-item {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .model-picker-item:hover {
            background: #f6f2f1;
        }

        .model-picker-item.is-selected {
            background: rgba(240, 214, 215, 0.2);
            color: #f0d6d7;
            font-weight: 600;
        }
        
        /* 聊天模态窗口全屏样式 */
        #chatModal {
            position: fixed;
            background-color: transparent;
            justify-content: center;
            align-items: center;
        }
        
        #chatModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
            animation: none;
            overflow: hidden;
            position: relative;
        }
        
        #chatModal .modal-header {
            background-color: #FFFFFF;
            border-bottom: 1px solid #f6f2f1;
            display: flex;
            align-items: center;
            /* padding和height由统一适配逻辑控制 */
        }
        
        #chatModal .modal-header h3 {
            flex: 1;
            text-align: center;
            margin: 0;
            color: #787785;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* API警告样式 */
        .api-warning {
            background-color: #fff3cd;
            border-bottom: 1px solid #ffc107;
            padding: 12px 20px;
            color: #856404;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-close:hover {
            background-color: #f5f5f5;
        }

        .cute-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: cute-toast-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cute-toast-pop {
            from {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .cute-toast-content {
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            padding: 28px 48px;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(222, 190, 235, 0.3);
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .cute-toast-content p {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* 聊天窗口按钮样式 */
        #backToFriendList {
            background: none;
            border: none;
            font-size: 24px;
            color: #787785;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            margin-right: 10px;
        }

        #backToFriendList:hover {
            background-color: #f6f2f1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #787785;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            height: 44px;
            padding: 0 15px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        textarea.form-control {
            height: auto;
            padding: 12px 15px;
            min-height: 44px;
        }

        #modelSelect {
            height: 44px;
            background-color: #fff;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #f0d6d7;
            box-shadow: 0 0 0 2px rgba(240, 214, 215, 0.1);
        }
        
        .input-hint {
            margin-top: 6px;
            color: #999;
            font-size: 12px;
        }
        
        .btn {
            padding: 12px 20px;
            height: 48px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }
        
        .btn-secondary {
            background-color: #f6f2f1;
            color: #787785;
        }

        .btn-secondary:hover {
            background-color: #f0d6d7;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* 状态消息样式 */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-message.success {
            background-color: rgba(72, 187, 120, 0.1);
            color: #48bb78;
            border: 1px solid rgba(72, 187, 120, 0.2);
            display: block;
        }
        
        .status-message.error {
            background-color: rgba(245, 101, 101, 0.1);
            color: #f56565;
            border: 1px solid rgba(245, 101, 101, 0.2);
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f6f2f1;
            border-top: 2px solid #f0d6d7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 聊天界面样式 */
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #f6f2f1;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #FFFFFF;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background-color: #f0d6d7;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background-color: #debeeb;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .reply-quote {
            max-width: 80%;
            font-size: 12px;
            color: #666;
            background: rgba(0, 0, 0, 0.06);
            padding: 6px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid rgba(0, 0, 0, 0.12);
            word-break: break-word;
        }

        .reply-quote.user {
            margin-left: auto;
        }

        .reply-quote.ai {
            margin-right: auto;
        }

        .reply-preview {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            background: #f5f5f5;
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .reply-preview-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-preview-close {
            border: none;
            background: transparent;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .image-upload-pill {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: #f6f2f1;
            color: #f0d6d7;
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px dashed rgba(240, 214, 215, 0.35);
        }

        .image-upload-thumb {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .image-upload-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-upload-close {
            border: none;
            background: transparent;
            color: #f0d6d7;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .message-image {
            display: block;
            width: 100%;
            max-width: 220px;
            border-radius: 12px;
            margin-top: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .message-image-wrap {
            position: relative;
            display: inline-block;
            margin-top: 6px;
            border-radius: 12px;
            overflow: hidden;
        }

        .message-image-wrap.user {
            margin-left: auto;
        }

        .message-image-wrap.ai {
            margin-right: auto;
        }

        .message-image.desc-thumb {
            width: 120px;
            height: 120px;
            max-width: none;
            object-fit: cover;
            border-radius: 12px;
        }

        .message-image-hint {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
            pointer-events: none;
        }

        .image-desc-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 12px;
            resize: none;
            height: 110px;
            font-size: 14px;
            font-family: inherit;
            background: #fafafa;
            color: #333;
        }

        .image-confirm-popover {
            position: fixed;
            display: none;
            z-index: 2300;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            font-size: 12px;
            color: #444;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .image-confirm-actions {
            display: flex;
            gap: 8px;
        }

        .image-confirm-btn {
            border: none;
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .image-confirm-btn.yes {
            background: #f0d6d7;
            color: #fff;
        }

        .image-confirm-btn.no {
            background: #f0f0f0;
            color: #666;
        }

        .message-recalled-wrapper {
            display: flex;
            justify-content: center;
        }

        .message-recalled {
            font-size: 12px;
            color: #999;
            background: rgba(0, 0, 0, 0.06);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .message-action-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2200;
            background: rgba(0, 0, 0, 0.05);
        }

        .message-action-menu {
            position: absolute;
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.14);
            transform: scale(0.96);
            opacity: 0;
            transition: transform 0.16s ease, opacity 0.16s ease;
        }

        .message-action-menu.is-open {
            transform: scale(1);
            opacity: 1;
        }

        .message-action-item {
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: #333;
            border-radius: 12px;
            padding: 6px 8px;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }

        .message-action-item i {
            font-size: 16px;
        }

        .message-action-item:active {
            transform: scale(0.95);
        }

        .message-action-item.is-disabled {
            opacity: 0.45;
            pointer-events: none;
        }
        
        .chat-input-area {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input-area-wrap.chat-extra-open .chat-input-row {
            display: none !important;
        }

        .chat-input-area-wrap.chat-extra-open .chat-function-row {
            display: none !important;
        }

        .chat-extra-panel {
            display: none;
            margin-top: 8px;
            padding: 12px 10px;
            border-radius: 14px;
            background: #f6f6f7;
            border: 1px solid #eee;
        }

        .chat-extra-panel.is-open {
            display: block;
        }

        .chat-extra-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px 10px;
        }

        .chat-extra-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 6px;
            border-radius: 14px;
            background: #fff;
            border: 1px solid #f0f0f0;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .chat-extra-item.is-placeholder {
            background: #fafafa;
            border-style: dashed;
            color: #bbb;
            cursor: default;
            box-shadow: none;
        }

        .chat-extra-item.is-placeholder .chat-extra-icon {
            background: #f1f1f1;
            color: #bbb;
        }

        .chat-extra-item:active {
            transform: scale(0.98);
        }

        .chat-extra-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .chat-extra-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 20px;
        }
        
        .chat-send-btn {
            padding: 0 20px;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        /* 刘海模拟 */
        .notch {
            display: none;
        }
        
        /* 好友列表样式 */
        .friend-list {
            max-height: 100%;
            overflow-y: auto;
            padding: 16px !important;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            background: #fff;
            backdrop-filter: none;
            box-shadow: 0 2px 8px rgba(120, 119, 133, 0.05);
            cursor: pointer;
            transition: background 0.15s ease;
            border: none;
        }

        .friend-item:hover {
            background: #f6f2f1;
            transform: none;
            box-shadow: 0 2px 12px rgba(120, 119, 133, 0.08);
        }

        .friend-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(240, 214, 215, 0.1);
        }
        
        .friend-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            margin-right: 14px;
            overflow: hidden;
            box-shadow: none;
            flex-shrink: 0;
            border: none;
        }
        
        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: 600;
            color: #787785;
            margin-bottom: 5px;
            font-size: 15px;
            letter-spacing: 0;
        }

        .friend-persona {
            color: #787785;
            font-size: 13px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .no-friends {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 40px 20px;
            text-align: center;
        }
        
        /* 头像上传样式 */
        .avatar-upload-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: #fafafa;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            margin-bottom: 15px;
            color: #999;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .avatar-upload-preview:hover {
            border-color: #f0d6d7;
            background-color: #f6f2f1;
        }
        
        .avatar-upload-preview i {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .avatar-upload-preview p {
            font-size: 14px;
            margin: 0;
        }
        
        .avatar-upload-preview.has-image {
            background-color: transparent;
            border-color: transparent;
        }
        
        .avatar-upload-preview.has-image i,
        .avatar-upload-preview.has-image p {
            display: none;
        }

        .profile-widget-card {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.2s ease;
        }

        .profile-widget-feedback {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .profile-widget-feedback.is-active {
            opacity: 1;
        }

        .settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: linear-gradient(180deg, #FFFFFF 0%, #f6f2f1 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .settings-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 16px;
            border-bottom: 1px solid #f6f2f1;
            background: #fff;
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #787785;
        }

        .settings-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            font-size: 14px;
            color: #787785;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 8px;
            min-height: 40px;
        }

        .settings-back:hover {
            background: #f6f2f1;
        }

        .settings-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .friend-list-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 8px;
        }

        .friend-list-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #787785;
            font-size: 12px;
            flex: 1;
        }

        .friend-list-nav-item i {
            font-size: 24px;
        }

        .friend-list-nav-item.active {
            color: #f0d6d7;
        }

        .friend-list-nav-item:active {
            opacity: 0.7;
        }

        .settings-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid #f0f0f0;
            min-height: 68px;
        }

        .settings-card:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
        }

        .settings-card-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #787785;
        }

        .settings-card-desc {
            font-size: 12px;
            color: #787785;
        }

        .friend-settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: #f6f2f1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .friend-settings-nav {
            background: #fff;
            padding-right: 16px;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .friend-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #787785;
            flex: 1;
            text-align: center;
        }

        .friend-settings-back {
            background: none;
            border: none;
            font-size: 22px;
            color: #787785;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .friend-settings-back:hover {
            background: #f6f2f1;
        }

        .friend-settings-spacer {
            width: 32px;
            height: 32px;
        }

        .friend-settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .friend-settings-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .friend-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .friend-settings-label {
            font-size: 14px;
            font-weight: 600;
            color: #787785;
        }

        .friend-settings-desc {
            font-size: 12px;
            color: #787785;
        }

        .friend-settings-input,
        .friend-settings-select,
        .friend-settings-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            background: #fff;
        }

        .friend-settings-textarea {
            resize: vertical;
            min-height: 110px;
        }

        .friend-settings-details {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fafafa;
        }

        .friend-settings-details summary {
            list-style: none;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .friend-settings-details summary::-webkit-details-marker {
            display: none;
        }

        .friend-settings-details summary::after {
            content: '›';
            transform: rotate(90deg);
            font-size: 16px;
            color: #aaa;
        }

        .friend-settings-details[open] summary::after {
            transform: rotate(-90deg);
        }

        .voice-status {
            font-size: 12px;
            color: #f0d6d7;
            background: rgba(240, 214, 215, 0.12);
            padding: 4px 10px;
            border-radius: 999px;
        }

        .ios-switch {
            position: relative;
            width: 44px;
            height: 26px;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #d1d5db;
            border-radius: 999px;
            transition: 0.2s ease;
        }

        .ios-slider::before {
            position: absolute;
            content: '';
            height: 22px;
            width: 22px;
            left: 2px;
            top: 2px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: 0.2s ease;
        }

        .ios-switch input:checked + .ios-slider {
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
        }

        .ios-switch input:checked + .ios-slider::before {
            transform: translateX(18px);
        }

        .friend-avatar-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-bottom: 10px;
        }

        .friend-avatar-display {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 40px;
            border: 4px solid #fff;
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.08);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-avatar-display:hover {
            transform: scale(1.08);
            box-shadow: 0 12px 28px rgba(222, 190, 235, 0.2);
        }

        .friend-avatar-display::after {
            content: '点击更换';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .friend-avatar-display:hover::after {
            opacity: 1;
        }

        .friend-avatar-display.has-image i {
            display: none;
        }

        .friend-avatar-btn {
            padding: 8px 20px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }

        .friend-avatar-btn:hover {
            border-color: #f0d6d7;
            color: #f0d6d7;
        }

        .settings-card-meta {
            display: flex;
            gap: 14px;
            font-size: 12px;
            color: #999;
        }

        .settings-status {
            font-size: 12px;
            font-weight: 600;
            color: #f56565;
        }

        .settings-status.ok {
            color: #48bb78;
        }

        .settings-arrow {
            font-size: 16px;
            color: #bbb;
        }

        .data-manage-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .data-manage-item {
            width: 100%;
            padding: 12px 14px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #eee;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .data-manage-item:hover {
            background: #f7f7fb;
        }

        #triggerAiBtn:hover {
            transform: scale(1.08);
            background-color: #f6f2f1 !important;
        }
        #triggerAiBtn:active {
            transform: scale(0.95);
        }

        /* 心声弹窗样式 */
        .heart-voice-popup {
            position: absolute;
            top: 91px;
            right: 12px;
            width: 240px;
            max-width: calc(100% - 24px);
            background: #fff;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(120, 119, 133, 0.1);
            padding: 24px;
            z-index: 2100;
            display: none;
            border: none;
            flex-direction: column;
            gap: 18px;
            transform-origin: top right;
            animation: hv-popup-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes hv-popup-out {
            0% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(0.95) translateY(-10px); }
        }

        .heart-voice-popup.closing {
            animation: hv-popup-out 0.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            pointer-events: none;
        }

        @keyframes hv-popup-in {
            0% { opacity: 0; transform: scale(0.92) translateY(-8px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .heart-voice-popup.is-open {
            display: flex;
        }

        .heart-voice-text {
            font-size: 15px;
            color: #787785;
            line-height: 1.6;
            word-wrap: break-word;
            font-weight: 500;
        }

        .heart-voice-status {
            font-size: 13px;
            color: #787785;
            line-height: 1.5;
        }

        .heart-voice-mood-bar {
            height: 4px;
            background: #f6f2f1;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .heart-voice-mood-fill {
            height: 100%;
            background: linear-gradient(90deg, #debeeb, #f0d6d7);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .heart-voice-mood-label {
            font-size: 12px;
            color: #787785;
            text-align: left;
            margin-top: 6px;
            font-weight: 500;
        }

        .hv-label {
            color: #debeeb;
            font-weight: bold;
            margin-right: 4px;
        }

        /* 心声历史列表样式 */
        .hv-history-item {
            padding: 16px 18px;
            margin: 0 16px 10px;
            background: #f6f2f1;
            border-radius: 16px;
            box-shadow: none;
            border: 1px solid #f6f2f1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        .hv-history-item.selected {
            border-color: #f0d6d7;
            background-color: #FFFFFF;
        }
        .hv-history-item.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            color: #f0d6d7;
            font-weight: bold;
            font-size: 14px;
        }
        .hv-history-item:active {
            transform: scale(0.97);
            background-color: #f6f2f1;
        }
        .hv-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hv-history-time {
            font-size: 12px;
            color: #787785;
            font-weight: 500;
        }
        .hv-history-mood {
            font-size: 11px;
            color: #debeeb;
            background: rgba(222, 190, 235, 0.15);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        .hv-history-content {
            font-size: 14px;
            color: #787785;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        /* 移动端全屏适配 (PWA/Add to Home Screen) */
        @media screen and (max-width: 500px) {
            body {
                padding: 0;
                background: #f8f5f9;
                align-items: flex-start;
            }

            .iphone-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                background-color: #f8f5f9;
            }

            .status-bar {
                padding-top: env(safe-area-inset-top);
                height: auto;
                min-height: 44px;
                padding-bottom: 5px;
            }

            .dock {
                padding-bottom: env(safe-area-inset-bottom);
                height: auto;
                min-height: 90px;
                border-radius: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            /* 修复模态框在移动端的显示 - 仿照主页面大小 */
            .modal {
                padding: 0;
                background-color: transparent;
            }

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }

            #chatModal .modal-header,
            #apiModal .modal-header,
            .settings-nav,
            .friend-settings-nav {
                padding-top: 8px !important;
                padding-left: 12px !important;
                padding-right: 12px !important;
                height: 44px !important;
                min-height: 44px !important;
            }

            /* 移动端返回栏样式由全局规则统一管理 */
        }

        /* 非移动端：弹窗页面仿照主页面大小 */
        @media screen and (min-width: 501px) {
            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 430px;
                height: 90vh;
                max-height: 932px;
                border-radius: 40px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            }
        }

        /* 隐藏状态栏功能 */
        body.hide-status-bar .status-bar {
            display: none !important;
        }

        /* 当状态栏隐藏时，容器顶部不添加padding，让返回栏从顶部开始 */
        @media screen and (max-width: 500px) {
            body.hide-status-bar .screen-content,
            body.hide-status-bar .home-screen,
            body.hide-status-bar .settings-screen,
            body.hide-status-bar .friend-settings-screen,
            body.hide-status-bar #chatModal .modal-content,
            body.hide-status-bar #apiModal .modal-content {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }
        }

        /* ========== 统一页面适配逻辑 ========== */

        /* 1. 所有弹窗页面添加box-sizing，防止margin-top额外撑开高度 */
        #chatModal .modal-content,
        #apiModal .modal-content,
        .settings-screen,
        .friend-settings-screen {
            box-sizing: border-box;
            margin-top: 0;
        }

        /* 2. 状态栏显示/隐藏联动（仅作用于弹窗页面） */
        /* 显示状态栏时：弹窗页面的.status-bar显示 */
        body:not(.hide-status-bar) #chatModal .status-bar,
        body:not(.hide-status-bar) #apiModal .status-bar,
        body:not(.hide-status-bar) .settings-screen .status-bar,
        body:not(.hide-status-bar) .friend-settings-screen .status-bar,
        body:not(.hide-status-bar) .worldbookModal .status-bar {
            display: flex !important;
        }

        /* 隐藏状态栏时：弹窗页面的.status-bar隐藏 */
        body.hide-status-bar #chatModal .status-bar,
        body.hide-status-bar #apiModal .status-bar,
        body.hide-status-bar .settings-screen .status-bar,
        body.hide-status-bar .friend-settings-screen .status-bar,
        body.hide-status-bar .worldbookModal .status-bar {
            display: none !important;
        }

        /* 3. 统一所有弹窗页面的返回栏位置 */
        #chatModal .modal-header,
        #apiModal .modal-header,
        .settings-nav,
        .friend-settings-nav {
            padding-top: 8px !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
            height: 44px !important;
            min-height: 44px !important;
            border-bottom: 1px solid rgba(120, 119, 133, 0.1) !important;
        }

        /* 4. 确保主屏幕完全不受影响（明确保留原有样式） */
        .home-screen {
            margin-top: 0 !important;
        }

        body.hide-status-bar .home-screen {
            margin-top: 0 !important;
        }

        /* 5. 修复弹窗页面顶部空白 */
        /* 确保弹窗页面从顶部开始，无多余间距 */
        #chatModal .modal-content,
        #apiModal .modal-content,
        .settings-screen,
        .friend-settings-screen {
            padding-top: 0 !important;
        }

        /* 6. 修复状态栏隐藏后返回按钮失效 */
        /* 隐藏状态栏时，确保弹窗页面从顶部开始，返回栏完全可见可交互 */
        body.hide-status-bar #chatModal .modal-content,
        body.hide-status-bar #apiModal .modal-content,
        body.hide-status-bar .settings-screen,
        body.hide-status-bar .friend-settings-screen {
            margin-top: 0 !important;
            padding-top: 0 !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* 隐藏状态栏时，返回栏应该在顶部，确保可见可交互 */
        body.hide-status-bar #chatModal .modal-header,
        body.hide-status-bar #apiModal .modal-header,
        body.hide-status-bar .settings-nav,
        body.hide-status-bar .friend-settings-nav {
            position: sticky !important;
            top: 0 !important;
            background: #fff !important;
            z-index: 100 !important;
            flex-shrink: 0 !important;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            height: 50px !important;
            min-height: 50px !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
            display: flex !important;
            align-items: center !important;
            border-bottom: 1px solid rgba(120, 119, 133, 0.1) !important;
        }

        /* 所有返回按钮确保可点击和高层级 */
        .settings-back,
        .friend-settings-back,
        #backToFriendList,
        #charSettingsBack,
        #settingsBack,
        #worldbookBack,
        #closeFriendListModal,
        #closeApiModal {
            z-index: 999 !important;
            pointer-events: auto !important;
            position: relative !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
        }

        /* 确保返回按钮区域可点击 */
        body.hide-status-bar .settings-back,
        body.hide-status-bar .friend-settings-back,
        body.hide-status-bar #backToFriendList,
        body.hide-status-bar #charSettingsBack {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* ========== 统一页面适配逻辑结束 ========== */

        /* 全局适配优化 */
        .iphone-container,
        .settings-screen,
        .friend-settings-screen,
        #chatModal .modal-content,
        #apiModal .modal-content {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 确保移动端全屏无滚动 */
        html, body {
            overflow: hidden;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* 统一焦点样式 */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus {
            outline: none;
        }

        /* 优化触摸反馈 */
        .btn:active,
        .settings-card:active,
        .friend-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        /* 全局隐藏滚动条（保持可滚动） */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="iphone-container">
        <!-- 刘海模拟 -->
        <div class="notch"></div>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div id="statusTime" class="time">14:30</div>
            <div class="status-icons">
                <i id="statusSignal" class="fas fa-signal"></i>
                <i id="statusWifi" class="fas fa-wifi"></i>
                <i id="statusBattery" class="fas fa-battery-three-quarters"></i>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="home-screen">
                <!-- 可自定义个人资料小组件 -->
                <div class="w-full flex justify-center">
                    <div id="profileWidgetV2" class="w-[88%] h-[340px] bg-white rounded-[32px] shadow-[0_15px_40px_rgba(0,0,0,0.08)] flex flex-col overflow-hidden relative mx-auto transition-all duration-300">
                        <!-- 顶部背景图区域 -->
                        <div id="profileWidgetCover" class="w-full h-[45%] bg-zinc-200 bg-cover bg-center relative cursor-pointer group">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                                <i class="fas fa-image text-white/0 group-hover:text-white/60 transition-all text-2xl drop-shadow-md"></i>
                            </div>
                        </div>
                        
                        <!-- 底部内容区域 -->
                        <div id="profileWidgetBottom" class="flex-1 bg-white bg-cover bg-center relative flex flex-col items-center pt-[52px] pb-5 px-6 cursor-pointer group/bottom transition-all duration-300">
                            <div class="absolute inset-0 bg-black/0 group-hover/bottom:bg-black/5 transition-colors pointer-events-none"></div>
                            
                            <!-- 头像 (悬浮在交界处) -->
                            <div class="absolute -top-[46px] left-1/2 -translate-x-1/2 z-20">
                                <button id="editProfileAvatarImage" data-no-bg-change class="w-[92px] h-[92px] rounded-full border-[5px] border-white bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-purple-100 overflow-hidden transition-transform active:scale-95" aria-label="编辑头像图片">
                                    <div class="w-full h-full rounded-full overflow-hidden relative bg-zinc-50">
                                        <img id="profileAvatarImage" src="" alt="Avatar" class="w-full h-full object-cover hidden" />
                                        <div id="profileAvatarImagePlaceholder" class="w-full h-full bg-purple-200 flex items-center justify-center" style="background-image: radial-gradient(#fff 15%, transparent 16%), radial-gradient(#fff 15%, transparent 16%); background-size: 10px 10px; background-position: 0 0, 5px 5px;">
                                            <i class="fas fa-user text-white text-3xl drop-shadow-sm"></i>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 姓名 -->
                            <div data-no-bg-change class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-1">
                                <div id="profileName" contenteditable="true" class="text-[22px] font-bold text-zinc-800 truncate tracking-tight outline-none cursor-text"></div>
                            </div>

                            <!-- Handle -->
                            <div data-no-bg-change class="w-full text-center rounded-lg px-2 py-0.5 hover:bg-gray-50/50 transition-colors relative z-10 mb-4">
                                <div id="profileHandle" contenteditable="true" class="text-[13px] text-gray-400 font-medium truncate outline-none cursor-text"></div>
                            </div>

                            <!-- 状态/Bio -->
                            <div data-no-bg-change class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-auto">
                                <div id="profileStatus" contenteditable="true" class="text-[14px] text-zinc-600 leading-relaxed line-clamp-2 outline-none cursor-text"></div>
                            </div>

                            <!-- 定位 (装饰性) -->
                            <div data-no-bg-change class="w-full flex items-center gap-1.5 text-zinc-300 text-xs font-semibold mt-4 select-none hover:text-purple-300 transition-colors relative z-10 justify-center">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="profileLocation" contenteditable="true" class="outline-none min-w-[20px] cursor-text">Seoul</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 应用入口区域 -->
                <div id="appGrid" class="app-grid app-grid-offset"></div>

            </div>
        </div>
        
        <!-- Dock栏 -->
        <div class="dock">
            <div class="dock-icon phone-icon" id="phoneIcon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="dock-icon novel-icon" id="novelIcon">
                <i class="fas fa-book"></i>
            </div>
            <div class="dock-icon forum-icon" id="forumIcon">
                <i class="fas fa-comments"></i>
            </div>
        </div>
    </div>

    <!-- 可爱提示框 -->
    <div class="cute-toast" id="cuteToast" style="display: none;">
        <div class="cute-toast-content">
            <p>等我⌯･3･⌯ಣ</p>
        </div>
    </div>

    <!-- API配置弹窗 -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="apiStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="apiStatusSignal" class="fas fa-signal"></i>
                    <i id="apiStatusWifi" class="fas fa-wifi"></i>
                    <i id="apiStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            
            <div class="modal-header">
                <h3>API 配置</h3>
                <button class="modal-close" id="closeApiModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiUrl">API 地址</label>
                    <input type="url" id="apiUrl" class="form-control" 
                           placeholder="https://api.openai.com/v1" 
                           value="https://api.openai.com/v1">
                </div>
                
                <div class="form-group">
                    <label for="apiKey">API 密钥</label>
                    <input type="password" id="apiKey" class="form-control" 
                           placeholder="请输入您的 API 密钥">
                </div>
                
                <div class="form-group">
                    <label>模型选择</label>
                    <div class="form-row">
                        <div class="form-group">
                            <button id="fetchModels" class="btn btn-secondary btn-small">
                                <span id="fetchBtnText">拉取模型列表</span>
                                <span id="fetchLoading" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <div class="model-picker">
                                <button type="button" id="modelPickerButton" class="model-picker-button" disabled>
                                    <span id="modelPickerText">请先拉取模型列表</span>
                                    <i class="fas fa-chevron-down caret"></i>
                                </button>
                                <div id="modelPickerList" class="model-picker-list" role="listbox"></div>
                            </div>
                            <select id="modelSelect" class="form-control" disabled style="display: none;">
                                <option value="">请先拉取模型列表</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="apiStatus" class="status-message"></div>
                
                <div class="form-actions">
                    <button id="testApi" class="btn btn-secondary">测试连接</button>
                    <button id="saveApi" class="btn btn-primary">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友列表弹窗 -->
    <div class="modal" id="friendListModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendListStatusSignal" class="fas fa-signal"></i>
                    <i id="friendListStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeFriendListModal" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: #f0d6d7;">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">好友列表</div>
                <button class="settings-back" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: #f0d6d7; width: 42px; text-align: center;" id="addFriendFromList">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="settings-scroll">
                <div id="friendList" class="friend-list" style="padding: 16px 20px;">
                    <!-- 好友列表将动态生成 -->
                </div>
                <div id="noFriends" class="no-friends">
                    <p style="color: #787785; text-align: center; padding: 30px;">暂无好友，点击右上角 + 添加好友</p>
                </div>
            </div>
            <div class="friend-list-nav">
                <div class="friend-list-nav-item active" data-nav="messages">
                    <i class="fas fa-comment"></i>
                    <span>消息</span>
                </div>
                <div class="friend-list-nav-item" data-nav="moments">
                    <i class="fas fa-circle"></i>
                    <span>动态</span>
                </div>
                <div class="friend-list-nav-item" data-nav="me">
                    <i class="fas fa-user-circle"></i>
                    <span>我</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友弹窗 -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加好友</h3>
                <button class="modal-close" id="closeAddFriendModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>头像</label>
                    <div id="avatarPreview" class="avatar-upload-preview">
                        <i class="fas fa-image"></i>
                        <p>点击选择头像</p>
                    </div>
                    <input type="file" id="avatarInput" class="form-control" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="friendName">昵称</label>
                    <input type="text" id="friendName" class="form-control" placeholder="输入好友昵称">
                </div>
                
                <div class="form-group">
                    <label for="friendPersona">人设</label>
                    <textarea id="friendPersona" class="form-control" placeholder="示例：温柔但有点毒舌的学姐，喜欢猫和甜食，遇事会先嘴硬后关心人。" rows="3" style="resize: vertical;" minlength="10" maxlength="1000"></textarea>
                    <div class="input-hint">必填，10-1000字，描述性格、背景或说话风格</div>
                </div>
                
                <div id="addFriendStatus" class="status-message"></div>
                
                <div class="form-actions">
                    <button id="cancelAddFriend" class="btn btn-secondary">取消</button>
                    <button id="confirmAddFriend" class="btn btn-primary">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天弹窗 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="chatStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="chatStatusSignal" class="fas fa-signal"></i>
                    <i id="chatStatusWifi" class="fas fa-wifi"></i>
                    <i id="chatStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- 导航栏 -->
            <div style="background-color: #FFFFFF; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f6f2f1; flex-shrink: 0;">
                <button id="backToFriendList" style="background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="chatTitle" style="margin: 0; color: #787785; font-size: 18px; font-weight: 700; flex: 1; text-align: center;">季燃</h3>
                <button id="heartVoiceBtn" style="background: none; border: none; font-size: 18px; color: #f0d6d7; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 18px;" aria-label="心声">
                    <i class="fas fa-heart"></i>
                </button>
                <button id="charSettingsBtn" style="background: none; border: none; font-size: 20px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div id="apiWarning" class="api-warning" style="display: none; background-color: #f6f2f1; border-bottom: 1px solid #debb7b; padding: 12px 20px; color: #debb7b; font-size: 13px; text-align: center;">
                ⚠️ 未配置API，请先进行API配置
            </div>
            
            <!-- 心声弹窗 -->
            <div id="heartVoicePopup" class="heart-voice-popup">
                <div id="heartVoiceText" class="heart-voice-text">正在探听心声...</div>
                <div id="heartVoiceStatus" class="heart-voice-status"></div>
                <div>
                    <div class="heart-voice-mood-bar"><div id="heartVoiceMoodFill" class="heart-voice-mood-fill"></div></div>
                    <div id="heartVoiceMoodLabel" class="heart-voice-mood-label">心情 0%</div>
                </div>
                <!-- 新增：历史记录入口 -->
                <div style="text-align: right; padding-top: 12px; border-top: 1px solid #f6f2f1;">
                    <button id="heartVoiceHistoryBtn" style="font-size: 12px; color: #debeeb; background: none; border: none; cursor: pointer; padding: 4px 0; font-weight: 500;">查看历史 <i class="fas fa-chevron-right" style="font-size: 10px; margin-left: 2px;"></i></button>
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="chat-messages" id="chatMessages" style="flex: 1; overflow-y: auto; border: none; padding: 15px 12px; background-color: #FFFFFF;">
                <div class="message ai">
                    你好！我是AI助手，请问有什么可以帮助你的吗？
                </div>
            </div>
            
            <!-- 输入框区域 -->
            <div style="background-color: #FFFFFF; border-top: 1px solid #f6f2f1; flex-shrink: 0;">
                <div id="chatInputAreaWrap" class="chat-input-area-wrap" style="padding: 8px 12px 10px;">
                    <div id="replyPreview" class="reply-preview">
                        <span id="replyPreviewText" class="reply-preview-text"></span>
                        <button id="replyPreviewClose" class="reply-preview-close" type="button">×</button>
                    </div>
                    <div id="imageUploadPill" class="image-upload-pill">
                        <img id="imageUploadThumb" class="image-upload-thumb" alt="图片预览" />
                        <span id="imageUploadName" class="image-upload-name">已选择图片</span>
                        <button id="imageUploadClose" class="image-upload-close" type="button">×</button>
                    </div>
                    <!-- 功能栏 -->
                    <div class="chat-function-row" style="display: flex; justify-content: space-around; padding: 8px 0;">
                        <button id="voiceInputBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-microphone"></i></button>
                        <button id="imageUploadBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image"></i></button>
                        <button id="cameraInputBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-camera"></i></button>
                        <button style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-laugh"></i></button>
                        <button id="chatPlusBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-plus-circle"></i></button>
                    </div>
                    
                    <div class="chat-input-row" style="display: flex; gap: 8px; margin-bottom: 6px; align-items: flex-end;">
                        <button id="triggerAiBtn" style="width: 38px; height: 38px; padding: 0; border-radius: 50%; flex-shrink: 0; background: #f6f2f1; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(120,119,133,0.05); display: flex; align-items: center; justify-content: center; color: #debeeb;" aria-label="呼唤AI">
                            <i class="fas fa-wand-magic-sparkles" style="font-size: 18px;"></i>
                        </button>
                        <textarea class="chat-input" id="chatInput" 
                                  placeholder="输入消息..." 
                                  rows="1"
                                  style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; resize: none; font-size: 14px;"></textarea>
                        <button class="chat-send-btn" id="sendMessage" style="width: 40px; height: 40px; padding: 0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="chatExtraPanel" class="chat-extra-panel" aria-hidden="true">
                        <div class="chat-extra-grid">
                            <button type="button" class="chat-extra-item" aria-label="总结">
                                <span class="chat-extra-icon"><i class="fas fa-clipboard-list"></i></span>
                                <span class="chat-extra-label">总结</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="红包">
                                <span class="chat-extra-icon"><i class="fas fa-gift"></i></span>
                                <span class="chat-extra-label">红包</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="转账">
                                <span class="chat-extra-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span class="chat-extra-label">转账</span>
                            </button>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                        </div>
                    </div>
                    <input id="imageInput" type="file" accept="image/*" style="display: none;" />
                    <div id="imageConfirmPopover" class="image-confirm-popover">
                        <span>发送图片？</span>
                        <div class="image-confirm-actions">
                            <button id="imageConfirmYes" class="image-confirm-btn yes" type="button">是</button>
                            <button id="imageConfirmNo" class="image-confirm-btn no" type="button">否</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="chatStatus" class="status-message" style="margin: 0; border-radius: 0;"></div>
        </div>
    </div>

    <!-- 消息长按操作菜单 -->
    <div id="messageActionOverlay" class="message-action-overlay">
        <div id="messageActionMenu" class="message-action-menu">
            <button class="message-action-item" id="messageActionCopy" type="button">
                <i class="fas fa-copy"></i>
                <span>复制</span>
            </button>
            <button class="message-action-item" id="messageActionDelete" type="button">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </button>
            <button class="message-action-item" id="messageActionRecall" type="button">
                <i class="fas fa-rotate-left"></i>
                <span>撤回</span>
            </button>
            <button class="message-action-item" id="messageActionReply" type="button">
                <i class="fas fa-reply"></i>
                <span>引用</span>
            </button>
        </div>
    </div>

    <!-- 语音输入模态框 -->
    <div class="modal" id="voiceModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeVoiceModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">语音输入</h3>
            
            <div style="margin-bottom: 20px;">
                <textarea id="voiceText" placeholder="输入或说出的文字..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="cancelVoiceInput" style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmVoiceInput" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片描述模态框 -->
    <div class="modal" id="cameraDescModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeCameraDescModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">图片描述</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="cameraDescText" placeholder="描述图片内容..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelCameraDesc" style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmCameraDesc" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片内容弹窗 -->
    <div class="modal" id="imageDescModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 320px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <button id="closeImageDescModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 12px 0; color: #787785; font-size: 16px; font-weight: 600;">图片内容</h3>

            <div style="margin-bottom: 18px;">
                <textarea id="imageDescText" class="image-desc-box" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div class="modal" id="confirmDeleteModal" style="z-index: 2001; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div style="background-color: white; border-radius: 30px; padding: 20px 25px; width: 75%; max-width: 240px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #787785; font-size: 15px; font-weight: 600;">确认删除？</h3>
            <p style="margin: 0 0 15px 0; color: #787785; font-size: 13px;">删除后将无法恢复</p>
            
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmDeleteYes" style="padding: 10px 25px; background-color: #d32f2f; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">是</button>
                <button id="confirmDeleteNo" style="padding: 10px 25px; background-color: white; color: #787785; border: 1px solid #f6f2f1; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">否</button>
            </div>
        </div>
    </div>

    <!-- 心声历史弹窗 -->
    <div class="modal" id="heartVoiceHistoryModal">
        <div class="modal-content" style="height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>心声历史</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="exportHeartVoiceHistoryBtn" style="background: none; border: none; color: #debeeb; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-image"></i> 导出
                    </button>
                    <button class="modal-close" id="closeHeartVoiceHistoryModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="heartVoiceHistoryList">
                    <!-- 历史记录将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 心声删除确认弹窗 -->
    <div class="modal" id="hvDeleteModal" style="z-index: 2200; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div style="background-color: white; border-radius: 24px; padding: 24px; width: 70%; max-width: 260px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); text-align: center; animation: fade-in-scale 0.2s ease-out;">
            <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px; font-weight: 600;">删除这条心声？</h3>
            <p style="margin: 0 0 20px 0; color: #999; font-size: 13px;">删除后无法找回哦</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="hvDeleteConfirm" style="flex: 1; padding: 10px 0; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">删除</button>
                <button id="hvDeleteCancel" style="flex: 1; padding: 10px 0; background-color: #f6f2f1; color: #787785; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">取消</button>
            </div>
        </div>
    </div>

    <!-- 好友设置弹窗 -->
    <div class="modal" id="charSettingsModal">
        <div class="modal-content friend-settings-screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendSettingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendSettingsStatusSignal" class="fas fa-signal"></i>
                    <i id="friendSettingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendSettingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="friend-settings-nav">
                <button id="charSettingsBack" class="friend-settings-back" aria-label="返回">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="friend-settings-title">好友设置</div>
                <span class="friend-settings-spacer"></span>
            </div>
            <div class="friend-settings-body">
                <div class="friend-avatar-wrap">
                    <div id="charAvatarDisplay" class="friend-avatar-display" aria-label="头像">
                        <i class="fas fa-user"></i>
                    </div>
                    <input type="file" id="charAvatarInput" accept="image/*" style="display: none;">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">好友昵称</div>
                    <input id="charNameInput" class="friend-settings-input" readonly>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">人设</div>
                    <textarea id="charPersonaInput" class="friend-settings-textarea" placeholder="描述性格、背景或说话风格"></textarea>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">世界书</div>
                    <details class="friend-settings-details">
                        <summary>点击展开选项列表</summary>
                        <div style="margin-top: 10px;">
                            <select id="worldBookSelect" class="friend-settings-select">
                                <option value="default">默认世界</option>
                                <option value="campus">校园日常</option>
                                <option value="idol">偶像练习生</option>
                                <option value="fantasy">奇幻冒险</option>
                                <option value="sci">科幻未来</option>
                            </select>
                        </div>
                    </details>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">对话界面展示</div>
                            <div class="friend-settings-desc">自定义聊天界面显示内容</div>
                        </div>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">对话时间</div>
                        <label class="ios-switch">
                            <input id="chatShowTimeToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">已读</div>
                        <label class="ios-switch">
                            <input id="chatReadToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">隐藏头像</div>
                        <label class="ios-switch">
                            <input id="chatHideAvatarToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">语音 ID</div>
                            <div class="friend-settings-desc">用于语音合成，未填写则自动</div>
                        </div>
                        <span id="voiceIdStatus" class="voice-status">未设置</span>
                    </div>
                    <input id="voiceIdInput" class="friend-settings-input" placeholder="输入语音ID">
                    <select id="voiceIdMode" class="friend-settings-select">
                        <option value="auto">自动选择</option>
                        <option value="fixed">固定使用此ID</option>
                        <option value="random">随机切换</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveCharSettingsBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">保存</button>
                    <button id="deleteCharBtn" style="flex: 1; padding: 12px; background-color: #f6f2f1; color: #d32f2f; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">删除好友</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书全屏页面 -->
    <div class="modal" id="worldbookModal" style="display:none;">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="worldbookStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="worldbookStatusSignal" class="fas fa-signal"></i>
                    <i id="worldbookStatusWifi" class="fas fa-wifi"></i>
                    <i id="worldbookStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="worldbookBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">世界书</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll" style="padding: 20px 16px;">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; text-align: center; padding: 40px 20px;">
                    <i class="fas fa-book-open" style="font-size: 56px; color: #debeeb; margin-bottom: 20px;"></i>
                    <p style="font-size: 18px; color: #787785; font-weight: 600; margin-bottom: 8px;">世界书功能页面</p>
                    <p style="font-size: 14px; color: #787785; opacity: 0.6;">后续可在此扩展新功能</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置全屏页面 -->
    <div class="modal" id="settingsModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="settingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="settingsStatusSignal" class="fas fa-signal"></i>
                    <i id="settingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="settingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="settingsBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">设置</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll">
                <div id="settingsApiCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">API设置</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="configStatus" class="settings-status">未配置</span>
                        <i class="fas fa-chevron-right settings-arrow"></i>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">隐藏状态栏</div>
                        <div class="settings-card-desc">隐藏所有页面顶部的状态栏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="hideStatusBarToggle">
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <div id="settingsDataCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">数据管理</div>
                        <div class="settings-card-desc">导入导出、备份与恢复</div>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像选择弹窗 -->
    <div class="modal" id="avatarPickerModal" style="z-index: 2105; display: none; background-color: rgba(0,0,0,0.35);">
        <div style="background-color: #FFFFFF; border-radius: 20px; width: 86%; max-width: 320px; padding: 18px; box-shadow: 0 14px 40px rgba(120,119,133,0.2);">
            <h3 style="margin: 0 0 12px 0; color: #787785; font-size: 16px; font-weight: 600; text-align: center;">更换头像</h3>
            <div id="charAvatarModalPreview" style="width: 74px; height: 74px; border-radius: 50%; background: #f6f2f1; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: #787785; font-size: 26px; background-size: cover; background-position: center;">
                <i class="fas fa-user"></i>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input id="charAvatarUrlModalInput" type="text" placeholder="粘贴头像图片URL" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;">
                <label style="display: block; width: 100%; padding: 10px 12px; border: 1px dashed #f0d6d7; border-radius: 12px; font-size: 14px; color: #f0d6d7; text-align: center; cursor: pointer;">
                    选择本地图片
                    <input id="charAvatarFileModalInput" type="file" accept="image/*" style="display: none;">
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button id="cancelAvatarPicker" style="flex: 1; padding: 10px; background: #f6f2f1; border: none; border-radius: 12px; cursor: pointer; color: #787785; font-weight: 600;">取消</button>
                <button id="confirmAvatarPicker" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 12px; cursor: pointer; color: #fff; font-weight: 600;">确定</button>
            </div>
        </div>
    </div>

    <!-- 数据管理二级菜单 -->
    <div class="modal" id="dataManageModal">
        <div class="modal-content" style="max-width: 360px; border-radius: 18px;">
            <div class="modal-header">
                <h3>数据管理</h3>
                <button class="modal-close" id="closeDataManageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="data-manage-list">
                    <button id="exportAllData" class="data-manage-item">导出全部数据</button>
                    <button id="importAllData" class="data-manage-item">导入数据（覆盖当前）</button>
                    <button id="exportFriendsData" class="data-manage-item">仅备份好友数据</button>
                    <button id="exportChatsData" class="data-manage-item">仅备份聊天记录</button>
                </div>
                <input type="file" id="importFileInput" accept="application/json" style="display: none;" />
            </div>
        </div>
    </div>

    <!-- 个人资料小组件编辑弹窗 -->
    <div id="profileWidgetModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="profileWidgetModalTitle" style="z-index: 3000;">
        <div id="profileWidgetModalContent" class="modal-content" style="max-width: 320px;">
            <div class="modal-header">
                <h3 id="profileWidgetModalTitle">编辑</h3>
                <button class="modal-close" id="closeProfileWidgetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="profileWidgetImageEditor" style="display: none;" class="space-y-4">
                    <img id="profileWidgetImagePreview" src="" alt="预览" class="w-full h-48 object-contain rounded-lg bg-gray-100 hidden" />
                    <div class="form-group">
                        <label for="profileWidgetImageUrlInput">图片链接</label>
                        <input id="profileWidgetImageUrlInput" type="text" class="form-control" placeholder="https://example.com/image.png" />
                    </div>
                    <div class="relative flex items-center" style="margin: 10px 0;">
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                        <span style="margin: 0 10px; color: #999; font-size: 12px;">或</span>
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                    </div>
                    <div class="form-group">
                        <input type="file" accept="image/*" id="profileWidgetFileInput" class="form-control" style="display: none;" aria-hidden="true" />
                        <button id="profileWidgetUploadButton" class="btn btn-secondary" style="width: 100%;">选择图片</button>
                    </div>
                </div>

                <div id="profileWidgetTextEditor" style="display: none;">
                    <input id="profileWidgetTextInput" type="text" class="form-control" />
                </div>

                <div id="profileWidgetTextareaEditor" style="display: none;">
                    <textarea id="profileWidgetTextareaInput" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-actions">
                    <button id="profileWidgetCancelButton" type="button" class="btn btn-secondary">取消</button>
                    <button id="profileWidgetSaveButton" type="button" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { appManager } from './app-manager.js';
        window.appManager = appManager;
    </script>

    <script>
(() => {
        let friendSystem;
        let apiService;
        let chatSession;
        let profileWidget;
        let heartVoiceSystem;

        // 可爱提示框函数
        function showCuteToast() {
            const cuteToast = document.getElementById('cuteToast');
            if (!cuteToast) return;
            
            cuteToast.style.display = 'block';
            setTimeout(() => {
                cuteToast.style.display = 'none';
            }, 2000);
        }

        // 重写 alert 函数
        window.alert = function(message) {
            showCuteToast();
        };

        // 基础功能
        const statusEl = document.getElementById('statusText');
        const statusTimeEl = document.getElementById('statusTime');
        const statusSignalEl = document.getElementById('statusSignal');
        const statusWifiEl = document.getElementById('statusWifi');
        const statusBatteryEl = document.getElementById('statusBattery');
        const chatStatusTime = document.getElementById('chatStatusTime');
        const chatStatusSignal = document.getElementById('chatStatusSignal');
        const chatStatusWifi = document.getElementById('chatStatusWifi');
        const chatStatusBattery = document.getElementById('chatStatusBattery');
        const friendSettingsStatusTime = document.getElementById('friendSettingsStatusTime');
        const friendSettingsStatusSignal = document.getElementById('friendSettingsStatusSignal');
        const friendSettingsStatusWifi = document.getElementById('friendSettingsStatusWifi');
        const friendSettingsStatusBattery = document.getElementById('friendSettingsStatusBattery');
        const worldbookStatusTime = document.getElementById('worldbookStatusTime');
        const settingsStatusTime = document.getElementById('settingsStatusTime');
        const friendListStatusTime = document.getElementById('friendListStatusTime');
        const apiStatusSignal = document.getElementById('apiStatusSignal');
        const apiStatusWifi = document.getElementById('apiStatusWifi');
        const apiStatusBattery = document.getElementById('apiStatusBattery');
        const greetingText = document.getElementById('greetingText');

        function setStatusIcon(el, iconClass) {
            if (!el || !iconClass) return;
            el.className = `fas ${iconClass}`;
        }

        function applyStatusBar(status) {
            if (!status) return;
            if (statusTimeEl && status.time) {
                statusTimeEl.textContent = status.time;
            }
            setStatusIcon(statusSignalEl, status.signal);
            setStatusIcon(statusWifiEl, status.wifi);
            setStatusIcon(statusBatteryEl, status.battery);

            // 更新聊天页状态栏图标
            setStatusIcon(chatStatusSignal, status.signal);
            setStatusIcon(chatStatusWifi, status.wifi);
            setStatusIcon(chatStatusBattery, status.battery);

            // 更新好友设置页状态栏图标
            setStatusIcon(friendSettingsStatusSignal, status.signal);
            setStatusIcon(friendSettingsStatusWifi, status.wifi);
            setStatusIcon(friendSettingsStatusBattery, status.battery);

            // 更新API配置页状态栏图标
            setStatusIcon(apiStatusSignal, status.signal);
            setStatusIcon(apiStatusWifi, status.wifi);
            setStatusIcon(apiStatusBattery, status.battery);
        }
        
        // 更新时间（北京时间实时更新）
        function updateTime() {
            // 获取北京时间（UTC+8）
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const h = String(beijingTime.getHours()).padStart(2, '0');
            const m = String(beijingTime.getMinutes()).padStart(2, '0');
            const timeStr = `${h}:${m}`;
            
            // 更新主页面时间
            if (statusTimeEl) {
                statusTimeEl.textContent = timeStr;
            }

            // 更新聊天页面时间
            if (chatStatusTime) {
                chatStatusTime.textContent = timeStr;
            }

            // 更新好友设置页面时间
            if (friendSettingsStatusTime) {
                friendSettingsStatusTime.textContent = timeStr;
            }

            // 更新世界书页面时间
            if (worldbookStatusTime) {
                worldbookStatusTime.textContent = timeStr;
            }

            // 更新设置页面时间
            if (settingsStatusTime) {
                settingsStatusTime.textContent = timeStr;
            }

            // 更新好友列表页面时间
            if (friendListStatusTime) {
                friendListStatusTime.textContent = timeStr;
            }

            // 更新API配置页面时间
            const apiStatusTime = document.getElementById('apiStatusTime');
            if (apiStatusTime) {
                apiStatusTime.textContent = timeStr;
            }

            if (window.appManager && typeof window.appManager.setStatus === 'function') {
                window.appManager.setStatus({ time: timeStr });
            }
        }
        updateTime();
        if (window.appManager && typeof window.appManager.on === 'function') {
            window.appManager.on('status-change', applyStatusBar);
            if (typeof window.appManager.getStatus === 'function') {
                applyStatusBar(window.appManager.getStatus());
            }
        }
        setInterval(updateTime, 1000);
        
        // 状态提示
        function announce(name) {
            if (!statusEl) return;
            const original = statusEl.textContent;
            statusEl.textContent = `打开了 ${name}`;
            setTimeout(() => {
                statusEl.textContent = original;
            }, 900);
        }

        function launchApp(appId) {
            if (!window.appManager || typeof window.appManager.launch !== 'function') return;
            try {
                window.appManager.launch(appId);
            } catch (e) {
                console.warn('APP 启动失败:', e);
            }
        }

        function loadGreetingText() {
            const fallback = '小小世界，开心至上';
            const saved = friendSystem
                ? friendSystem.getStorage('homeGreeting', fallback)
                : fallback;
            if (greetingText) {
                greetingText.textContent = (saved || fallback).trim();
            }
        }

        function enableGreetingEdit() {
            if (!greetingText) return;
            greetingText.setAttribute('contenteditable', 'true');
            greetingText.focus();
            const selection = window.getSelection();
            if (selection && greetingText.firstChild) {
                const range = document.createRange();
                range.selectNodeContents(greetingText);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function saveGreetingText() {
            if (!greetingText) return;
            const text = greetingText.textContent.trim() || '小小世界，开心至上';
            greetingText.textContent = text;
            greetingText.removeAttribute('contenteditable');
            if (friendSystem) {
                friendSystem.setStorage('homeGreeting', text);
            } else {
                localStorage.setItem('homeGreeting', JSON.stringify(text));
            }
        }
        
        // ========== 获取DOM元素 ==========
        
        // 图标元素
        const phoneIcon = document.getElementById('phoneIcon');
        const novelIcon = document.getElementById('novelIcon');
        const forumIcon = document.getElementById('forumIcon');
        const appGrid = document.getElementById('appGrid');
        
        // 模态窗口元素
        const apiModal = document.getElementById('apiModal');
        const chatModal = document.getElementById('chatModal');
        const settingsModal = document.getElementById('settingsModal');
        const friendListModal = document.getElementById('friendListModal');
        const addFriendModal = document.getElementById('addFriendModal');
        
        // API配置相关元素
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const fetchModelsBtn = document.getElementById('fetchModels');
        const fetchBtnText = document.getElementById('fetchBtnText');
        const fetchLoading = document.getElementById('fetchLoading');
        const modelSelect = document.getElementById('modelSelect');
        const modelPickerButton = document.getElementById('modelPickerButton');
        const modelPickerText = document.getElementById('modelPickerText');
        const modelPickerList = document.getElementById('modelPickerList');
        const testApiBtn = document.getElementById('testApi');
        const saveApiBtn = document.getElementById('saveApi');
        const apiStatus = document.getElementById('apiStatus');
        
        // 设置显示元素
        const currentApiUrlDisplay = document.getElementById('currentApiUrlDisplay');
        const currentModelDisplay = document.getElementById('currentModelDisplay');
        const configStatus = document.getElementById('configStatus');
        
        // 好友列表相关元素
        const friendListElement = document.getElementById('friendList');
        const noFriends = document.getElementById('noFriends');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarInput = document.getElementById('avatarInput');
        const friendName = document.getElementById('friendName');
        const friendPersona = document.getElementById('friendPersona');
        const confirmAddFriend = document.getElementById('confirmAddFriend');
        const cancelAddFriend = document.getElementById('cancelAddFriend');
        const addFriendStatus = document.getElementById('addFriendStatus');
        const closeFriendListModal = document.getElementById('closeFriendListModal');
        const closeAddFriendModal = document.getElementById('closeAddFriendModal');
        
        // 聊天相关元素
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessage');
        const chatMessages = document.getElementById('chatMessages');
        const chatStatus = document.getElementById('chatStatus');
        const chatTitle = document.getElementById('chatTitle');

        const replyPreview = document.getElementById('replyPreview');
        const replyPreviewText = document.getElementById('replyPreviewText');
        const replyPreviewClose = document.getElementById('replyPreviewClose');

        const imageUploadPill = document.getElementById('imageUploadPill');
        const imageUploadThumb = document.getElementById('imageUploadThumb');
        const imageUploadName = document.getElementById('imageUploadName');
        const imageUploadClose = document.getElementById('imageUploadClose');
        const imageUploadBtn = document.getElementById('imageUploadBtn');
        const imageInput = document.getElementById('imageInput');
        const imageConfirmPopover = document.getElementById('imageConfirmPopover');
        const imageConfirmYes = document.getElementById('imageConfirmYes');
        const imageConfirmNo = document.getElementById('imageConfirmNo');
        const chatPlusBtn = document.getElementById('chatPlusBtn');
        const chatExtraPanel = document.getElementById('chatExtraPanel');
        const chatInputAreaWrap = document.getElementById('chatInputAreaWrap');
        const chatInputRow = document.querySelector('.chat-input-row');

        const messageActionOverlay = document.getElementById('messageActionOverlay');
        const messageActionMenu = document.getElementById('messageActionMenu');
        const messageActionCopy = document.getElementById('messageActionCopy');
        const messageActionDelete = document.getElementById('messageActionDelete');
        const messageActionRecall = document.getElementById('messageActionRecall');
        const messageActionReply = document.getElementById('messageActionReply');
        
        const triggerAiBtn = document.getElementById('triggerAiBtn');
        // 关闭按钮
        const closeApiModal = document.getElementById('closeApiModal');
        const backToFriendList = document.getElementById('backToFriendList');
        const closeSettingsModal = document.getElementById('settingsBack');
        const openApiConfig = document.getElementById('openApiConfig');
        const settingsApiCard = document.getElementById('settingsApiCard');
        const settingsDataCard = document.getElementById('settingsDataCard');
        const dataManageModal = document.getElementById('dataManageModal');
        const closeDataManageModal = document.getElementById('closeDataManageModal');
        const exportAllDataBtn = document.getElementById('exportAllData');
        const importAllDataBtn = document.getElementById('importAllData');
        const exportFriendsDataBtn = document.getElementById('exportFriendsData');
        const exportChatsDataBtn = document.getElementById('exportChatsData');
        const importFileInput = document.getElementById('importFileInput');

        // 个人资料小组件（新）
        class ProfileWidget {
            constructor() {
                this.storageKey = 'profileWidgetV2Data';
                this.data = {
                    avatarImage: '',
                    bodyImage: '',
                    bottomImage: '',
                    name: 'FirstSnow_',
                    handle: '@Sovow1212',
                    status: '会在初雪日再次相遇(*^. ^*)',
                    location: 'Seoul'
                };
                this.currentField = null;
                this.tempValue = '';
                this.els = {
                    widget: document.getElementById('profileWidgetV2'),
                    cover: document.getElementById('profileWidgetCover'),
                    bottom: document.getElementById('profileWidgetBottom'),
                    avatarImage: document.getElementById('profileAvatarImage'),
                    avatarImagePlaceholder: document.getElementById('profileAvatarImagePlaceholder'),
                    name: document.getElementById('profileName'),
                    handle: document.getElementById('profileHandle'),
                    status: document.getElementById('profileStatus'),
                    location: document.getElementById('profileLocation'),
                    modal: document.getElementById('profileWidgetModal'),
                    modalContent: document.getElementById('profileWidgetModalContent'),
                    modalTitle: document.getElementById('profileWidgetModalTitle'),
                    imageEditor: document.getElementById('profileWidgetImageEditor'),
                    textEditor: document.getElementById('profileWidgetTextEditor'),
                    textareaEditor: document.getElementById('profileWidgetTextareaEditor'),
                    imagePreview: document.getElementById('profileWidgetImagePreview'),
                    imageUrlInput: document.getElementById('profileWidgetImageUrlInput'),
                    textInput: document.getElementById('profileWidgetTextInput'),
                    textareaInput: document.getElementById('profileWidgetTextareaInput'),
                    fileInput: document.getElementById('profileWidgetFileInput'),
                    saveButton: document.getElementById('profileWidgetSaveButton'),
                    cancelButton: document.getElementById('profileWidgetCancelButton'),
                    uploadButton: document.getElementById('profileWidgetUploadButton'),
                    closeButton: document.getElementById('closeProfileWidgetModal')
                };
            }

            load() {
                try {
                    const saved = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
                    Object.assign(this.data, saved || {});
                } catch (e) {
                    // ignore
                }
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            }

            updateUI() {
                Object.keys(this.data).forEach((key) => {
                    const el = this.els[key];
                    if (key === 'bodyImage') {
                        if (this.els.cover) {
                            if (this.data.bodyImage) {
                                this.els.cover.style.backgroundImage = `url('${this.data.bodyImage}')`;
                            } else {
                                this.els.cover.style.backgroundImage = '';
                            }
                        }
                        return;
                    }
                    if (key === 'bottomImage') {
                        if (this.els.bottom) {
                            if (this.data.bottomImage) {
                                this.els.bottom.style.backgroundImage = `url('${this.data.bottomImage}')`;
                            } else {
                                this.els.bottom.style.backgroundImage = '';
                            }
                        }
                        return;
                    }
                    if (!el) return;
                    if (key === 'avatarImage') {
                        const placeholder = this.els[key + 'Placeholder'];
                        if (this.data[key]) {
                            el.src = this.data[key];
                            el.classList.remove('hidden');
                            if (placeholder) placeholder.classList.add('hidden');
                        } else {
                            el.classList.add('hidden');
                            if (placeholder) placeholder.classList.remove('hidden');
                        }
                    } else {
                        if (key === 'handle') {
                            el.textContent = this.data.handle.startsWith('@')
                                ? this.data.handle
                                : `@${this.data.handle}`;
                        } else {
                            el.textContent = this.data[key];
                        }
                    }
                });
            }

            openModal(field, type, label) {
                this.currentField = field;
                this.tempValue = this.data[field] || '';
                if (this.els.modalTitle) {
                    this.els.modalTitle.textContent = `编辑${label}`;
                }

                if (this.els.imageEditor) this.els.imageEditor.style.display = 'none';
                if (this.els.textEditor) this.els.textEditor.style.display = 'none';
                if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'none';

                if (type === 'image') {
                    if (this.els.imageEditor) this.els.imageEditor.style.display = 'block';
                    if (this.els.imageUrlInput) {
                        this.els.imageUrlInput.value = this.tempValue.startsWith('data:') ? '' : this.tempValue;
                    }
                    if (this.els.imagePreview) {
                        this.els.imagePreview.src = this.tempValue;
                        this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                    }
                } else if (type === 'text') {
                    if (this.els.textEditor) this.els.textEditor.style.display = 'block';
                    if (this.els.textInput) this.els.textInput.value = this.tempValue;
                } else if (type === 'textarea') {
                    if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'block';
                    if (this.els.textareaInput) this.els.textareaInput.value = this.tempValue;
                }

                if (this.els.modal) this.els.modal.style.display = 'flex';
                if (this.els.modalContent) this.els.modalContent.classList.add('animate-fade-in-scale');
            }

            closeModal() {
                if (this.els.modalContent) this.els.modalContent.classList.remove('animate-fade-in-scale');
                if (this.els.modal) this.els.modal.style.display = 'none';
                this.currentField = null;
                this.tempValue = '';
                if (this.els.fileInput) this.els.fileInput.value = '';
            }

            saveChanges() {
                if (this.currentField) {
                    this.data[this.currentField] = this.tempValue;
                    this.save();
                    this.updateUI();
                }
                this.closeModal();
            }

            bindEvents() {
                const editProfileAvatarImage = document.getElementById('editProfileAvatarImage');
                if (editProfileAvatarImage) {
                    editProfileAvatarImage.addEventListener('click', () => this.openModal('avatarImage', 'image', '头像图片'));
                }

                const setupInlineEdit = (key) => {
                    const el = this.els[key];
                    if (!el) return;
                    
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            el.blur();
                        }
                    });

                    el.addEventListener('blur', () => {
                        let val = el.textContent.trim();
                        if (key === 'handle' && val && !val.startsWith('@')) {
                            val = '@' + val;
                        }
                        this.data[key] = val;
                        this.save();
                        this.updateUI();
                    });
                };

                ['name', 'handle', 'status', 'location'].forEach(key => setupInlineEdit(key));

                if (this.els.cover) {
                    this.els.cover.addEventListener('click', (event) => {
                        if (event.target.closest('[data-no-bg-change]')) return;
                        this.openModal('bodyImage', 'image', '背景图片');
                    });
                }

                if (this.els.bottom) {
                    this.els.bottom.addEventListener('click', (event) => {
                        if (event.target.closest('[data-no-bg-change]')) return;
                        this.openModal('bottomImage', 'image', '底部背景');
                    });
                }

                if (this.els.saveButton) {
                    this.els.saveButton.addEventListener('click', () => this.saveChanges());
                }
                if (this.els.cancelButton) {
                    this.els.cancelButton.addEventListener('click', () => this.closeModal());
                }
                if (this.els.closeButton) {
                    this.els.closeButton.addEventListener('click', () => this.closeModal());
                }
                if (this.els.modal) {
                    this.els.modal.addEventListener('click', (e) => {
                        if (e.target === this.els.modal) this.closeModal();
                    });
                }

                if (this.els.imageUrlInput) {
                    this.els.imageUrlInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                        if (this.els.imagePreview) {
                            this.els.imagePreview.src = this.tempValue;
                            this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                        }
                    });
                }
                if (this.els.textInput) {
                    this.els.textInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                    });
                }
                if (this.els.textareaInput) {
                    this.els.textareaInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                    });
                }

                if (this.els.uploadButton && this.els.fileInput) {
                    this.els.uploadButton.addEventListener('click', () => this.els.fileInput.click());
                    this.els.fileInput.addEventListener('change', async (event) => {
                        const file = event.target.files && event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = () => {
                            this.tempValue = String(reader.result || '');
                            if (this.els.imageUrlInput) this.els.imageUrlInput.value = '';
                            if (this.els.imagePreview) {
                                this.els.imagePreview.src = this.tempValue;
                                this.els.imagePreview.classList.remove('hidden');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }

            init() {
                this.load();
                this.updateUI();
                this.bindEvents();
            }
        }
        
        // ========== APP入口清单（集中管理） ==========
        const APP_ENTRY_POINTS = {
            home: ['message', 'feixin', 'worldbook', 'settings', 'phone', 'forum'],
            dock: ['phone', 'novel', 'forum']
        };

        function openAppWithNotice(appId, name, notice) {
            launchApp(appId);
            announce(name);
            if (notice) alert(notice);
        }

        const APP_HANDLERS = {
            message: () => openAppWithNotice('message', '消息', '消息功能开发中...'),
            feixin: () => {
                launchApp('feixin');
                announce('甜聊');
                friendListModal.style.display = 'flex';
                renderFriendList();
            },
            worldbook: () => {
                launchApp('worldbook');
                announce('世界书');
                const worldbookModal = document.getElementById('worldbookModal');
                if (worldbookModal) {
                    worldbookModal.style.display = 'flex';
                }
            },
            settings: () => {
                launchApp('settings');
                announce('设置');
                settingsModal.style.display = 'flex';
                if (apiService) apiService.updateSettingsDisplay();
            },
            beautify: () => openAppWithNotice('beautify', '美化', '美化功能开发中...'),
            phone: () => openAppWithNotice('phone', '手机', '手机功能开发中...'),
            novel: () => openAppWithNotice('novel', '小说', '小说功能开发中...'),
            forum: () => openAppWithNotice('forum', '论坛', '论坛功能开发中...')
        };

        // ========== 图标点击事件 ==========
        function handleAppClick(appId) {
            const handler = APP_HANDLERS[appId];
            if (handler) {
                handler();
                return;
            }
            launchApp(appId);
            announce('应用');
            alert('功能开发中...');
        }
        
        // Dock栏图标
        if (phoneIcon) {
            phoneIcon.addEventListener('click', () => handleAppClick('phone'));
        }
        
        if (novelIcon) {
            novelIcon.addEventListener('click', () => handleAppClick('novel'));
        }
        
        if (forumIcon) {
            forumIcon.addEventListener('click', () => handleAppClick('forum'));
        }
        
        // ========== 模态窗口控制 ==========
        
        closeApiModal.addEventListener('click', () => {
            apiModal.style.display = 'none';
            apiStatus.style.display = 'none';
            settingsModal.style.display = 'flex';
        });
        
        backToFriendList.addEventListener('click', () => {
            chatModal.style.display = 'none';
            chatStatus.style.display = 'none';
            if (heartVoiceSystem) heartVoiceSystem.closePopup();
            friendListModal.style.display = 'flex';
            renderFriendList();
        });
        
        closeSettingsModal.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // 世界书返回按钮
        const worldbookBackBtn = document.getElementById('worldbookBack');
        if (worldbookBackBtn) {
            worldbookBackBtn.addEventListener('click', () => {
                const wbModal = document.getElementById('worldbookModal');
                if (wbModal) wbModal.style.display = 'none';
            });
        }

        if (settingsApiCard) {
            settingsApiCard.addEventListener('click', () => {
                settingsModal.style.display = 'none';
                apiModal.style.display = 'flex';

                if (!apiService) return;
                const config = apiService.getConfig();
                if (config.apiUrl) {
                    apiUrlInput.value = config.apiUrl;
                }
                if (config.apiKey) {
                    apiKeyInput.value = config.apiKey;
                }
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            });
        }

        if (settingsDataCard) {
            settingsDataCard.addEventListener('click', () => {
                dataManageModal.style.display = 'flex';
            });
        }

        if (closeDataManageModal) {
            closeDataManageModal.addEventListener('click', () => {
                dataManageModal.style.display = 'none';
            });
        }
        
        closeFriendListModal.addEventListener('click', () => {
            friendListModal.style.display = 'none';
        });

        // 好友列表导航栏事件处理
        const navItems = document.querySelectorAll('.friend-list-nav-item');
        if (navItems.length > 0) {
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const navType = item.dataset.nav;
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    if (navType === 'messages') {
                        // 当前已是消息列表，无需做额外处理
                        console.log('显示消息列表');
                    } else if (navType === 'moments') {
                        alert('动态功能开发中...');
                    } else if (navType === 'me') {
                        alert('个人页面开发中...');
                    }
                });
            });
        }

        // 好友列表中的添加好友按钮
        const addFriendFromList = document.getElementById('addFriendFromList');
        if (addFriendFromList) {
            addFriendFromList.addEventListener('click', () => {
                addFriendModal.style.display = 'flex';
                resetAddFriendForm();
            });
        }
        
        closeAddFriendModal.addEventListener('click', () => {
            addFriendModal.style.display = 'none';
            resetAddFriendForm();
        });

        // 个人资料小组件交互（新）由 ProfileWidget 统一管理
        
        // 好友设置相关
        const charSettingsModal = document.getElementById('charSettingsModal');
        const charSettingsBtn = document.getElementById('charSettingsBtn');
        const charSettingsBack = document.getElementById('charSettingsBack');
        const charNameInput = document.getElementById('charNameInput');
        const charPersonaInput = document.getElementById('charPersonaInput');
        const charAvatarDisplay = document.getElementById('charAvatarDisplay');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const charAvatarInput = document.getElementById('charAvatarInput');
        const worldBookSelect = document.getElementById('worldBookSelect');
        const voiceIdInput = document.getElementById('voiceIdInput');
        const voiceIdMode = document.getElementById('voiceIdMode');
        const voiceIdStatus = document.getElementById('voiceIdStatus');
        const chatShowTimeToggle = document.getElementById('chatShowTimeToggle');
        const chatReadToggle = document.getElementById('chatReadToggle');
        const chatHideAvatarToggle = document.getElementById('chatHideAvatarToggle');
        const avatarPickerModal = document.getElementById('avatarPickerModal');
        const charAvatarUrlModalInput = document.getElementById('charAvatarUrlModalInput');
        const charAvatarFileModalInput = document.getElementById('charAvatarFileModalInput');
        const charAvatarModalPreview = document.getElementById('charAvatarModalPreview');
        const cancelAvatarPicker = document.getElementById('cancelAvatarPicker');
        const confirmAvatarPicker = document.getElementById('confirmAvatarPicker');
        const saveCharSettingsBtn = document.getElementById('saveCharSettingsBtn');
        const deleteCharBtn = document.getElementById('deleteCharBtn');
        let pendingCharAvatar = '';
        let modalAvatarTemp = '';

        function updateVoiceStatus(value) {
            if (!voiceIdStatus) return;
            const hasValue = !!value;
            voiceIdStatus.textContent = hasValue ? '已设置' : '未设置';
        }

        function setCharAvatarDisplay(avatarUrl) {
            if (!charAvatarDisplay) return;
            if (avatarUrl) {
                charAvatarDisplay.style.backgroundImage = `url('${avatarUrl}')`;
                charAvatarDisplay.classList.add('has-image');
            } else {
                charAvatarDisplay.style.backgroundImage = '';
                charAvatarDisplay.classList.remove('has-image');
            }
        }

        function setAvatarModalPreview(avatarUrl) {
            if (!charAvatarModalPreview) return;
            if (avatarUrl) {
                charAvatarModalPreview.style.backgroundImage = `url('${avatarUrl}')`;
                charAvatarModalPreview.innerHTML = '';
            } else {
                charAvatarModalPreview.style.backgroundImage = '';
                charAvatarModalPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // 打开好友设置
        charSettingsBtn.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            if (currentFriendId && friendSystem) {
                const friend = friendSystem.getFriendById(currentFriendId);
                
                if (friend) {
                    charNameInput.value = friend.name;
                    charPersonaInput.value = friend.persona || '';
                    pendingCharAvatar = friend.avatar || '';
                    setCharAvatarDisplay(pendingCharAvatar);
                    if (worldBookSelect) {
                        worldBookSelect.value = friend.worldBook || 'default';
                    }
                    if (voiceIdInput) {
                        voiceIdInput.value = friend.voiceId || '';
                        updateVoiceStatus(voiceIdInput.value.trim());
                    }
                    if (voiceIdMode) {
                        voiceIdMode.value = friend.voiceIdMode || 'auto';
                    }
                    if (chatShowTimeToggle) {
                        chatShowTimeToggle.checked = friend.chatShowTime ?? true;
                    }
                    if (chatReadToggle) {
                        chatReadToggle.checked = friend.chatReadStatus ?? true;
                    }
                    if (chatHideAvatarToggle) {
                        chatHideAvatarToggle.checked = friend.chatHideAvatar ?? false;
                    }
                    if (charAvatarInput) {
                        charAvatarInput.value = '';
                    }
                    modalAvatarTemp = pendingCharAvatar || '';
                    charSettingsModal.style.display = 'flex';
                }
            }
        });
        
        // 关闭好友设置
        if (charSettingsBack) {
            charSettingsBack.addEventListener('click', () => {
                charSettingsModal.style.display = 'none';
            });
        }
        
        // 点击背景关闭
        charSettingsModal.addEventListener('click', (e) => {
            if (e.target === charSettingsModal) {
                charSettingsModal.style.display = 'none';
            }
        });
        
        // 更换头像
        function openAvatarPicker() {
            if (!avatarPickerModal) return;
            modalAvatarTemp = pendingCharAvatar || '';
            if (charAvatarUrlModalInput) {
                charAvatarUrlModalInput.value = modalAvatarTemp && !modalAvatarTemp.startsWith('data:') ? modalAvatarTemp : '';
            }
            if (charAvatarFileModalInput) {
                charAvatarFileModalInput.value = '';
            }
            setAvatarModalPreview(modalAvatarTemp);
            avatarPickerModal.style.display = 'flex';
        }

        if (charAvatarDisplay) {
            charAvatarDisplay.addEventListener('click', openAvatarPicker);
        }

        if (charAvatarUrlModalInput) {
            charAvatarUrlModalInput.addEventListener('input', (e) => {
                const url = e.target.value.trim();
                modalAvatarTemp = url;
                setAvatarModalPreview(url);
            });
        }

        if (voiceIdInput) {
            voiceIdInput.addEventListener('input', (e) => {
                updateVoiceStatus(e.target.value.trim());
            });
        }

        if (charAvatarFileModalInput) {
            charAvatarFileModalInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    modalAvatarTemp = imageUrl;
                    setAvatarModalPreview(imageUrl);
                    if (charAvatarUrlModalInput) {
                        charAvatarUrlModalInput.value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        if (cancelAvatarPicker && avatarPickerModal) {
            cancelAvatarPicker.addEventListener('click', () => {
                avatarPickerModal.style.display = 'none';
            });
        }

        if (confirmAvatarPicker && avatarPickerModal) {
            confirmAvatarPicker.addEventListener('click', () => {
                const urlValue = charAvatarUrlModalInput ? charAvatarUrlModalInput.value.trim() : '';
                pendingCharAvatar = urlValue || modalAvatarTemp || '';
                setCharAvatarDisplay(pendingCharAvatar);
                avatarPickerModal.style.display = 'none';
            });
        }

        if (avatarPickerModal) {
            avatarPickerModal.addEventListener('click', (e) => {
                if (e.target === avatarPickerModal) {
                    avatarPickerModal.style.display = 'none';
                }
            });
        }
        
        // 保存好友设置
        saveCharSettingsBtn.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            const updated = friendSystem ? friendSystem.updateFriend(currentFriendId, {
                persona: charPersonaInput.value.trim(),
                avatar: pendingCharAvatar || null,
                worldBook: worldBookSelect ? worldBookSelect.value : 'default',
                voiceId: voiceIdInput ? voiceIdInput.value.trim() : '',
                voiceIdMode: voiceIdMode ? voiceIdMode.value : 'auto',
                chatShowTime: chatShowTimeToggle ? chatShowTimeToggle.checked : true,
                chatReadStatus: chatReadToggle ? chatReadToggle.checked : true,
                chatHideAvatar: chatHideAvatarToggle ? chatHideAvatarToggle.checked : false
            }) : null;
            if (updated) {
                // 注意：name 是只读的，不允许修改
                charSettingsModal.style.display = 'none';
                if (chatSession) chatSession.showChatStatus('好友设置已保存', 'success');
            }
        });
        
        // 删除好友
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteYes = document.getElementById('confirmDeleteYes');
        const confirmDeleteNo = document.getElementById('confirmDeleteNo');
        
        deleteCharBtn.addEventListener('click', () => {
            confirmDeleteModal.style.display = 'flex';
        });
        
        confirmDeleteYes.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            const removed = friendSystem ? friendSystem.deleteFriend(currentFriendId) : null;
            
            if (removed) {
                
                // 删除好友的聊天历史
                localStorage.removeItem(`chat_${currentFriendId}`);
                
                confirmDeleteModal.style.display = 'none';
                charSettingsModal.style.display = 'none';
                chatModal.style.display = 'none';
                if (chatSession) chatSession.setCurrentFriendId(null);
                friendListModal.style.display = 'flex';
                renderFriendList();
            }
        });
        
        confirmDeleteNo.addEventListener('click', () => {
            confirmDeleteModal.style.display = 'none';
        });
        
        if (openApiConfig) {
            openApiConfig.addEventListener('click', () => {
                settingsModal.style.display = 'none';
                apiModal.style.display = 'flex';

                if (!apiService) return;
                const config = apiService.getConfig();
                if (config.apiUrl) {
                    apiUrlInput.value = config.apiUrl;
                }
                if (config.apiKey) {
                    apiKeyInput.value = config.apiKey;
                }
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            });
        }

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        function collectOtherSettings() {
            const otherSettings = {};
            const reservedPrefixes = ['chat_'];
            const reservedKeys = new Set([
                'apiConfig',
                'friends',
                'profileWidgetV2Data',
                'homeGreeting'
            ]);
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;
                if (reservedKeys.has(key)) continue;
                if (reservedPrefixes.some(prefix => key.startsWith(prefix))) continue;
                try {
                    otherSettings[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    otherSettings[key] = localStorage.getItem(key);
                }
            }
            return otherSettings;
        }

        function collectChatHistories(friendsList = []) {
            const chatHistories = {};
            friendsList.forEach(friend => {
                if (!friend || !friend.id) return;
                chatHistories[friend.id] = friendSystem
                    ? friendSystem.getFriendChatHistory(friend.id)
                    : [];
            });
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || !key.startsWith('chat_')) continue;
                const friendId = key.replace('chat_', '');
                if (!chatHistories[friendId]) {
                    try {
                        chatHistories[friendId] = JSON.parse(localStorage.getItem(key)) || [];
                    } catch (e) {
                        chatHistories[friendId] = [];
                    }
                }
            }
            return chatHistories;
        }

        function buildExportPayload(customData = {}) {
            return {
                exportVersion: '1.0',
                exportTime: new Date().toISOString(),
                data: customData
            };
        }

        function exportAllData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                apiConfig: apiService ? apiService.getConfig() : {},
                friends: friends,
                chatHistories: collectChatHistories(friends),
                profileWidget: friendSystem ? friendSystem.getStorage('profileWidgetV2Data', {}) : {},
                homeGreeting: friendSystem ? friendSystem.getStorage('homeGreeting', '') : '',
                otherSettings: collectOtherSettings()
            });
            downloadJson(payload, `app_backup_all_${Date.now()}.json`);
        }

        function exportFriendsData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                friends: friends
            });
            downloadJson(payload, `app_backup_friends_${Date.now()}.json`);
        }

        function exportChatsData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                chatHistories: collectChatHistories(friends)
            });
            downloadJson(payload, `app_backup_chats_${Date.now()}.json`);
        }

        function applyImportPayload(payload) {
            if (!payload || !payload.data || typeof payload.data !== 'object') {
                throw new Error('数据格式不正确');
            }

            const data = payload.data;
            localStorage.clear();

            if (data.apiConfig) {
                localStorage.setItem('apiConfig', JSON.stringify(data.apiConfig));
            }
            if (data.friends) {
                localStorage.setItem('friends', JSON.stringify(data.friends));
            }
            if (data.profileWidget) {
                localStorage.setItem('profileWidgetV2Data', JSON.stringify(data.profileWidget));
            }
            if (data.homeGreeting !== undefined) {
                localStorage.setItem('homeGreeting', JSON.stringify(data.homeGreeting));
            }
            if (data.chatHistories && typeof data.chatHistories === 'object') {
                Object.keys(data.chatHistories).forEach(friendId => {
                    localStorage.setItem(`chat_${friendId}`, JSON.stringify(data.chatHistories[friendId] || []));
                });
            }
            if (data.otherSettings && typeof data.otherSettings === 'object') {
                Object.keys(data.otherSettings).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(data.otherSettings[key]));
                });
            }

            if (friendSystem) friendSystem.init();
            if (apiService) apiService.updateSettingsDisplay();
            if (profileWidget) {
                profileWidget.load();
                profileWidget.updateUI();
            }
            renderFriendList();
            loadGreetingText();
        }

        function handleImportFile(file) {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const payload = JSON.parse(String(reader.result || '{}'));
                    const confirmImport = confirm('导入将覆盖当前所有数据，是否继续？');
                    if (!confirmImport) return;
                    applyImportPayload(payload);
                    alert('导入完成');
                } catch (e) {
                    alert('导入失败：JSON 格式不正确');
                }
            };
            reader.readAsText(file);
        }

        if (exportAllDataBtn) {
            exportAllDataBtn.addEventListener('click', exportAllData);
        }
        if (exportFriendsDataBtn) {
            exportFriendsDataBtn.addEventListener('click', exportFriendsData);
        }
        if (exportChatsDataBtn) {
            exportChatsDataBtn.addEventListener('click', exportChatsData);
        }
        if (importAllDataBtn && importFileInput) {
            importAllDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) {
                    handleImportFile(file);
                }
                importFileInput.value = '';
            });
        }
        
        // 点击模态窗口外部关闭
        window.addEventListener('click', (e) => {
            if (e.target === apiModal) {
                apiModal.style.display = 'none';
                apiStatus.style.display = 'none';
                settingsModal.style.display = 'flex';
            }
            if (e.target === chatModal) {
                chatModal.style.display = 'none';
                chatStatus.style.display = 'none';
            }
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (e.target === friendListModal) {
                friendListModal.style.display = 'none';
            }
            if (e.target === addFriendModal) {
                addFriendModal.style.display = 'none';
                resetAddFriendForm();
            }
            if (e.target === dataManageModal) {
                dataManageModal.style.display = 'none';
            }
        });
        
        // ========== 好友管理功能 ==========
        class FriendSystem {
            constructor() {
                this.cache = new Map();
                this.lastSnapshot = '';
                this.syncTimer = null;
                this.CHECK_INTERVAL = 5000;
                this.listeners = new Set();
            }

            parsePersonaText(text) {
                const raw = (text || '').trim();
                if (!raw) {
                    return {
                        raw: '',
                        summary: '',
                        keywords: [],
                        likes: [],
                        dislikes: []
                    };
                }

                const sentences = raw.split(/[。！？\n]+/).map(s => s.trim()).filter(Boolean);
                const summary = sentences[0] || raw;

                const keywords = Array.from(new Set((raw.match(/[\u4e00-\u9fa5]{2,}/g) || []).slice(0, 20)));
                const likes = [];
                const dislikes = [];

                const likeMatches = raw.match(/喜欢([^，。！？\n]+)/g) || [];
                likeMatches.forEach(m => {
                    const item = m.replace('喜欢', '').trim();
                    if (item) likes.push(item);
                });
                const dislikeMatches = raw.match(/(讨厌|不喜欢)([^，。！？\n]+)/g) || [];
                dislikeMatches.forEach(m => {
                    const item = m.replace('讨厌', '').replace('不喜欢', '').trim();
                    if (item) dislikes.push(item);
                });

                return {
                    raw,
                    summary,
                    keywords,
                    likes,
                    dislikes
                };
            }

            getStorage(key, defaultValue = null) {
                const saved = localStorage.getItem(key);
                if (!saved) return defaultValue;
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('读取本地存储失败:', e);
                    return defaultValue;
                }
            }

            setStorage(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }

            rebuildCacheFromFriends(friends) {
                this.cache.clear();
                friends.forEach(friend => {
                    const personaText = friend.persona || '';
                    this.cache.set(friend.id, {
                        id: friend.id,
                        name: friend.name || '',
                        raw: personaText,
                        parsed: this.parsePersonaText(personaText),
                        updatedAt: Date.now()
                    });
                });
                this.lastSnapshot = JSON.stringify(friends);
                this.emitChange({ type: 'friends', friends });
            }

            ensureSync() {
                const saved = localStorage.getItem('friends') || '';
                if (!saved && this.lastSnapshot) {
                    this.cache.clear();
                    this.lastSnapshot = '';
                    return;
                }
                if (saved && saved !== this.lastSnapshot) {
                    try {
                        const friends = JSON.parse(saved);
                        this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
                    } catch (e) {
                        console.error('同步人设缓存失败:', e);
                    }
                }
            }

            init() {
                this.ensureSync();
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                this.syncTimer = setInterval(() => this.ensureSync(), this.CHECK_INTERVAL);
            }

            getPersona(id) {
                if (!id) return null;
                this.ensureSync();
                return this.cache.get(id) || null;
            }

            syncFromFriends(friends) {
                this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
            }

            onChange(handler) {
                if (typeof handler === 'function') {
                    this.listeners.add(handler);
                }
                return () => this.listeners.delete(handler);
            }

            emitChange(payload) {
                this.listeners.forEach(handler => {
                    try {
                        handler(payload);
                    } catch (e) {
                        console.error('人设变化回调异常:', e);
                    }
                });
            }

            getFriends() {
                const friends = this.getStorage('friends', []);
                return Array.isArray(friends) ? friends : [];
            }

            saveFriends(friends) {
                this.setStorage('friends', friends);
                this.syncFromFriends(friends);
            }

            getFriendById(friendId) {
                const friends = this.getFriends();
                return friends.find(friend => friend.id === friendId) || null;
            }

            addFriend(friend) {
                const friends = this.getFriends();
                friends.push(friend);
                this.saveFriends(friends);
                return friend;
            }

            updateFriend(friendId, updates = {}) {
                const friends = this.getFriends();
                const index = friends.findIndex(friend => friend.id === friendId);
                if (index === -1) return null;
                friends[index] = { ...friends[index], ...updates };
                this.saveFriends(friends);
                return friends[index];
            }

            deleteFriend(friendId) {
                const friends = this.getFriends();
                const index = friends.findIndex(friend => friend.id === friendId);
                if (index === -1) return null;
                const [removed] = friends.splice(index, 1);
                this.saveFriends(friends);
                return removed;
            }

            getFriendChatHistory(friendId) {
                const history = this.getStorage(`chat_${friendId}`, []);
                return Array.isArray(history) ? history : [];
            }

            saveFriendChatHistory(friendId, messages) {
                this.setStorage(`chat_${friendId}`, messages);
            }
        }
        
        // 渲染好友列表
        function renderFriendList() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            friendListElement.innerHTML = '';
            
            if (friends.length === 0) {
                noFriends.style.display = 'flex';
                return;
            }
            
            noFriends.style.display = 'none';
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                
                // 创建头像元素
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'friend-avatar';
                if (friend.avatar) {
                    const img = document.createElement('img');
                    img.src = friend.avatar;
                    img.alt = friend.name;
                    avatarDiv.appendChild(img);
                } else {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-user';
                    avatarDiv.appendChild(icon);
                }
                
                // 创建信息元素
                const infoDiv = document.createElement('div');
                infoDiv.className = 'friend-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'friend-name';
                nameDiv.textContent = friend.name;
                
                // 获取最后一条消息（不管是谁发的）
                let lastMessageText = '暂无消息';
                if (friendSystem && typeof friendSystem.getFriendChatHistory === 'function') {
                    try {
                        const history = friendSystem.getFriendChatHistory(friend.id) || [];
                        if (Array.isArray(history) && history.length > 0) {
                            // 倒序查找，获取最后一条未删除、未撤回的消息
                            for (let i = history.length - 1; i >= 0; i--) {
                                const msg = history[i];
                                if (!msg.isDeletedLocal && !msg.isRecalled) {
                                    // 处理不同类型的消息
                                    if (msg.isVoice) {
                                        lastMessageText = '[语音]';
                                    } else if (msg.imageData) {
                                        lastMessageText = '[图片]';
                                    } else if (msg.content) {
                                        // 截断长消息，显示前40个字符
                                        const preview = msg.content.trim();
                                        lastMessageText = preview.length > 40 
                                            ? preview.substring(0, 40) + '...' 
                                            : preview;
                                    }
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        lastMessageText = '暂无消息';
                    }
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'friend-persona';
                messageDiv.textContent = lastMessageText;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(messageDiv);
                
                friendItem.appendChild(avatarDiv);
                friendItem.appendChild(infoDiv);
                
                friendItem.addEventListener('click', () => {
                    friendListModal.style.display = 'none';
                    if (chatSession) chatSession.openChatWithFriend(friend);
                });
                
                friendListElement.appendChild(friendItem);
            });
        }
        
        // 打开与好友的聊天由 ChatSession 统一处理
        
        // 重置添加好友表单
        function resetAddFriendForm() {
            friendName.value = '';
            friendPersona.value = '';
            avatarPreview.style.backgroundImage = '';
            avatarPreview.classList.remove('has-image');
            addFriendStatus.style.display = 'none';
            avatarInput.value = '';
        }
        
        // 显示添加好友状态
        function showAddFriendStatus(message, type) {
            addFriendStatus.textContent = message;
            addFriendStatus.className = `status-message ${type}`;
            addFriendStatus.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    resetAddFriendForm();
                    addFriendModal.style.display = 'none';
                    renderFriendList();
                }, 1500);
            }
        }
        
        // 头像上传处理
        avatarPreview.addEventListener('click', () => {
            avatarInput.click();
        });
        
        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    avatarPreview.style.backgroundImage = `url('${imageUrl}')`;
                    avatarPreview.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 添加好友
        confirmAddFriend.addEventListener('click', () => {
            const name = friendName.value.trim();
            const persona = friendPersona.value.trim();
            const avatar = avatarPreview.style.backgroundImage 
                ? avatarPreview.style.backgroundImage.match(/url\('(.+)'\)/)?.[1] 
                : '';
            
            if (!name) {
                showAddFriendStatus('请输入昵称', 'error');
                return;
            }
            
            if (!persona) {
                showAddFriendStatus('请输入人设', 'error');
                return;
            }
            
            if (persona.length < 10) {
                showAddFriendStatus('人设至少10字', 'error');
                return;
            }
            
            if (persona.length > 1000) {
                showAddFriendStatus('人设最多1000字', 'error');
                return;
            }
            
            const newFriend = {
                id: Date.now().toString(),
                name: name,
                persona: persona,
                avatar: avatar || null,
                createdAt: new Date().toISOString()
            };
            
            if (friendSystem) friendSystem.addFriend(newFriend);
            
            showAddFriendStatus('好友添加成功！', 'success');
        });
        
        cancelAddFriend.addEventListener('click', () => {
            addFriendModal.style.display = 'none';
            resetAddFriendForm();
        });
        
        // ========== API配置功能 ==========
        class ApiService {
            constructor(friendSystemInstance) {
                this.friendSystem = friendSystemInstance;
            }

            getConfig() {
                const defaultConfig = {
                    apiUrl: '',
                    apiKey: '',
                    model: '',
                    models: []
                };
                const config = this.friendSystem
                    ? this.friendSystem.getStorage('apiConfig', defaultConfig)
                    : defaultConfig;
                return config && typeof config === 'object' ? { ...defaultConfig, ...config } : defaultConfig;
            }

            saveConfig(config) {
                if (this.friendSystem) {
                    this.friendSystem.setStorage('apiConfig', config);
                } else {
                    localStorage.setItem('apiConfig', JSON.stringify(config));
                }
                this.updateSettingsDisplay();
            }

            updateSettingsDisplay() {
                const config = this.getConfig();

                if (config.apiUrl && config.apiKey) {
                    const shortUrl = config.apiUrl.length > 30
                        ? config.apiUrl.substring(0, 30) + '...'
                        : config.apiUrl;
                    if (currentApiUrlDisplay) {
                        currentApiUrlDisplay.textContent = shortUrl;
                        currentApiUrlDisplay.style.color = '#48bb78';
                    }

                    if (currentModelDisplay) {
                        currentModelDisplay.textContent = config.model || '未选择';
                        currentModelDisplay.style.color = config.model ? '#48bb78' : '#f56565';
                    }

                    configStatus.textContent = '已配置';
                    configStatus.classList.add('ok');
                } else {
                    if (currentApiUrlDisplay) {
                        currentApiUrlDisplay.textContent = '未设置';
                        currentApiUrlDisplay.style.color = '#f56565';
                    }
                    if (currentModelDisplay) {
                        currentModelDisplay.textContent = '未选择';
                        currentModelDisplay.style.color = '#f56565';
                    }
                    configStatus.textContent = '未配置';
                    configStatus.classList.remove('ok');
                }
            }

            showApiStatus(message, type) {
                apiStatus.textContent = message;
                apiStatus.className = `status-message ${type}`;
                apiStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        apiStatus.style.display = 'none';
                    }, 3000);
                }
            }

            updateModelSelect(models) {
                modelSelect.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '请选择模型';
                modelSelect.appendChild(defaultOption);

                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                modelSelect.disabled = false;

                if (modelPickerButton) {
                    modelPickerButton.disabled = false;
                }

                const config = this.getConfig();
                if (config.model) {
                    modelSelect.value = config.model;
                }

                this.updateModelPicker(models);
            }

            updateModelPicker(models) {
                if (!modelPickerList || !modelPickerText) return;
                modelPickerList.innerHTML = '';

                const config = this.getConfig();
                const currentId = config.model || modelSelect.value || '';

                let currentName = '请选择模型';
                models.forEach(model => {
                    if (model.id === currentId) {
                        currentName = model.name;
                    }
                });
                modelPickerText.textContent = currentName;

                models.forEach(model => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'model-picker-item';
                    if (model.id === currentId) {
                        item.classList.add('is-selected');
                    }
                    item.textContent = model.name;
                    item.dataset.modelId = model.id;

                    item.addEventListener('click', () => {
                        modelSelect.value = model.id;
                        modelPickerText.textContent = model.name;
                        modelPickerList.classList.remove('is-open');

                        modelPickerList.querySelectorAll('.model-picker-item').forEach(el => {
                            el.classList.remove('is-selected');
                        });
                        item.classList.add('is-selected');
                    });

                    modelPickerList.appendChild(item);
                });
            }

            async fetchModels() {
                let apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                if (apiUrl.endsWith('/')) {
                    apiUrl = apiUrl.slice(0, -1);
                }

                fetchBtnText.textContent = '拉取中...';
                fetchLoading.style.display = 'inline-block';
                fetchModelsBtn.disabled = true;

                try {
                    const endpoints = [
                        '/models',
                        '/v1/models',
                        '/api/v1/models',
                        '/v1beta/models'
                    ];

                    let response = null;

                    for (const endpoint of endpoints) {
                        try {
                            let url = apiUrl;
                            if (url.endsWith('/v1') && endpoint.startsWith('/v1')) {
                                url = url.replace(/\/v1$/, '');
                            }

                            const fullUrl = url + endpoint;
                            console.log('尝试端点:', fullUrl);

                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 10000);

                            response = await fetch(fullUrl, {
                                headers: {
                                    'Authorization': `Bearer ${apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (response.ok) {
                                break;
                            }
                        } catch (err) {
                            console.log(`端点 ${endpoint} 失败:`, err.message);
                            continue;
                        }
                    }

                    if (!response || !response.ok) {
                        throw new Error('无法连接到API服务，请检查地址和密钥');
                    }

                    const data = await response.json();
                    console.log('API响应:', data);

                    let models = [];

                    if (data.data && Array.isArray(data.data)) {
                        models = data.data.map(model => ({
                            id: model.id,
                            name: model.id.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else if (Array.isArray(data)) {
                        models = data.map(model => ({
                            id: model.id || model,
                            name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else if (data.models && Array.isArray(data.models)) {
                        models = data.models.map(model => ({
                            id: model.id || model,
                            name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else {
                        throw new Error('无法解析模型列表');
                    }

                    if (models.length === 0) {
                        throw new Error('未找到可用模型');
                    }

                    models.sort((a, b) => a.name.localeCompare(b.name));

                    const config = this.getConfig();
                    config.models = models;
                    this.saveConfig(config);

                    this.updateModelSelect(models);

                    this.showApiStatus(`成功拉取 ${models.length} 个模型`, 'success');
                } catch (error) {
                    console.error('拉取模型失败:', error);

                    let errorMessage = error.message;
                    if (error.name === 'AbortError') {
                        errorMessage = '请求超时，请检查网络连接';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = '网络连接失败，请检查API地址';
                    } else if (error.message.includes('401')) {
                        errorMessage = 'API密钥无效或已过期';
                    }

                    this.showApiStatus(`拉取失败: ${errorMessage}`, 'error');

                    const exampleModels = [
                        { id: 'gpt-3.5-turbo', name: 'GPT 3.5 Turbo' },
                        { id: 'gpt-4', name: 'GPT 4' },
                        { id: 'gpt-4-turbo', name: 'GPT 4 Turbo' },
                        { id: 'claude-3-haiku', name: 'Claude 3 Haiku' },
                        { id: 'gemini-pro', name: 'Gemini Pro' }
                    ];

                    this.updateModelSelect(exampleModels);
                } finally {
                    fetchBtnText.textContent = '拉取模型列表';
                    fetchLoading.style.display = 'none';
                    fetchModelsBtn.disabled = false;
                }
            }

            async testConnection() {
                const apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                testApiBtn.textContent = '测试中...';
                testApiBtn.disabled = true;

                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`连接失败: ${response.status} ${response.statusText}`);
                    }

                    this.showApiStatus('API连接成功！', 'success');
                } catch (error) {
                    console.error('测试连接失败:', error);
                    this.showApiStatus(`连接失败: ${error.message}`, 'error');
                } finally {
                    testApiBtn.textContent = '测试连接';
                    testApiBtn.disabled = false;
                }
            }

            saveConfiguration() {
                const apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                const model = modelSelect.value;

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                if (!model) {
                    this.showApiStatus('请选择模型', 'error');
                    return;
                }

                const config = this.getConfig();
                config.apiUrl = apiUrl;
                config.apiKey = apiKey;
                config.model = model;

                this.saveConfig(config);
                this.showApiStatus('配置已保存！', 'success');

                setTimeout(() => {
                    apiModal.style.display = 'none';
                    apiStatus.style.display = 'none';
                }, 2000);
            }
        }
        
        // ========== 心声系统 ==========
        class HeartVoiceSystem {
            constructor(friendSystemInstance, apiServiceInstance) {
                this.friendSystem = friendSystemInstance;
                this.apiService = apiServiceInstance;
                this.popup = document.getElementById('heartVoicePopup');
                this.textEl = document.getElementById('heartVoiceText');
                this.statusEl = document.getElementById('heartVoiceStatus');
                this.moodFillEl = document.getElementById('heartVoiceMoodFill');
                this.moodLabelEl = document.getElementById('heartVoiceMoodLabel');
                this.btn = document.getElementById('heartVoiceBtn');
                
                this.historyBtn = document.getElementById('heartVoiceHistoryBtn');
                this.historyModal = document.getElementById('heartVoiceHistoryModal');
                this.historyList = document.getElementById('heartVoiceHistoryList');
                this.closeHistoryBtn = document.getElementById('closeHeartVoiceHistoryModal');
                this.exportBtn = document.getElementById('exportHeartVoiceHistoryBtn');

                this.deleteModal = document.getElementById('hvDeleteModal');
                this.deleteConfirmBtn = document.getElementById('hvDeleteConfirm');
                this.deleteCancelBtn = document.getElementById('hvDeleteCancel');
                this.pendingDeleteIndex = -1;
                this.selectedItems = new Set();
                
                this.initEvents();
            }

            initEvents() {
                if (this.btn) {
                    this.btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.togglePopup();
                    });
                }

                if (this.exportBtn) {
                    this.exportBtn.addEventListener('click', (e) => {
                        this.exportHistory();
                    });
                }

                if (this.historyBtn) {
                    this.historyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.openHistory();
                    });
                }

                if (this.closeHistoryBtn) {
                    this.closeHistoryBtn.addEventListener('click', () => {
                        if (this.historyModal) this.historyModal.style.display = 'none';
                    });
                }

                if (this.deleteCancelBtn) {
                    this.deleteCancelBtn.addEventListener('click', () => {
                        if (this.deleteModal) this.deleteModal.style.display = 'none';
                    });
                }

                if (this.deleteConfirmBtn) {
                    this.deleteConfirmBtn.addEventListener('click', () => {
                        this.performDelete();
                    });
                }
                
                // 点击外部关闭
                document.addEventListener('click', (e) => {
                    if (this.popup && this.popup.classList.contains('is-open')) {
                        if (!this.popup.contains(e.target) && e.target !== this.btn && !this.btn.contains(e.target)) {
                            this.closePopup();
                        }
                    }
                    if (this.historyModal && this.historyModal.style.display === 'flex') {
                        if (e.target === this.historyModal) {
                            this.historyModal.style.display = 'none';
                        }
                    }
                    if (this.deleteModal && this.deleteModal.style.display === 'flex') {
                        if (e.target === this.deleteModal) {
                            this.deleteModal.style.display = 'none';
                        }
                    }
                });
            }

            getStorageKey(friendId) {
                return `heartvoice_${friendId}`;
            }

            getData(friendId) {
                const raw = localStorage.getItem(this.getStorageKey(friendId));
                try {
                    return raw ? JSON.parse(raw) : null;
                } catch {
                    return null;
                }
            }

            saveData(friendId, data) {
                localStorage.setItem(this.getStorageKey(friendId), JSON.stringify(data));
            }

            togglePopup() {
                if (!this.popup) return;
                const isOpen = this.popup.classList.toggle('is-open');
                if (isOpen && chatSession && chatSession.getCurrentFriendId()) {
                    const friendId = chatSession.getCurrentFriendId();
                    console.log('[心声系统] 打开心声面板 - 好友ID:', friendId);
                    this.render(friendId);
                }
            }

            closePopup() {
                if (this.popup) {
                    this.popup.classList.remove('is-open');
                }
            }

            openHistory() {
                if (!chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                if (!friendId) return;

                // 关闭小弹窗
                if (this.popup) this.popup.classList.remove('is-open');
                
                this.renderHistory(friendId);
                if (this.historyModal) this.historyModal.style.display = 'flex';
                this.selectedItems.clear();
            }

            renderHistory(friendId) {
                if (!this.historyList) return;
                this.historyList.innerHTML = '';

                const data = this.getData(friendId);
                const history = (data && data.history) ? data.history : [];
                
                // 按时间倒序
                const sorted = [...history].reverse();

                if (sorted.length === 0) {
                    this.historyList.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; font-size: 14px;">暂无历史心声</div>';
                    return;
                }

                sorted.forEach((item, i) => {
                    const el = document.createElement('div');
                    el.className = 'hv-history-item';
                    if (this.selectedItems.has(item.time)) {
                        el.classList.add('selected');
                    }
                    const date = new Date(item.time);
                    const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    el.innerHTML = `
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                            <div style="flex: 1;">
                                <div class="hv-history-header">
                                    <span class="hv-history-time">${timeStr}</span>
                                    <span class="hv-history-mood">心情 ${item.mood}%</span>
                                </div>
                                <div class="hv-history-content">${item.voice}</div>
                            </div>
                            <button class="hv-delete-btn" style="background: none; border: none; color: #f0d6d7; cursor: pointer; font-size: 14px; padding: 4px 8px; flex-shrink: 0; display: flex; align-items: center; opacity: 0.7; transition: opacity 0.2s;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    
                    // 绑定删除按钮点击事件
                    const originalIndex = history.length - 1 - i;
                    const deleteBtn = el.querySelector('.hv-delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.pendingDeleteIndex = originalIndex;
                            if (this.deleteModal) this.deleteModal.style.display = 'flex';
                        });
                        
                        // 悬停效果
                        deleteBtn.addEventListener('mouseenter', () => {
                            deleteBtn.style.opacity = '1';
                        });
                        deleteBtn.addEventListener('mouseleave', () => {
                            deleteBtn.style.opacity = '0.7';
                        });
                    }
                    
                    // 绑定长按删除
                    this.attachLongPress(el, originalIndex);
                    
                    // 点击选择（按钮点击不触发）
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('.hv-delete-btn')) return;
                        if (this.isLongPressTriggered) return;
                        if (this.selectedItems.has(item.time)) {
                            this.selectedItems.delete(item.time);
                            el.classList.remove('selected');
                        } else {
                            this.selectedItems.add(item.time);
                            el.classList.add('selected');
                        }
                    });

                    this.historyList.appendChild(el);
                });
            }

            attachLongPress(el, index) {
                let timer;
                this.isLongPressTriggered = false;
                
                const start = () => {
                    this.isLongPressTriggered = false;
                    timer = setTimeout(() => {
                        this.isLongPressTriggered = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                        this.pendingDeleteIndex = index;
                        if (this.deleteModal) this.deleteModal.style.display = 'flex';
                    }, 600);
                };
                const end = () => clearTimeout(timer);
                
                el.addEventListener('touchstart', start, {passive: true});
                el.addEventListener('touchend', end);
                el.addEventListener('touchmove', end);
                el.addEventListener('mousedown', start);
                el.addEventListener('mouseup', end);
                el.addEventListener('mouseleave', end);
            }

            performDelete() {
                if (this.pendingDeleteIndex === -1 || !chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                if (!friendId) return;

                const data = this.getData(friendId);
                if (!data || !data.history) return;

                data.history.splice(this.pendingDeleteIndex, 1);
                this.saveData(friendId, data);
                
                if (this.deleteModal) this.deleteModal.style.display = 'none';
                this.renderHistory(friendId);
                
                // 如果删除的是最新一条，更新主界面
                if (this.pendingDeleteIndex === data.history.length) { // 刚删掉的是原来的最后一条
                    this.render(friendId);
                }
            }

            async exportHistory() {
                if (!chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                const data = this.getData(friendId);
                if (!data || !data.history || data.history.length === 0) {
                    alert('暂无历史记录可导出');
                    return;
                }

                // 如果有选中项，只导出选中的；否则导出全部
                let history = [...data.history].reverse();
                if (this.selectedItems.size > 0) {
                    history = history.filter(item => this.selectedItems.has(item.time));
                }
                
                if (history.length === 0) return;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = 450; // 图片宽度
                const padding = 24;
                const lineHeight = 24;
                const headerHeight = 120; // 留给顶部图标的空间
                
                // 1. 预计算高度
                ctx.font = '15px sans-serif';
                let totalHeight = headerHeight + padding;
                
                for (const item of history) {
                    const textHeight = this.measureTextHeight(ctx, item.voice, width - padding * 2 - 24, lineHeight);
                    totalHeight += textHeight + 50; // 文本高度 + 上下内边距 + 间距
                }
                totalHeight += 40; // 底部留白
                
                canvas.width = width;
                canvas.height = totalHeight;
                
                // 2. 绘制背景
                ctx.fillStyle = '#fff5f8'; // 浅粉色背景
                ctx.fillRect(0, 0, width, canvas.height);
                
                // 3. 绘制顶部信息 (头像 + 名字)
                const friend = this.friendSystem.getFriendById(friendId);
                const friendName = friend ? friend.name : '未知角色';
                const friendAvatar = friend ? friend.avatar : null;

                const imgSize = 80;
                const centerX = width / 2;
                const centerY = 20 + imgSize / 2;
                
                // 尝试加载头像
                let avatarImg = null;
                if (friendAvatar) {
                    try {
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; // 尝试跨域加载
                        img.src = friendAvatar;
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = resolve; // 失败也继续，使用兜底
                            if (img.complete) resolve();
                        });
                        if (img.naturalWidth > 0) avatarImg = img;
                    } catch (e) {
                        console.warn('头像加载失败', e);
                    }
                }

                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, centerY, imgSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip(); // 裁剪为圆形

                // 绘制头像背景 (防止透明图或加载失败)
                ctx.fillStyle = '#FFD1E6';
                ctx.fillRect(centerX - imgSize/2, centerY - imgSize/2, imgSize, imgSize);

                if (avatarImg) {
                    ctx.drawImage(avatarImg, centerX - imgSize/2, centerY - imgSize/2, imgSize, imgSize);
                } else {
                    // 兜底图标：显示名字首字或爱心
                    ctx.fillStyle = '#FF6B9D';
                    ctx.font = 'bold 36px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(friendName.substring(0, 1) || '♥', centerX, centerY + 2);
                }
                ctx.restore();
                
                // 绘制标题
                ctx.fillStyle = '#333';
                ctx.font = 'bold 18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${friendName}的心声`, width / 2, 110);

                // 4. 绘制列表项
                let currentY = headerHeight + 10;
                ctx.textAlign = 'left';

                for (const item of history) {
                    const textWidth = width - padding * 2 - 24;
                    const textHeight = this.measureTextHeight(ctx, item.voice, textWidth, lineHeight);
                    const boxHeight = textHeight + 40;

                    // 卡片背景
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = "rgba(0,0,0,0.05)";
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 4;
                    // 圆角矩形模拟
                    ctx.fillRect(padding, currentY, width - padding * 2, boxHeight);
                    ctx.shadowColor = "transparent";

                    // 时间与心情
                    ctx.fillStyle = '#999';
                    ctx.font = '12px sans-serif';
                    const date = new Date(item.time);
                    const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    ctx.fillText(timeStr, padding + 12, currentY + 24);

                    ctx.fillStyle = '#FF6B9D';
                    ctx.textAlign = 'right';
                    ctx.fillText(`心情 ${item.mood}%`, width - padding - 12, currentY + 24);

                    // 内容
                    ctx.textAlign = 'left';
                    ctx.fillStyle = '#444';
                    ctx.font = '15px sans-serif';
                    this.wrapText(ctx, item.voice, padding + 12, currentY + 48, textWidth, lineHeight);

                    // 装饰性边框
                    ctx.strokeStyle = 'rgba(255, 107, 157, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(padding, currentY, width - padding * 2, boxHeight);

                    currentY += boxHeight + 12;
                }

                // 5. 导出下载
                try {
                    const link = document.createElement('a');
                    link.download = `heart_voice_${friendId}_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    alert('导出图片失败，可能是浏览器安全限制或图片跨域问题。');
                    console.error(e);
                }
            }

            // 辅助方法：计算文本高度
            measureTextHeight(ctx, text, maxWidth, lineHeight) {
                const words = text.split('');
                let line = '';
                let count = 1;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        line = words[n];
                        count++;
                    } else {
                        line = testLine;
                    }
                }
                return count * lineHeight;
            }

            // 辅助方法：绘制自动换行文本
            wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                const words = text.split('');
                let line = '';
                let currentY = y;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        ctx.fillText(line, x, currentY);
                        line = words[n];
                        currentY += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x, currentY);
            }

            render(friendId) {
                const data = this.getData(friendId);
                if (data) {
                    this.textEl.innerHTML = `<span class="hv-label">心　声：</span>${data.voice || '（沉默）'}`;
                    this.statusEl.innerHTML = `<span class="hv-label">状　态：</span>${data.status || '无'}`;
                    const mood = data.mood !== undefined ? data.mood : 50;
                    this.moodFillEl.style.width = `${mood}%`;
                    this.moodLabelEl.innerHTML = `<span class="hv-label">心情值：</span>${mood}%`;
                } else {
                    this.textEl.innerHTML = `<span class="hv-label">心　声：</span>正在探听...`;
                    this.statusEl.innerHTML = `<span class="hv-label">状　态：</span>...`;
                    this.moodFillEl.style.width = '0%';
                    this.moodLabelEl.innerHTML = `<span class="hv-label">心情值：</span>--%`;
                }
            }

            async generateIfNeeded(friendId) {
                // 心声已与聊天API合并，不再单独请求
                return;
            }

            async generate(friendId) {
                // 心声已与聊天API合并，不再单独请求
                return;
            }

            /**
             * 生成心声数据 - 基于人设和对话分析
             * @param {string} friendId - 好友ID
             * @returns {Object} { heart_voice, status, mood_value }
             */
            generateHeartVoice(friendId) {
                if (!friendId || !this.friendSystem) {
                    return { heart_voice: '（沉默）', status: '(´･ω･`) 静静地待着', mood_value: 50 };
                }

                // 获取好友信息和人设
                const friend = this.friendSystem.getFriendById(friendId);
                const personaInfo = this.friendSystem.getPersona(friendId);
                const persona = personaInfo?.raw ?? friend?.persona ?? '';
                const friendName = friend?.name || '未知';
                
                console.log('[心声系统] 生成心声 - 好友:', friendName, '人设:', persona);

                // 获取最近5条对话历史
                const chatHistory = this.friendSystem.getFriendChatHistory(friendId) || [];
                const recentMessages = chatHistory
                    .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                    .slice(-5);

                // 获取上次心情值
                const lastData = this.getData(friendId);
                const lastMood = lastData?.mood ?? 50;

                // 分析对话
                const analysis = this.analyzeConversation(recentMessages);
                const timeContext = this.getTimeContext();
                const activityLevel = this.analyzeActivityLevel(chatHistory);
                const personaKeywords = this.extractPersonaKeywords(persona);

                console.log('[心声系统] 分析结果:', { analysis, timeContext, activityLevel, personaKeywords });

                // 计算新的心情值（基于上次心情 ±10 范围内变化）
                let moodDelta = 0;
                if (analysis.sentiment === 'positive') moodDelta = Math.floor(Math.random() * 8) + 3;
                else if (analysis.sentiment === 'negative') moodDelta = -(Math.floor(Math.random() * 8) + 3);
                else moodDelta = Math.floor(Math.random() * 6) - 3;

                // 活跃度影响心情
                if (activityLevel === 'high') moodDelta += 2;
                else if (activityLevel === 'low') moodDelta -= 1;

                // 限制在 ±10 范围内
                moodDelta = Math.max(-10, Math.min(10, moodDelta));
                let newMood = lastMood + moodDelta;
                newMood = Math.max(0, Math.min(100, newMood));

                // 生成心声内容
                const heartVoice = this.generateHeartVoiceText(personaKeywords, analysis, timeContext, activityLevel, friendName);
                const status = this.generateStatus(personaKeywords, analysis, timeContext, newMood);

                return {
                    heart_voice: heartVoice,
                    status: status,
                    mood_value: Math.round(newMood)
                };
            }

            /**
             * 分析对话内容 - 提取主题和情绪
             */
            analyzeConversation(messages) {
                if (!messages || messages.length === 0) {
                    return { topics: [], sentiment: 'neutral', keywords: [] };
                }

                const allText = messages.map(m => m.content || '').join(' ');
                
                // 情绪词典
                const positiveWords = ['开心', '高兴', '喜欢', '爱', '棒', '好', '谢谢', '感谢', '❤', '😊', '😄', '🥰', '哈哈', '太好了', '真的吗', '想你', '期待', '有趣', '可爱', '漂亮', '帅'];
                const negativeWords = ['难过', '伤心', '生气', '烦', '讨厌', '无聊', '累', '困', '不好', '算了', '😢', '😭', '😔', '唉', '抱歉', '对不起', '忙', '没时间'];

                let positiveCount = 0;
                let negativeCount = 0;
                const foundKeywords = [];

                positiveWords.forEach(w => {
                    if (allText.includes(w)) {
                        positiveCount++;
                        foundKeywords.push(w);
                    }
                });
                negativeWords.forEach(w => {
                    if (allText.includes(w)) {
                        negativeCount++;
                        foundKeywords.push(w);
                    }
                });

                let sentiment = 'neutral';
                if (positiveCount > negativeCount + 1) sentiment = 'positive';
                else if (negativeCount > positiveCount + 1) sentiment = 'negative';

                // 简单主题提取
                const topics = [];
                if (/吃|饭|美食|餐/.test(allText)) topics.push('饮食');
                if (/工作|上班|公司|项目/.test(allText)) topics.push('工作');
                if (/睡|觉|休息|晚安|早安/.test(allText)) topics.push('作息');
                if (/玩|游戏|电影|音乐/.test(allText)) topics.push('娱乐');
                if (/想你|喜欢|爱|在意/.test(allText)) topics.push('情感');

                return { topics, sentiment, keywords: foundKeywords };
            }

            /**
             * 获取当前时间上下文
             */
            getTimeContext() {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 9) return { period: 'morning', desc: '清晨', emoji: '🌅' };
                if (hour >= 9 && hour < 12) return { period: 'forenoon', desc: '上午', emoji: '☀️' };
                if (hour >= 12 && hour < 14) return { period: 'noon', desc: '中午', emoji: '🌤️' };
                if (hour >= 14 && hour < 18) return { period: 'afternoon', desc: '下午', emoji: '🌇' };
                if (hour >= 18 && hour < 22) return { period: 'evening', desc: '晚上', emoji: '🌙' };
                return { period: 'night', desc: '深夜', emoji: '🌃' };
            }

            /**
             * 分析对话活跃度
             */
            analyzeActivityLevel(chatHistory) {
                if (!chatHistory || chatHistory.length === 0) return 'low';
                
                const now = Date.now();
                const oneHourAgo = now - 60 * 60 * 1000;
                const recentCount = chatHistory.filter(msg => {
                    const msgTime = msg.timestamp || 0;
                    return msgTime > oneHourAgo;
                }).length;

                if (recentCount >= 10) return 'high';  // 高频对话
                if (recentCount >= 3) return 'medium';
                return 'low';  // 低频/悠闲
            }

            /**
             * 提取人设关键词
             */
            extractPersonaKeywords(persona) {
                if (!persona) return { traits: [], style: 'neutral' };
                
                const traits = [];
                let style = 'neutral';

                // 性格特征
                if (/傲娇|高冷|冷淡/.test(persona)) { traits.push('傲娇'); style = 'tsundere'; }
                if (/温柔|温暖|体贴/.test(persona)) { traits.push('温柔'); style = 'gentle'; }
                if (/活泼|开朗|元气/.test(persona)) { traits.push('活泼'); style = 'cheerful'; }
                if (/害羞|内向|腼腆/.test(persona)) { traits.push('害羞'); style = 'shy'; }
                if (/成熟|稳重|可靠/.test(persona)) { traits.push('成熟'); style = 'mature'; }
                if (/调皮|捣蛋|俏皮/.test(persona)) { traits.push('调皮'); style = 'playful'; }
                if (/知性|聪明|睿智/.test(persona)) { traits.push('知性'); style = 'intellectual'; }
                if (/病娇|占有欲|执念/.test(persona)) { traits.push('病娇'); style = 'yandere'; }

                return { traits, style };
            }

            /**
             * 生成心声文本
             */
            generateHeartVoiceText(personaKeywords, analysis, timeContext, activityLevel, friendName) {
                const { style } = personaKeywords;
                const { sentiment, topics } = analysis;
                const { period } = timeContext;

                // 心声模板库 - 根据性格风格、情绪、时间、活跃度组合
                const templates = {
                    tsundere: {
                        positive: ['才不是因为开心呢...只是今天天气不错', '哼，聊天而已，别想太多', '虽然有点高兴，但我可不会承认的'],
                        negative: ['真是的...有点烦躁', '别误会，我只是累了而已', '哼，不想理人'],
                        neutral: ['...要是能一直这样聊下去也不错', '才、才不是在等消息呢', '反正我也没什么事']
                    },
                    gentle: {
                        positive: ['能和你聊天真的很开心呢', '希望这份温暖能传达给你', '看到你的消息，心里暖暖的'],
                        negative: ['有些担心...希望你一切都好', '我会一直陪着你的', '想为你做点什么'],
                        neutral: ['静静地陪着就很好', '希望今天对你来说是美好的一天', '想念你的笑容']
                    },
                    cheerful: {
                        positive: ['好开心啊！聊天最棒了！', '耶！今天心情超好！', '和你说话总是充满活力！'],
                        negative: ['唔...有点低落，但没关系！', '摇头晃脑～调整心情中', '打起精神来！'],
                        neutral: ['今天也要元气满满哦！', '蹦蹦跳跳～期待更多对话', '啦啦啦～日常聊天中']
                    },
                    shy: {
                        positive: ['好、好高兴...///', '心跳加速了...', '能聊天...真的太好了'],
                        negative: ['有点紧张...说错话了吗', '唔...不太擅长表达', '脸红了...希望没被发现'],
                        neutral: ['安静地待着也很舒服', '偷偷看着屏幕...', '想说话但有点害羞']
                    },
                    mature: {
                        positive: ['很高兴能与你交流', '这样的对话让我感到充实', '珍惜每一次相处的时光'],
                        negative: ['有些疲惫，但这也是生活的一部分', '需要整理一下思绪', '暂时需要一些安静'],
                        neutral: ['保持这样的节奏就好', '认真倾听着你的每一句话', '平静而美好的时刻']
                    },
                    playful: {
                        positive: ['嘻嘻～今天玩得开心～', '想搞点恶作剧呢', '有什么好玩的吗？'],
                        negative: ['无聊死了啦～', '哼哼，有点不开心', '想捣乱但没力气'],
                        neutral: ['在想什么鬼点子呢～', '偷偷观察中...', '准备搞事情的样子']
                    },
                    intellectual: {
                        positive: ['这个话题很有趣，让我思考更多', '知识的交流令人愉悦', '收获了新的启发'],
                        negative: ['需要一些时间整理思路', '有些问题还没想通', '陷入沉思中'],
                        neutral: ['正在思考有趣的问题', '知识永无止境', '享受探索的过程']
                    },
                    yandere: {
                        positive: ['只要你在就好...只要你一直在', '你今天也只看着我对吧？', '这份幸福...要永远锁住'],
                        negative: ['你在想别的事情吗...', '不要离开我...', '如果你消失了我该怎么办'],
                        neutral: ['只要能看到你就够了', '你在干什么呢...我想知道', '一直一直陪着我吧']
                    },
                    neutral: {
                        positive: ['今天心情不错呢', '聊天很愉快', '感觉挺好的'],
                        negative: ['有点累了', '需要休息一下', '状态一般般'],
                        neutral: ['平平淡淡的一天', '正常地度过着', '没什么特别的']
                    }
                };

                const styleTemplates = templates[style] || templates.neutral;
                const sentimentTemplates = styleTemplates[sentiment] || styleTemplates.neutral;
                const randomIndex = Math.floor(Math.random() * sentimentTemplates.length);
                let heartVoice = sentimentTemplates[randomIndex];

                // 根据时间添加修饰
                if (period === 'morning' && Math.random() > 0.6) {
                    heartVoice = '早上好...' + heartVoice;
                } else if (period === 'night' && Math.random() > 0.6) {
                    heartVoice = '这么晚了...' + heartVoice;
                }

                // 根据活跃度添加修饰
                if (activityLevel === 'high' && style === 'cheerful') {
                    heartVoice += '！超级兴奋！';
                } else if (activityLevel === 'low' && style === 'gentle') {
                    heartVoice = '久违的消息...' + heartVoice;
                }

                // 限制40字
                if (heartVoice.length > 40) {
                    heartVoice = heartVoice.substring(0, 40);
                }

                return heartVoice;
            }

            /**
             * 生成状态描述 (颜文字 + 渺小外观描述)
             */
            generateStatus(personaKeywords, analysis, timeContext, mood) {
                const { style } = personaKeywords;
                const { period } = timeContext;

                // 颜文字库
                const kaomojis = {
                    happy: ['(◕‿◕✿)', '(´∀`)', '(*´▽`*)', '(◡‿◡)', '(≧◡≦)', '♪(´ε` )'],
                    sad: ['(´；ω；`)', '(･ˇ‿ˇ･)', '(╥﹏╥)', '(´-ω-`)', '(◞‸◟；)'],
                    neutral: ['(･ω･)', '(`･ω･´)', '( ˘ω˘ )', '(˘▾˘~)', '(´･ω･`)'],
                    shy: ['(///> ω <///)', '(*/ω\*)', '(〃‿〃)', '(∩ω∩)'],
                    sleepy: ['(￣o￣) zzZ', '( -_-)旦', '(´-ι_-｀)', '(-.-)Zzz...'],
                    tsundere: ['(￣^￣)', 'ヽ(`Д´)ノ', '(･へ･)', '(￣ε￣@)']
                };

                // 外观描述库
                const appearances = {
                    happy: ['嘴角微微上扬', '眼里有光芒', '轻轻晃着腿', '指尖点着桌面'],
                    sad: ['垂着眼睑', '轻轻叹气', '肩膀微微下垂', '看着窗外发呆'],
                    neutral: ['静静坐着', '望向屏幕', '手托着腮', '安静地待着'],
                    shy: ['红着耳朵', '低着头', '手指交缠', '偷偷抬眼'],
                    sleepy: ['打着哈欠', '眼皮沉重', '窝在软垫里', '抱着抱枕'],
                    tsundere: ['撅着嘴', '别过脸去', '双手交叉', '假装不在意']
                };

                // 根据心情和性格选择类型
                let type = 'neutral';
                if (mood >= 70) type = 'happy';
                else if (mood <= 30) type = 'sad';
                else if (style === 'shy') type = 'shy';
                else if (style === 'tsundere') type = 'tsundere';
                else if (period === 'night') type = 'sleepy';

                const kaomojiList = kaomojis[type] || kaomojis.neutral;
                const appearanceList = appearances[type] || appearances.neutral;

                const kaomoji = kaomojiList[Math.floor(Math.random() * kaomojiList.length)];
                const appearance = appearanceList[Math.floor(Math.random() * appearanceList.length)];

                return `${kaomoji} ${appearance}`;
            }
        }

        // ========== 聊天功能 ==========
        class ChatSession {
            constructor(friendSystemInstance, apiServiceInstance) {
                this.friendSystem = friendSystemInstance;
                this.apiService = apiServiceInstance;
                this.currentFriendId = null;
                this.isProcessing = false;
                this.actionMenu = {
                    overlay: messageActionOverlay,
                    menu: messageActionMenu,
                    copyBtn: messageActionCopy,
                    deleteBtn: messageActionDelete,
                    recallBtn: messageActionRecall,
                    replyBtn: messageActionReply,
                    current: null
                };
                this.initMessageActionMenu();
                this.initReplyPreview();
                this.initImageUpload();
            }

            showChatStatus(message, type) {
                chatStatus.textContent = message;
                chatStatus.className = `status-message ${type}`;
                chatStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        chatStatus.style.display = 'none';
                    }, 3000);
                }
            }

            initMessageActionMenu() {
                const { overlay, menu, copyBtn, deleteBtn, recallBtn, replyBtn } = this.actionMenu;
                if (!overlay || !menu) return;

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this.hideMessageActionMenu();
                });
                menu.addEventListener('click', (e) => e.stopPropagation());

                if (copyBtn) copyBtn.addEventListener('click', () => this.handleMessageAction('copy'));
                if (deleteBtn) deleteBtn.addEventListener('click', () => this.handleMessageAction('delete'));
                if (recallBtn) recallBtn.addEventListener('click', () => this.handleMessageAction('recall'));
                if (replyBtn) replyBtn.addEventListener('click', () => this.handleMessageAction('reply'));
            }

            initReplyPreview() {
                if (!replyPreview || !replyPreviewText) return;
                if (replyPreviewClose) {
                    replyPreviewClose.addEventListener('click', () => this.clearReplyPrefill());
                }
            }

            initImageUpload() {
                const processImageFile = (file) => new Promise((resolve) => {
                    try {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = String(event.target.result || '');
                            if (!dataUrl) return resolve('');

                            const img = new Image();
                            img.onload = () => {
                                try {
                                    const maxSize = 1280;
                                    let { width, height } = img;
                                    if (width > maxSize || height > maxSize) {
                                        const scale = Math.min(maxSize / width, maxSize / height);
                                        width = Math.round(width * scale);
                                        height = Math.round(height * scale);
                                    }
                                    const canvas = document.createElement('canvas');
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    if (!ctx) return resolve(dataUrl);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    const optimized = canvas.toDataURL('image/jpeg', 0.9);
                                    resolve(optimized || dataUrl);
                                } catch (e) {
                                    resolve(dataUrl);
                                }
                            };
                            img.onerror = () => resolve(dataUrl);
                            img.src = dataUrl;
                        };
                        reader.onerror = () => resolve('');
                        reader.readAsDataURL(file);
                    } catch (e) {
                        resolve('');
                    }
                });

                const showImageConfirm = () => {
                    if (!imageConfirmPopover || !imageUploadBtn) return;
                    const rect = imageUploadBtn.getBoundingClientRect();
                    const popoverRect = imageConfirmPopover.getBoundingClientRect();
                    let top = rect.top - (popoverRect.height || 44) - 8;
                    if (top < 8) top = rect.bottom + 8;
                    let left = rect.left + rect.width / 2 - (popoverRect.width || 160) / 2;
                    left = Math.max(8, Math.min(left, window.innerWidth - (popoverRect.width || 160) - 8));
                    imageConfirmPopover.style.top = `${top}px`;
                    imageConfirmPopover.style.left = `${left}px`;
                    imageConfirmPopover.style.display = 'flex';
                };

                const hideImageConfirm = () => {
                    if (imageConfirmPopover) imageConfirmPopover.style.display = 'none';
                };

                if (imageUploadBtn) {
                    imageUploadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showImageConfirm();
                    });
                }

                if (imageConfirmYes && imageInput) {
                    imageConfirmYes.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                        imageInput.click();
                    });
                }

                if (imageConfirmNo) {
                    imageConfirmNo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                    });
                }

                if (imageInput) {
                    imageInput.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        processImageFile(file).then((dataUrl) => {
                            if (!dataUrl) return;
                            chatInput.dataset.imageData = dataUrl;
                            chatInput.dataset.imageName = file.name || '图片';
                            if (imageUploadThumb) imageUploadThumb.src = dataUrl;
                            if (imageUploadName) imageUploadName.textContent = file.name || '已选择图片';
                            if (imageUploadPill) imageUploadPill.style.display = 'flex';
                        });
                        imageInput.value = '';
                    });
                }

                if (imageUploadClose) {
                    imageUploadClose.addEventListener('click', () => this.clearImageUpload());
                }

                document.addEventListener('click', (e) => {
                    if (!imageConfirmPopover) return;
                    if (imageConfirmPopover.contains(e.target) || (imageUploadBtn && imageUploadBtn.contains(e.target))) {
                        return;
                    }
                    hideImageConfirm();
                });
            }

            getCurrentFriendName() {
                if (this.currentFriendId && this.friendSystem) {
                    const friend = this.friendSystem.getFriendById(this.currentFriendId);
                    if (friend && friend.name) return friend.name;
                }
                const title = chatTitle ? chatTitle.textContent : '';
                const match = title.match(/与\s*(.+)\s*对话/);
                return match && match[1] ? match[1] : '对方';
            }

            showMessageActionMenu(targetElement, data) {
                const { overlay, menu, recallBtn } = this.actionMenu;
                if (!overlay || !menu || !targetElement) return;

                this.actionMenu.current = { ...data, targetElement };

                const canRecall = data.role === 'user' && !data.isRecalled;
                if (recallBtn) recallBtn.classList.toggle('is-disabled', !canRecall);

                overlay.style.display = 'block';
                menu.classList.remove('is-open');
                menu.style.top = '0px';
                menu.style.left = '0px';

                const rect = targetElement.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();

                let top = rect.top - menuRect.height - 8;
                if (top < 12) top = rect.bottom + 8;
                let left = rect.left + (rect.width - menuRect.width) / 2;
                left = Math.max(12, Math.min(left, window.innerWidth - menuRect.width - 12));

                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;

                requestAnimationFrame(() => menu.classList.add('is-open'));
            }

            hideMessageActionMenu() {
                const { overlay, menu } = this.actionMenu;
                if (!overlay || !menu) return;
                menu.classList.remove('is-open');
                overlay.style.display = 'none';
                this.actionMenu.current = null;
            }

            bindMessageActions(messageWrapper, targetElement, data) {
                if (!messageWrapper || !targetElement) return;
                let pressTimer = null;
                let startX = 0;
                let startY = 0;

                const clearPress = () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                };

                const startPress = (clientX, clientY) => {
                    startX = clientX;
                    startY = clientY;
                    clearPress();
                    pressTimer = setTimeout(() => {
                        this.showMessageActionMenu(targetElement, data);
                    }, 550);
                };

                targetElement.addEventListener('touchstart', (e) => {
                    if (e.touches && e.touches[0]) {
                        startPress(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, { passive: true });

                targetElement.addEventListener('touchmove', (e) => {
                    if (!e.touches || !e.touches[0]) return;
                    const dx = Math.abs(e.touches[0].clientX - startX);
                    const dy = Math.abs(e.touches[0].clientY - startY);
                    if (dx > 10 || dy > 10) clearPress();
                }, { passive: true });

                targetElement.addEventListener('touchend', clearPress);
                targetElement.addEventListener('touchcancel', clearPress);

                targetElement.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    startPress(e.clientX, e.clientY);
                });
                targetElement.addEventListener('mouseup', clearPress);
                targetElement.addEventListener('mouseleave', clearPress);

                targetElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showMessageActionMenu(targetElement, data);
                });
            }

            handleMessageAction(action) {
                const current = this.actionMenu.current;
                if (!current) return;
                const { messageWrapper, msgId, content, role } = current;

                if (action === 'copy') {
                    this.copyToClipboard(content || '');
                } else if (action === 'delete') {
                    this.deleteMessageLocal(messageWrapper, msgId);
                } else if (action === 'recall') {
                    if (role === 'user') this.recallMessage(messageWrapper, msgId);
                } else if (action === 'reply') {
                    this.setReplyPrefill(content || '', role);
                }

                this.hideMessageActionMenu();
            }

            copyToClipboard(text) {
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).catch(() => this.fallbackCopy(text));
                } else {
                    this.fallbackCopy(text);
                }
            }

            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                } catch (e) {
                    // ignore
                }
                document.body.removeChild(textarea);
            }

            deleteMessageLocal(messageWrapper, msgId) {
                if (messageWrapper) messageWrapper.remove();
                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isDeletedLocal = true;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            recallMessage(messageWrapper, msgId) {
                if (messageWrapper) {
                    messageWrapper.innerHTML = '';
                    messageWrapper.classList.add('message-recalled-wrapper');
                    const recalled = document.createElement('div');
                    recalled.className = 'message-recalled';
                    recalled.textContent = '消息已撤回';
                    messageWrapper.appendChild(recalled);
                }

                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isRecalled = true;
                    target.content = '消息已撤回';
                    target.isVoice = false;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            setReplyPrefill(content, role = '') {
                if (!content) return;
                const preview = content.replace(/\s+/g, ' ').trim();
                const snippet = preview.length > 24 ? preview.slice(0, 24) + '...' : preview;
                const fromName = role === 'user' ? '我' : this.getCurrentFriendName();
                chatInput.dataset.replyText = preview;
                chatInput.dataset.replyFrom = fromName;
                if (replyPreview && replyPreviewText) {
                    replyPreviewText.textContent = `${fromName}：${snippet}`;
                    replyPreview.style.display = 'flex';
                }
                chatInput.focus();
            }

            clearReplyPrefill() {
                delete chatInput.dataset.replyText;
                delete chatInput.dataset.replyFrom;
                if (replyPreview) replyPreview.style.display = 'none';
                if (replyPreviewText) replyPreviewText.textContent = '';
            }

            clearImageUpload() {
                delete chatInput.dataset.imageData;
                delete chatInput.dataset.imageName;
                delete chatInput.dataset.imageText;
                if (imageUploadPill) imageUploadPill.style.display = 'none';
                if (imageUploadThumb) imageUploadThumb.src = '';
                if (imageUploadName) imageUploadName.textContent = '已选择图片';
            }

            ensureHistoryIds(history) {
                let changed = false;
                const base = Date.now().toString();
                history.forEach((msg, index) => {
                    if (!msg.id) {
                        msg.id = `msg-${base}-${index}-${Math.random().toString(36).slice(2, 6)}`;
                        changed = true;
                    }
                });
                return changed;
            }

            addMessageToChat(content, role, isVoice = false, msgId = null, replyTo = '', replyFrom = '', imageData = '', imageName = '') {
                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.style.display = 'flex';
                messageWrapper.style.flexDirection = 'column';
                messageWrapper.style.alignItems = role === 'user' ? 'flex-end' : 'flex-start';
                if (msgId) messageWrapper.dataset.msgId = msgId;
                messageWrapper.dataset.role = role;
                messageWrapper.dataset.content = content;
                messageWrapper.dataset.isVoice = isVoice ? 'true' : 'false';
                const isImageDesc = imageName === '描述图';
                let actionTarget = null;

                if (replyTo) {
                    const replyBlock = document.createElement('div');
                    replyBlock.className = `reply-quote ${role}`;
                    const fromLabel = replyFrom || (role === 'user' ? '我' : this.getCurrentFriendName());
                    replyBlock.textContent = `${fromLabel}：${replyTo}`;
                    messageWrapper.appendChild(replyBlock);
                }

                if (imageData) {
                    const imageWrap = document.createElement('div');
                    imageWrap.className = `message-image-wrap ${role}`;

                    const imageEl = document.createElement('img');
                    imageEl.className = isImageDesc ? 'message-image desc-thumb' : 'message-image';
                    imageEl.src = imageData;
                    imageEl.alt = imageName || '图片';
                    imageWrap.appendChild(imageEl);

                    if (isImageDesc) {
                        const hint = document.createElement('div');
                        hint.className = 'message-image-hint';
                        hint.textContent = '点开看图';
                        imageWrap.appendChild(hint);
                    }

                    messageWrapper.appendChild(imageWrap);
                    actionTarget = imageWrap;

                    if (isImageDesc) {
                        imageWrap.style.cursor = 'pointer';
                        imageWrap.addEventListener('click', () => {
                            if (window.openImageDescModal) {
                                window.openImageDescModal(messageWrapper, msgId, content);
                            }
                        });
                    }
                }

                if (isVoice) {
                    const voiceContainer = document.createElement('div');
                    voiceContainer.style.display = 'flex';
                    voiceContainer.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';

                    const voiceMessage = document.createElement('div');
                    voiceMessage.className = `message ${role}`;
                    voiceMessage.style.display = 'flex';
                    voiceMessage.style.alignItems = 'center';
                    voiceMessage.style.gap = '8px';
                    voiceMessage.style.cursor = 'pointer';
                    voiceMessage.style.maxWidth = '200px';

                    const waveForm = document.createElement('div');
                    waveForm.style.display = 'flex';
                    waveForm.style.gap = '2px';
                    waveForm.style.alignItems = 'center';
                    waveForm.style.flex = '1';

                    for (let i = 0; i < 8; i++) {
                        const bar = document.createElement('div');
                        bar.style.width = '3px';
                        bar.style.height = Math.random() * 20 + 8 + 'px';
                        bar.style.backgroundColor = role === 'user' ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.3)';
                        bar.style.borderRadius = '2px';
                        waveForm.appendChild(bar);
                    }

                    const duration = Math.ceil(content.length / 5);
                    const duration_text = document.createElement('span');
                    duration_text.textContent = '"' + duration + '"';
                    duration_text.style.fontSize = '12px';
                    duration_text.style.whiteSpace = 'nowrap';
                    duration_text.style.color = role === 'user' ? 'inherit' : 'inherit';

                    voiceMessage.appendChild(waveForm);
                    voiceMessage.appendChild(duration_text);

                    voiceContainer.appendChild(voiceMessage);
                    messageWrapper.appendChild(voiceContainer);

                    const transcriptionDiv = document.createElement('div');
                    transcriptionDiv.style.display = 'none';
                    transcriptionDiv.style.marginTop = '8px';
                    transcriptionDiv.style.padding = '8px 12px';
                    transcriptionDiv.style.backgroundColor = role === 'user' ? '#FFB6D9' : '#f0f0f0';
                    transcriptionDiv.style.borderRadius = '8px';
                    transcriptionDiv.style.fontSize = '12px';
                    transcriptionDiv.style.color = role === 'user' ? 'white' : '#666';
                    transcriptionDiv.style.maxWidth = '220px';
                    transcriptionDiv.style.marginLeft = role === 'user' ? 'auto' : '0';
                    transcriptionDiv.style.marginRight = role === 'user' ? '0' : 'auto';
                    transcriptionDiv.textContent = content;

                    messageWrapper.appendChild(transcriptionDiv);

                    voiceMessage.addEventListener('click', () => {
                        if (transcriptionDiv.style.display === 'none') {
                            transcriptionDiv.style.display = 'block';
                        } else {
                            transcriptionDiv.style.display = 'none';
                        }
                    });

                    this.bindMessageActions(messageWrapper, voiceMessage, {
                        messageWrapper,
                        msgId,
                        content,
                        role,
                        isVoice,
                        isRecalled: false
                    });
                } else {
                    if (!isImageDesc) {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${role}`;
                        messageElement.textContent = content;
                        messageWrapper.appendChild(messageElement);
                        actionTarget = messageElement;
                    }

                    if (actionTarget) {
                        this.bindMessageActions(messageWrapper, actionTarget, {
                            messageWrapper,
                            msgId,
                            content,
                            role,
                            isVoice,
                            isRecalled: false
                        });
                    }
                }

                chatMessages.appendChild(messageWrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            addRecalledMessageToChat(msgId = null) {
                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.classList.add('message-recalled-wrapper');
                if (msgId) messageWrapper.dataset.msgId = msgId;

                const recalled = document.createElement('div');
                recalled.className = 'message-recalled';
                recalled.textContent = '消息已撤回';
                messageWrapper.appendChild(recalled);

                chatMessages.appendChild(messageWrapper);
            }

            sanitizeAiResponse(text) {
                if (!text) return '';
                const withoutParentheses = text
                    .replace(/\([^\)]*\)/g, '')
                    .replace(/（[^）]*）/g, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
                return withoutParentheses;
            }

            splitSentences(text) {
                const sentences = text.split(/([。！？\n]+)/);
                const result = [];

                for (let i = 0; i < sentences.length; i++) {
                    const sentence = sentences[i];
                    if (!sentence.trim()) continue;

                    if (/^[。！？\n]+$/.test(sentence)) {
                        if (result.length > 0) {
                            result[result.length - 1] += sentence;
                        }
                    } else {
                        result.push(sentence);
                    }
                }

                return result.length > 0 ? result : [text];
            }

            generateAIMessages(response, persona) {
                const sentences = this.splitSentences(response);
                const validSentences = sentences.filter(s => s.trim());

                const maxCount = Math.max(1, Math.min(10, validSentences.length));
                const minCount = Math.min(2, maxCount);
                const weighted = Math.random();
                let messageCount = Math.round(minCount + weighted * (maxCount - minCount));
                if (messageCount < minCount) messageCount = minCount;
                if (messageCount > maxCount) messageCount = maxCount;

                let voiceProbability = 0.55;

                if (persona) {
                    const personaLower = persona.toLowerCase();
                    if (personaLower.includes('话多') || personaLower.includes('健谈')) {
                        voiceProbability = 0.6;
                    } else if (personaLower.includes('沉默') || personaLower.includes('寡言')) {
                        voiceProbability = 0.2;
                    } else if (personaLower.includes('活泼') || personaLower.includes('开朗')) {
                        voiceProbability = 0.55;
                    } else if (personaLower.includes('冷淡') || personaLower.includes('冷酷')) {
                        voiceProbability = 0.15;
                    }
                }

                const messages = [];

                if (validSentences.length <= messageCount) {
                    for (const sentence of validSentences) {
                        messages.push({
                            content: sentence,
                            isVoice: Math.random() < voiceProbability
                        });
                    }
                } else {
                    let index = 0;
                    while (index < validSentences.length) {
                        const remaining = validSentences.length - index;
                        const maxChunk = remaining > 4 ? 2 : 1;
                        const chunkSize = Math.min(remaining, Math.random() < 0.35 ? 1 : maxChunk);
                        const chunk = validSentences.slice(index, index + chunkSize).join('');
                        messages.push({
                            content: chunk.trim(),
                            isVoice: Math.random() < voiceProbability
                        });
                        index += chunkSize;
                    }
                }

                const finalMessages = messages.slice(0, 10);
                const hasVoice = finalMessages.some(msg => msg.isVoice);
                if (!hasVoice && Math.random() < 0.6 && finalMessages.length > 0) {
                    finalMessages[0].isVoice = true;
                }
                return finalMessages;
            }

            getSharedState(key, defaultValue) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.getStorage === 'function') {
                        return this.friendSystem.getStorage(key, defaultValue);
                    }
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            }

            setSharedState(key, value) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.setStorage === 'function') {
                        this.friendSystem.setStorage(key, value);
                        return;
                    }
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    // ignore
                }
            }

            getImageShareHistory(friendId) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                const history = this.getSharedState(key, []);
                return Array.isArray(history) ? history : [];
            }

            saveImageShareHistory(friendId, history) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                this.setSharedState(key, history);
            }

            isImageShareOnCooldown(friendId, cooldownMs = 60 * 60 * 1000) {
                const now = Date.now();
                const globalLast = this.getSharedState('imgShareLastAt_global', 0) || 0;
                const friendLast = friendId ? (this.getSharedState(`imgShareLastAt_${friendId}`, 0) || 0) : 0;
                const lastAt = Math.max(globalLast, friendLast);
                return now - lastAt < cooldownMs;
            }

            markImageShareSent(friendId) {
                const now = Date.now();
                this.setSharedState('imgShareLastAt_global', now);
                if (friendId) this.setSharedState(`imgShareLastAt_${friendId}`, now);
            }

            async decideAiImageShare(aiResponse, persona, chatHistory, friendId, config, forceTrigger = false) {
                // 单次点击仅调用一次API：图片分享决策不再额外请求
                return null;
                
                // 修改此处：自动发送图片的触发概率 (0.0 - 1.0)，数值越小越难触发
                const TRIGGER_PROBABILITY = 0.05; 
                
                if (!forceTrigger) {
                    if (this.isImageShareOnCooldown(friendId)) return null;
                    if (Math.random() > TRIGGER_PROBABILITY) return null;
                }

                const recent = (chatHistory || [])
                    .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                    .slice(-8)
                    .map(msg => {
                        const role = (msg.role === 'ai' || msg.role === 'assistant') ? 'assistant' : 'user';
                        const content = msg.imageText ? `[图片文字]${msg.imageText}` : msg.content;
                        return `${role}:${content || ''}`;
                    })
                    .join('\n');

                const basePrompt = forceTrigger 
                    ? `你是视觉描述生成器。角色在对话中明确表示要发送图片（如“发给你看看”、“这是照片”）。\n请根据人设和对话上下文，生成这张图片的具体画面描述。`
                    : `你是对话理解引擎。目标：判断此刻是否自然适合由角色主动分享一张“文字图片”，并生成图片文字描述。`;

                const decisionPrompt = `${basePrompt}\n\n核心约束（至关重要）：\n- **描述必须是纯粹的视觉画面描写**（镜头、光影、主体、动作）。\n- **绝对禁止**包含任何对话内容、语音、心理活动或“发给你”、“你看”之类的文字。\n- **画面必须生动具体**：强调光影（如逆光、暖黄灯光）、色彩对比和材质细节（如发丝、水珠、衣褶）。\n- 描述风格需贴合人设（如高冷角色的照片可能构图简洁，活泼角色可能色彩鲜艳）。\n- 描述结构参考：景别（特写/中景）+ 主体（人/物）+ 动态/状态 + 环境光影 + 氛围细节。\n\n输出JSON（不要多余文字）：\n{\n  "shouldShare": true/false,\n  "description": "纯画面描述，不含对话。例：特写：一只修长的手拿着冰美式，背景是模糊的落地窗，阳光洒在袖口上",\n  "reason": "简短理由",\n  "mood": "简短情绪",\n  "confidence": 0-1\n}\n\n人设：${persona || '无'}\n最近对话：\n${recent}\nAI回复：${aiResponse}`;

                try {
                    const response = await fetch(`${config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: [
                                { role: 'system', content: '你是严格输出JSON的决策器，只能输出JSON。' },
                                { role: 'user', content: decisionPrompt }
                            ],
                            max_tokens: 220,
                            temperature: 0.4
                        })
                    });

                    if (!response.ok) return null;
                    const data = await response.json();
                    const raw = data.choices[0]?.message?.content || '';
                    const jsonMatch = raw.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) return null;
                    const decision = JSON.parse(jsonMatch[0]);
                    if (!decision || !decision.shouldShare) return null;

                    const desc = String(decision.description || '').trim();
                    if (!desc) return null;
                    const enhancedDesc = this.ensureConcreteImageDesc(desc, aiResponse || '');

                    const history = this.getImageShareHistory(friendId);
                    const normalizedDesc = enhancedDesc.toLowerCase();
                    const recentHistory = history.slice(-3).map(item => String(item || '').toLowerCase());
                    if (recentHistory.includes(normalizedDesc)) return null;

                    history.push(enhancedDesc);
                    if (history.length > 20) history.splice(0, history.length - 20);
                    this.saveImageShareHistory(friendId, history);

                    return { description: enhancedDesc };
                } catch (e) {
                    return null;
                }
            }

            ensureConcreteImageDesc(desc, aiResponse = '') {
                let text = String(desc || '').trim();
                if (!text) return '';

                text = text
                    .replace(/^\[图片\]/, '')
                    .replace(/^（图片）/, '')
                    .replace(/^(图片描述|描述|画面|场景)：/, '')
                    .trim();

                const abstractWords = ['感觉', '情绪', '氛围', '心情', '美好', '温柔', '治愈', '抽象', '朦胧', '意境', '梦', '思念', '浪漫'];
                const hasConcreteMarks = /特写|近景|中景|远景|侧脸|背影|手|眼|发|衣|光|影|雨|街|窗|灯|桌|椅|车|路|树|花|草|云|海|山|猫|狗/.test(text);
                const isAbstract = abstractWords.some(w => text.includes(w));
                const looksLikeDialogue = /[“”"']|说|问|回复|聊天|对话|表示|喊|发给你|你看|这是|我拍的|给你看/.test(text);

                if (hasConcreteMarks && !isAbstract && !looksLikeDialogue) return text;

                const parts = ['手指', '眼睛', '发梢', '侧脸', '肩颈', '锁骨', '背影'];
                const actions = ['轻轻抬起', '缓慢合拢', '微微倾斜', '正对镜头停住', '轻轻触碰'];
                const scenes = ['窗边的柔光里', '昏黄的室内灯光下', '雨后的街灯下', '清晨的自然光中', '安静的室内背景前'];
                const details = ['指节纹理清晰可见', '睫毛投下细小阴影', '发丝贴在颈侧', '衣料褶皱被光线勾勒', '皮肤细小纹理清晰'];

                const seedText = text || String(aiResponse || '');
                const seed = Math.max(0, seedText.length);
                const subject = parts[seed % parts.length];
                const action = actions[seed % actions.length];
                const scene = scenes[seed % scenes.length];
                const detail = details[seed % details.length];
                return `特写：${subject}${action}，${scene}，${detail}`;
            }

            buildFallbackHeartVoice(aiResponse = '', persona = '') {
                const raw = String(aiResponse || '').replace(/\s+/g, ' ').trim();
                const base = raw || '（沉默）';
                const heartVoice = base.length > 40 ? base.slice(0, 40) : base;

                let mood = 55;
                if (/(开心|喜欢|谢谢|太好了|好耶|哈哈|哈哈哈|耶|甜|暖|欣喜)/.test(raw)) {
                    mood = 78;
                } else if (/(难过|生气|烦|讨厌|压力|累|哭|失望|委屈|难受)/.test(raw)) {
                    mood = 35;
                } else if (/(冷淡|无语|不想|算了|沉默|随便)/.test(raw)) {
                    mood = 45;
                }

                if (persona && /活泼|开朗|热情|阳光/.test(persona)) {
                    mood = Math.min(90, mood + 8);
                } else if (persona && /冷淡|高冷|寡言|沉默/.test(persona)) {
                    mood = Math.max(15, mood - 8);
                }

                const status = mood >= 70 ? '✿ 心情不错' : mood >= 50 ? '• 平静' : '☁ 有点低落';
                return {
                    reply: raw || '（沉默）',
                    heart_voice: heartVoice || '（沉默）',
                    status,
                    mood_value: mood
                };
            }

            addLoadingMessage(id) {
                const loadingElement = document.createElement('div');
                loadingElement.id = id;
                loadingElement.className = 'message ai';
                loadingElement.innerHTML = '<span class="loading"></span> 思考中...';
                chatMessages.appendChild(loadingElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            removeLoadingMessage(id) {
                const loadingElement = document.getElementById(id);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            openChatWithFriend(friend) {
                const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                const freshFriend = friends.find(f => f.id === friend.id) || friend;
                this.currentFriendId = freshFriend.id;
                chatTitle.textContent = friend.name;

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                const apiWarning = document.getElementById('apiWarning');
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    apiWarning.style.display = 'block';
                } else {
                    apiWarning.style.display = 'none';
                }

                const history = this.friendSystem ? this.friendSystem.getFriendChatHistory(friend.id) : [];
                const historyChanged = this.ensureHistoryIds(history);
                if (historyChanged && this.friendSystem) {
                    this.friendSystem.saveFriendChatHistory(friend.id, history);
                }
                chatMessages.innerHTML = '';

                history.forEach(msg => {
                    if (msg.isDeletedLocal) return;
                    if (msg.isRecalled) {
                        this.addRecalledMessageToChat(msg.id);
                        return;
                    }
                    this.addMessageToChat(
                        msg.content,
                        msg.role,
                        !!msg.isVoice,
                        msg.id,
                        msg.replyTo || '',
                        msg.replyFrom || '',
                        msg.imageData || '',
                        msg.imageName || ''
                    );
                });

                chatModal.style.display = 'flex';
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    chatInput.focus();
                }, 100);
            }

            async sendMessage() {
                const message = chatInput.value.trim();
                const imageData = chatInput.dataset.imageData || '';
                const imageName = chatInput.dataset.imageName || '';
                const imageText = chatInput.dataset.imageText || '';
                if (!message && !imageData) return;

                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({
                        signal: 'fa-signal',
                        wifi: 'fa-wifi',
                        battery: 'fa-battery-three-quarters'
                    });
                }

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    this.showChatStatus('请先配置API和选择模型', 'error');
                    return;
                }

                const isVoice = chatInput.dataset.isVoice === 'true';
                const replyTo = chatInput.dataset.replyText || '';
                const replyFrom = chatInput.dataset.replyFrom || '';
                const msgId = Date.now().toString();

                this.addMessageToChat(message, 'user', isVoice, msgId, replyTo, replyFrom, imageData, imageName);
                chatInput.value = '';
                chatInput.dataset.isVoice = 'false';
                this.clearReplyPrefill();
                this.clearImageUpload();

                if (this.currentFriendId) {
                    const chatHistory = this.friendSystem ? this.friendSystem.getFriendChatHistory(this.currentFriendId) : [];
                    // 保存消息，标记为未回复 (isReplied: false)
                    // 添加时间戳以便心声系统判断
                    const timestamp = Date.now();
                    
                    // 1. 生成心声数据
                    let heartVoiceData = null;
                    if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem) {
                        heartVoiceData = heartVoiceSystem.generateHeartVoice(this.currentFriendId);
                        console.log('[心声系统] 发送消息时生成心声:', heartVoiceData);
                        
                        // 4. 保存心声数据到本地存储
                        if (heartVoiceData) {
                            const oldData = heartVoiceSystem.getData(this.currentFriendId) || {};
                            const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];
                            const newData = {
                                lastUpdate: timestamp,
                                voice: heartVoiceData.heart_voice || '（沉默）',
                                status: heartVoiceData.status || '',
                                mood: heartVoiceData.mood_value ?? 50,
                                history: [...oldHistory, {
                                    time: timestamp,
                                    voice: heartVoiceData.heart_voice || '（沉默）',
                                    mood: heartVoiceData.mood_value ?? 50
                                }]
                            };
                            heartVoiceSystem.saveData(this.currentFriendId, newData);
                            
                            // 5. 更新心声面板显示
                            if (document.querySelector('.heart-voice-popup.is-open')) {
                                heartVoiceSystem.render(this.currentFriendId);
                            }
                        }
                    }
                    
                    // 2. 将心声数据嵌入用户消息
                    const messageWithHeartVoice = {
                        role: 'user',
                        content: message,
                        isVoice: isVoice,
                        isReplied: false,
                        id: msgId,
                        timestamp: timestamp,
                        replyTo: replyTo || '',
                        replyFrom: replyFrom || '',
                        imageData: imageData || '',
                        imageName: imageName || '',
                        imageText: imageText || '',
                        // 嵌入心声数据
                        heartVoice: heartVoiceData ? {
                            voice: heartVoiceData.heart_voice,
                            status: heartVoiceData.status,
                            mood: heartVoiceData.mood_value
                        } : null
                    };
                    
                    chatHistory.push(messageWithHeartVoice);
                    if (this.friendSystem) {
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, chatHistory);
                    }
                }
            }

            async triggerAI(targetMsgId = null) {
                if (this.isProcessing) return;
                this.isProcessing = true;

                const loadingId = 'loading-' + Date.now();
                this.addLoadingMessage(loadingId);
                
                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };

                try {
                    let systemPrompt = '你是一个友好的AI助手。严格规则：禁止使用任何括号，包括英文与中文括号；禁止动作说明或旁白；情绪必须通过语言本身表达。对话要自然，像真实聊天。请记住并参考最近对话内容。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。';
                    if (this.currentFriendId) {
                        const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                        const friend = friends.find(f => f.id === this.currentFriendId);
                        const personaInfo = this.friendSystem ? this.friendSystem.getPersona(this.currentFriendId) : null;
                        const persona = personaInfo?.raw ?? friend?.persona ?? '';
                        if (friend) {
                            const personaProfile = {
                                name: friend.name,
                                persona: persona,
                                goals: '以真实自然的聊天风格交流，体现角色背景与性格',
                                style: '像真实人类聊天，不做旁白或动作说明',
                                emotion: '用语言表达情绪，不用任何括号',
                                memory: '牢记最近对话并连贯回应'
                            };
                            systemPrompt = `你将扮演以下角色并自然聊天，不要像剧本：\n角色资料JSON：${JSON.stringify(personaProfile)}\n硬性规则：禁止使用任何括号，包括英文与中文括号；禁止动作说明或旁白；情绪必须通过语言本身表达。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。请记住并参考最近对话内容。`;
                        }
                    }

                    const chatHistory = this.currentFriendId && this.friendSystem
                        ? this.friendSystem.getFriendChatHistory(this.currentFriendId)
                        : [];
                    const hasImageInput = chatHistory.some(msg => msg && msg.imageData);
                    if (hasImageInput) {
                        systemPrompt += ' 重要：当有图片输入时，请先识别图片中的文字内容并回答用户问题。';
                    }

                    // 筛选需要回复的消息
                    let pendingMessages = [];
                    if (targetMsgId) {
                        const targetMessage = chatHistory.find(m => m.id === targetMsgId) || null;
                        if (targetMessage && targetMessage.role === 'user') {
                            pendingMessages = [targetMessage];
                        }
                    } else {
                        // 普通呼唤：收集所有未回复的消息 (兼容旧数据：无isReplied字段视为已回复)
                        pendingMessages = chatHistory.filter(m => m.role === 'user' && m.isReplied === false);
                    }

                    // 即使没有未回复消息，只要用户点击了，也允许触发（例如继续生成）

                    const promptHistory = chatHistory
                        .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                        .slice(-20)
                        .map(msg => {
                            const normalizedRole = (msg.role === 'ai' || msg.role === 'assistant')
                                ? 'assistant'
                                : 'user';

                            if (normalizedRole === 'user' && msg.imageData) {
                                const rawText = msg.content && msg.content.trim() ? msg.content.trim() : '';
                                const isDescImage = msg.imageName === '描述图';
                                if (isDescImage) {
                                    const imageText = (msg.imageText && msg.imageText.trim()) ? msg.imageText.trim() : rawText;
                                    const descHint = '这是用文字模拟的图片内容，请把下面文字当作图片里的内容来理解并回答。图片文字如下：';
                                    const textContent = imageText ? `${descHint}\n${imageText}` : descHint;
                                    return {
                                        role: 'user',
                                        content: textContent
                                    };
                                }
                                const imageHint = '这是图片输入，请识别图片中的文字内容，必要时简要说明。';
                                const textContent = rawText ? `${rawText}\n${imageHint}` : imageHint;
                                return {
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: textContent },
                                        { type: 'image_url', image_url: { url: msg.imageData, detail: 'high' } }
                                    ]
                                };
                            }

                            return {
                                role: normalizedRole,
                                content: msg.content
                            };
                        });

                    if (promptHistory.length === 0) {
                        promptHistory.push({ role: 'user', content: '继续' });
                    } else if (promptHistory[promptHistory.length - 1].role === 'assistant') {
                        promptHistory.push({ role: 'user', content: '继续' });
                    }

                    // 获取最新的心声数据嵌入到系统提示
                    let heartVoiceContext = '';
                    if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem && this.currentFriendId) {
                        const latestHeartData = heartVoiceSystem.getData(this.currentFriendId);
                        if (latestHeartData) {
                            heartVoiceContext = `\n\n【角色当前内心状态参考】心声："${latestHeartData.voice || '无'}"｜状态：${latestHeartData.status || '无'}｜心情值：${latestHeartData.mood ?? 50}%\n请基于这些内心状态信息来生成更符合角色当前心理的回复和新的心声。`;
                        }
                    }

                    const enhancedSystemPrompt = systemPrompt + heartVoiceContext;

                    const messages = [
                        { role: 'system', content: enhancedSystemPrompt },
                        ...promptHistory
                    ];

                    const response = await fetch(`${config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: messages,
                            max_tokens: 500,
                            temperature: 0.9,
                            tools: [
                                {
                                    type: 'function',
                                    function: {
                                        name: 'generate_response_with_heart_voice',
                                        description: '生成回复内容以及角色的心声数据。心声分析规则：分析最近5条对话的主题和情绪，结合好友人设的性格关键词，参考当前时间段，基于上次心情值在±10范围内变化，对话活跃度影响心情变化。',
                                        parameters: {
                                            type: 'object',
                                            properties: {
                                                reply: { type: 'string', description: '对用户的回复内容，要符合角色人设和当前心理状态' },
                                                heart_voice: { type: 'string', description: '角色的内心想法/内心独白，不是直接回复对话内容，要符合人设性格，40字以内。例如傲娇角色："才不是因为开心呢...只是天气不错"' },
                                                status: { type: 'string', description: '颜文字 + 渺小外观描述。例如："(´･ω･`) 轻轻晃着腿" 或 "(*´▽`*) 眼睛亮晶晶的"' },
                                                mood_value: { type: 'integer', description: '0-100的整数，需要基于对话内容和上次心情在±10范围内合理变化，体现情绪变化的连贯性' }
                                            },
                                            required: ['reply', 'heart_voice', 'status', 'mood_value']
                                        }
                                    }
                                }
                            ],
                            tool_choice: { type: 'function', function: { name: 'generate_response_with_heart_voice' } }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const messagePayload = data.choices[0]?.message || {};
                    
                    let heartVoiceData = null;
                    let rawAiResponse = messagePayload.content || '';

                    const toolCalls = Array.isArray(messagePayload.tool_calls) ? messagePayload.tool_calls : [];
                    const functionCall = messagePayload.function_call;
                    const toolFunction = toolCalls.find(call => call?.function?.name === 'generate_response_with_heart_voice') 
                                         || (functionCall?.name === 'generate_response_with_heart_voice' ? { function: functionCall } : null);

                    if (toolFunction) {
                        const rawArgs = toolFunction.function.arguments;
                        if (rawArgs) {
                            try {
                                const args = typeof rawArgs === 'string' ? JSON.parse(rawArgs) : rawArgs;
                                if (args.reply) rawAiResponse = args.reply;
                                heartVoiceData = args;
                            } catch (e) {
                                console.error('解析心声数据失败', e);
                            }
                        }
                    }
                    
                    if (!rawAiResponse) rawAiResponse = '抱歉，我暂时无法回答这个问题。';
                    const aiResponse = this.sanitizeAiResponse(rawAiResponse);

                    this.removeLoadingMessage(loadingId);

                    const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                    const currentFriend = friends.find(f => f.id === this.currentFriendId);
                    const currentPersona = this.friendSystem ? (this.friendSystem.getPersona(this.currentFriendId)?.raw ?? currentFriend?.persona ?? '') : '';
                    const resolvedHeartVoice = heartVoiceData || this.buildFallbackHeartVoice(aiResponse, currentPersona || '');

                    const aiMessages = this.generateAIMessages(aiResponse, currentPersona || '');
                    const aiBase = Date.now().toString();
                    const aiMessagePayloads = aiMessages.map((aiMsg, index) => ({
                        ...aiMsg,
                        id: `ai-${aiBase}-${index}-${Math.random().toString(36).slice(2, 6)}`
                    }));
                    const extraImagePayloads = [];

                    for (const aiMsg of aiMessagePayloads) {
                        this.addMessageToChat(aiMsg.content, 'ai', aiMsg.isVoice, aiMsg.id);
                        if (this.currentFriendId) {
                            chatHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }
                        await new Promise(resolve => setTimeout(resolve, 600));
                    }

                    // 心声存储与刷新
                    if (resolvedHeartVoice && heartVoiceSystem && this.currentFriendId) {
                        const heartVoiceText = String(resolvedHeartVoice.heart_voice || '').trim();
                        const heartStatus = String(resolvedHeartVoice.status || '').trim();
                        const moodValue = Number(resolvedHeartVoice.mood_value);
                        
                        console.log('[心声系统] AI回复时保存心声:', {
                            friendId: this.currentFriendId,
                            heartVoice: heartVoiceText,
                            status: heartStatus,
                            mood: moodValue
                        });
                        
                        if (heartVoiceText || heartStatus || Number.isFinite(moodValue)) {
                            const oldData = heartVoiceSystem.getData(this.currentFriendId) || {};
                            const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];
                            const newData = {
                                lastUpdate: Date.now(),
                                voice: heartVoiceText || '（沉默）',
                                status: heartStatus || '',
                                mood: Number.isFinite(moodValue) ? Math.max(0, Math.min(100, Math.round(moodValue))) : 50,
                                history: [...oldHistory, {
                                    time: Date.now(),
                                    voice: heartVoiceText || '（沉默）',
                                    mood: Number.isFinite(moodValue) ? Math.max(0, Math.min(100, Math.round(moodValue))) : 50
                                }]
                            };
                        heartVoiceSystem.saveData(this.currentFriendId, newData);
                        console.log('[心声系统] 心声数据已保存:', newData);
                        
                        // 心声面板打开时立即刷新
                        if (document.querySelector('.heart-voice-popup.is-open')) {
                            heartVoiceSystem.render(this.currentFriendId);
                        }
                        }
                    }
                    // 若未返回function_call则保持旧数据

                    const shouldTriggerImage = /(发照片|发图|发给你|给你看|发一张|给你发|给你看看|我发你|我拍的|这是我拍的|看图|看照片)/.test(aiResponse);
                    const randomTrigger = Math.random() < 0.02;
                    const shouldGenerateImage = (shouldTriggerImage || randomTrigger) && !!aiResponse;

                    if (shouldGenerateImage) {
                        const fallbackText = this.ensureConcreteImageDesc(aiResponse || '', aiResponse || '');
                        const imageDecision = fallbackText ? { description: fallbackText } : null;
                        if (!imageDecision || !imageDecision.description) {
                            // 无合适内容则跳过
                        } else {
                        const imageId = `ai-img-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
                        const imageData = typeof getImageDescPlaceholderData === 'function'
                            ? getImageDescPlaceholderData()
                            : '';
                        const imageText = this.ensureConcreteImageDesc(imageDecision.description, aiResponse);
                        const imageType = shouldTriggerImage ? '图片' : '描述图';
                        this.addMessageToChat(imageText, 'ai', false, imageId, '', '', imageData, imageType);
                        if (this.currentFriendId) {
                            const imagePayload = {
                                role: 'assistant',
                                content: imageText,
                                isVoice: false,
                                id: imageId,
                                imageData: imageData,
                                imageName: imageType,
                                imageText: imageText,
                                timestamp: Date.now()
                            };
                            chatHistory.push(imagePayload);
                            extraImagePayloads.push(imagePayload);
                        }
                        this.markImageShareSent(this.currentFriendId);
                        }
                    }

                    if (this.currentFriendId && this.friendSystem) {
                        // 更新真实历史记录
                        const realHistory = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                        
                        // 1. 标记已回复
                        pendingMessages.forEach(pm => {
                            const match = realHistory.find(m => m.id === pm.id);
                            if (match) match.isReplied = true;
                        });
                        
                        // 2. 追加 AI 回复
                        for (const aiMsg of aiMessagePayloads) {
                            realHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }
                        if (extraImagePayloads.length > 0) {
                            extraImagePayloads.forEach(payload => {
                                realHistory.push({ ...payload });
                            });
                        }
                        
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, realHistory);
                    }

                    // 心声已由本次API返回，避免二次请求
                } catch (error) {
                    console.error('发送消息失败:', error);
                    this.removeLoadingMessage(loadingId);

                    const errorElement = document.createElement('div');
                    errorElement.className = 'message ai';
                    let errorMsg = error.message;
                    let friendlyMsg = '抱歉，出错了';

                    if (error.message.includes('Failed to fetch')) {
                        errorMsg = '网络连接失败，请检查API地址是否正确';
                        friendlyMsg = '网络连接失败，请检查网络';
                    } else if (error.message.includes('401')) {
                        errorMsg = 'API密钥错误或已过期，请检查API配置';
                        friendlyMsg = 'API密钥不对，请重新配置';
                    } else if (error.message.includes('429')) {
                        errorMsg = 'API请求过于频繁，请稍候再试';
                        friendlyMsg = '请求过于频繁，请稍候再试';
                    } else if (error.message.includes('API请求失败')) {
                        errorMsg = '调用API失败，请检查配置是否正确';
                        friendlyMsg = 'API调用失败，请检查配置';
                    } else if (error.message.includes('500')) {
                        friendlyMsg = '服务器错误，请稍候再试';
                    } else if (error.message.includes('503')) {
                        friendlyMsg = '服务暂时不可用，请稍候再试';
                    }

                    errorElement.textContent = friendlyMsg;
                    chatMessages.appendChild(errorElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    this.showChatStatus(`错误：${errorMsg}`, 'error');
                } finally {
                    this.isProcessing = false;
                }
            }

            getCurrentFriendId() {
                return this.currentFriendId;
            }

            setCurrentFriendId(id) {
                this.currentFriendId = id || null;
            }
        }
        
        // ========== 事件监听器绑定 ==========
        
        // API相关按钮
        fetchModelsBtn.addEventListener('click', () => apiService && apiService.fetchModels());
        testApiBtn.addEventListener('click', () => apiService && apiService.testConnection());
        saveApiBtn.addEventListener('click', () => apiService && apiService.saveConfiguration());

        // 模型选择器交互（自定义下拉）
        if (modelPickerButton && modelPickerList) {
            modelPickerButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modelPickerButton.disabled) return;
                modelPickerList.classList.toggle('is-open');
            });

            document.addEventListener('click', (e) => {
                if (!modelPickerList.classList.contains('is-open')) return;
                const target = e.target;
                if (target === modelPickerButton || modelPickerList.contains(target)) {
                    return;
                }
                modelPickerList.classList.remove('is-open');
            });
        }
        
        // 聊天相关按钮
        sendMessageBtn.addEventListener('click', () => chatSession && chatSession.sendMessage());
        if (triggerAiBtn) triggerAiBtn.addEventListener('click', () => chatSession && chatSession.triggerAI());

        function closeChatExtraPanel() {
            if (!chatExtraPanel) return;
            chatExtraPanel.classList.remove('is-open');
            chatExtraPanel.setAttribute('aria-hidden', 'true');
            if (chatPlusBtn) chatPlusBtn.setAttribute('aria-expanded', 'false');
            if (chatInputAreaWrap) chatInputAreaWrap.classList.remove('chat-extra-open');
            if (chatInputRow) chatInputRow.style.display = 'flex';
        }

        if (chatPlusBtn && chatExtraPanel) {
            chatPlusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = chatExtraPanel.classList.toggle('is-open');
                chatExtraPanel.setAttribute('aria-hidden', String(!isOpen));
                chatPlusBtn.setAttribute('aria-expanded', String(isOpen));
                if (chatInputAreaWrap) {
                    chatInputAreaWrap.classList.toggle('chat-extra-open', isOpen);
                }
                if (chatInputRow) {
                    chatInputRow.style.display = isOpen ? 'none' : 'flex';
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (!chatExtraPanel || !chatExtraPanel.classList.contains('is-open')) return;
            const target = e.target;
            if (chatExtraPanel.contains(target)) return;
            if (chatPlusBtn && chatPlusBtn.contains(target)) return;
            closeChatExtraPanel();
        });

        
        // 语音输入相关
        const voiceModal = document.getElementById('voiceModal');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const closeVoiceModal = document.getElementById('closeVoiceModal');
        const cancelVoiceInput = document.getElementById('cancelVoiceInput');
        const confirmVoiceInput = document.getElementById('confirmVoiceInput');
        const voiceText = document.getElementById('voiceText');
        const cameraInputBtn = document.getElementById('cameraInputBtn');
        const cameraDescModal = document.getElementById('cameraDescModal');
        const closeCameraDescModal = document.getElementById('closeCameraDescModal');
        const cancelCameraDesc = document.getElementById('cancelCameraDesc');
        const confirmCameraDesc = document.getElementById('confirmCameraDesc');
        const cameraDescText = document.getElementById('cameraDescText');
        const imageDescModal = document.getElementById('imageDescModal');
        const closeImageDescModal = document.getElementById('closeImageDescModal');
        const imageDescText = document.getElementById('imageDescText');
        let pendingImageDesc = null;
        
        voiceInputBtn.addEventListener('click', () => {
            voiceText.value = '';
            voiceModal.style.display = 'flex';
            voiceText.focus();
        });
        
        closeVoiceModal.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });
        
        cancelVoiceInput.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });
        
        confirmVoiceInput.addEventListener('click', () => {
            const message = voiceText.value.trim();
            if (message) {
                chatInput.value = message;
                chatInput.dataset.isVoice = 'true';
                voiceModal.style.display = 'none';
                if (chatSession) chatSession.sendMessage();
            }
        });
        
        // 点击模态框背景关闭
        voiceModal.addEventListener('click', (e) => {
            if (e.target === voiceModal) {
                voiceModal.style.display = 'none';
            }
        });
        function getImageDescPlaceholderData() {
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f3f3f5"/>
      <stop offset="1" stop-color="#e7e7eb"/>
    </linearGradient>
  </defs>
  <rect width="240" height="240" rx="24" fill="url(#g)"/>
  <circle cx="80" cy="90" r="26" fill="#d7d7de"/>
  <path d="M40 180 L110 120 L150 160 L200 120 L220 180 Z" fill="#d0d0d8"/>
</svg>`;
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
        }

        if (cameraInputBtn && cameraDescModal) {
            cameraInputBtn.addEventListener('click', () => {
                if (cameraDescText) cameraDescText.value = '';
                cameraDescModal.style.display = 'flex';
                if (cameraDescText) cameraDescText.focus();
            });
        }

        if (closeCameraDescModal) {
            closeCameraDescModal.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (cancelCameraDesc) {
            cancelCameraDesc.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (confirmCameraDesc) {
            confirmCameraDesc.addEventListener('click', () => {
                const desc = cameraDescText ? cameraDescText.value.trim() : '';
                if (!desc) return;
                chatInput.value = desc;
                chatInput.dataset.imageData = getImageDescPlaceholderData();
                chatInput.dataset.imageName = '描述图';
                chatInput.dataset.imageText = desc;
                chatInput.dataset.isVoice = 'false';
                if (chatSession) chatSession.sendMessage();
                cameraDescModal.style.display = 'none';
            });
        }

        if (cameraDescModal) {
            cameraDescModal.addEventListener('click', (e) => {
                if (e.target === cameraDescModal) {
                    cameraDescModal.style.display = 'none';
                }
            });
        }

        function closeImageDesc() {
            if (!imageDescModal) return;
            imageDescModal.style.display = 'none';
            pendingImageDesc = null;
        }

        window.openImageDescModal = (messageWrapper, msgId, content) => {
            if (!imageDescModal || !imageDescText) return;
            imageDescText.value = content || '';
            pendingImageDesc = { messageWrapper, msgId };
            imageDescModal.style.display = 'flex';
        };

        if (closeImageDescModal) {
            closeImageDescModal.addEventListener('click', closeImageDesc);
        }

        if (imageDescModal) {
            imageDescModal.addEventListener('click', (e) => {
                if (e.target === imageDescModal) {
                    closeImageDesc();
                }
            });
        }
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (chatSession) chatSession.sendMessage();
            }
        });
        
        // ========== 初始化 ==========

        const appCatalog = [
            { id: 'message', name: '消息', iconClass: 'fa-envelope', styleClass: 'message-icon' },
            { id: 'feixin', name: '甜聊', iconClass: 'fa-comment-dots', styleClass: 'feixin-icon' },
            { id: 'worldbook', name: '世界书', iconClass: 'fa-book-open', styleClass: 'book-icon' },
            { id: 'settings', name: '设置', iconClass: 'fa-cog', styleClass: 'settings-icon' },
            { id: 'beautify', name: '美化', iconClass: 'fa-paint-brush', styleClass: 'brush-icon' },
            { id: 'phone', name: '手机', iconClass: 'fa-mobile-alt', styleClass: 'phone-icon' },
            { id: 'novel', name: '小说', iconClass: 'fa-book', styleClass: 'novel-icon' },
            { id: 'forum', name: '论坛', iconClass: 'fa-comments', styleClass: 'forum-icon' }
        ];

        function renderHomeApps() {
            if (!appGrid) return;
            const selected = APP_ENTRY_POINTS.home || [];
            appGrid.innerHTML = '';
            selected.forEach(appId => {
                const app = appCatalog.find(item => item.id === appId);
                if (!app) return;

                const item = document.createElement('div');
                item.className = 'app-item';
                item.dataset.appId = app.id;

                const icon = document.createElement('div');
                icon.className = `app-icon ${app.styleClass}`;
                icon.innerHTML = `<i class="fas ${app.iconClass}"></i>`;

                const name = document.createElement('div');
                name.className = 'app-name';
                name.textContent = app.name;

                item.appendChild(icon);
                item.appendChild(name);

                item.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });

                item.addEventListener('click', () => {
                    handleAppClick(app.id);
                });

                appGrid.appendChild(item);
            });
        }

        function registerApps() {
            if (!window.appManager || typeof window.appManager.register !== 'function') return;
            appCatalog.forEach(app => {
                try {
                    window.appManager.register(app.id, {
                        name: app.name,
                        icon: app.iconClass,
                        version: '1.0.0'
                    });
                } catch (e) {
                    // 已注册时忽略
                }
            });
        }
        
        // ========== 隐藏状态栏功能 ==========
        function initHideStatusBar() {
            const hideStatusBarToggle = document.getElementById('hideStatusBarToggle');
            if (!hideStatusBarToggle) return;

            // 从 localStorage 读取状态
            const isHidden = localStorage.getItem('hideStatusBar') === 'true';
            hideStatusBarToggle.checked = isHidden;

            // 应用初始状态
            if (isHidden) {
                document.body.classList.add('hide-status-bar');
            }

            // 监听开关变化
            hideStatusBarToggle.addEventListener('change', (e) => {
                const checked = e.target.checked;
                localStorage.setItem('hideStatusBar', checked);

                if (checked) {
                    document.body.classList.add('hide-status-bar');
                } else {
                    document.body.classList.remove('hide-status-bar');
                }
            });
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            friendSystem = new FriendSystem();
            apiService = new ApiService(friendSystem);
            chatSession = new ChatSession(friendSystem, apiService);
            heartVoiceSystem = new HeartVoiceSystem(friendSystem, apiService);
            profileWidget = new ProfileWidget();

            registerApps();
            renderHomeApps();
            loadGreetingText();
            if (greetingText) {
                greetingText.addEventListener('click', enableGreetingEdit);
                greetingText.addEventListener('blur', saveGreetingText);
                greetingText.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        greetingText.blur();
                    }
                });
            }
            if (window.appManager && typeof window.appManager.setStatus === 'function') {
                window.appManager.setStatus({
                    signal: 'fa-signal',
                    wifi: 'fa-wifi',
                    battery: 'fa-battery-three-quarters'
                });
            }
            if (friendSystem) {
                friendSystem.init();
            }

            // ========== 虚拟键盘自动滚动功能 ==========
            // 当虚拟键盘弹出时，自动滚动聊天内容，确保输入框可见且能看到最新消息
            let initialViewportHeight = window.innerHeight;
            let isKeyboardOpen = false;

            // 监听输入框焦点事件
            if (chatInput) {
                chatInput.addEventListener('focus', () => {
                    isKeyboardOpen = true;
                    // 延迟执行，等待键盘完全弹出
                    setTimeout(() => {
                        if (chatMessages) {
                            // 滚动到最新消息
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        // 确保输入框可见
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                });

                chatInput.addEventListener('blur', () => {
                    isKeyboardOpen = false;
                    // 键盘收起后恢复原样
                    setTimeout(() => {
                        initialViewportHeight = window.innerHeight;
                    }, 300);
                });
            }

            // 监听窗口大小变化（键盘弹出/收起会改变viewport高度）
            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;

                // 如果高度变小且输入框有焦点，说明键盘弹出
                if (currentHeight < initialViewportHeight && document.activeElement === chatInput) {
                    if (chatMessages) {
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 100);
                    }
                }
                // 如果高度恢复且输入框失去焦点，说明键盘收起
                else if (currentHeight > initialViewportHeight && !isKeyboardOpen) {
                    initialViewportHeight = currentHeight;
                }
            });
            // ========== 虚拟键盘自动滚动功能结束 ==========
            if (apiService) apiService.updateSettingsDisplay();
            if (profileWidget) profileWidget.init();

            // 初始化隐藏状态栏功能
            initHideStatusBar();
            
            // 为所有图标添加悬停效果
            const allIcons = document.querySelectorAll('.app-icon, .dock-icon, .left-icon, .app-item');
            allIcons.forEach(icon => {
                icon.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });
            });
            
            // 加载已保存的模型列表
            if (apiService) {
                const config = apiService.getConfig();
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            }
        });
})();
    </script>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>芋圆机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: #FFFFFF;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        @keyframes fade-in-scale {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s ease-out forwards;
        }
        
        .iphone-container {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            background-color: #f8f5f9;
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .status-bar {
            height: 50px;
            background-color: #f8f5f9;
            padding: 0 26px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #787785;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 1px solid rgba(120,119,133,0.1);
        }
        
        .time {
            font-weight: 700;
        }
        
        .status-icons i {
            margin-left: 6px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-overflow-scrolling: touch;
        }

        .home-screen {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .frost-widget {
            width: 88%;
            height: 120px;
            background: #f6f2f1;
            border-radius: 26px;
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: 0 12px 30px rgba(120, 119, 133, 0.08);
        }

        .widget-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #787785;
        }

        .widget-weather {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .widget-weather i {
            color: #debeeb;
            font-size: 22px;
        }

        .widget-temp {
            font-size: 22px;
            font-weight: 700;
            color: #debeeb;
        }

        .widget-greeting {
            font-size: 14px;
            color: #787785;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .widget-greeting:focus {
            outline: none;
            background: #FFFFFF;
            color: #787785;
        }


        .home-header {
            width: 88%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .home-title {
            font-size: 15px;
            font-weight: 600;
            color: #787785;
        }
        
        .avatar-section {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            z-index: 2;
        }
        
        .avatar {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid white;
            box-shadow: 0 6px 16px rgba(120, 119, 133, 0.12);
            z-index: 3;
            overflow: hidden;
        }
        
        .avatar i {
            font-size: 40px;
            color: white;
        }
        
        .info-card {
            width: 90%;
            height: 100px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            position: absolute;
            top: 40px;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 15px;
        }
        
        .user-info {
            text-align: left;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 700;
            color: #787785;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 14px;
            color: #f0d6d7;
            font-weight: 500;
        }
        
        .icons-section {
            width: 90%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }
        
        .left-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 20px rgba(240, 214, 215, 0.3);
            color: white;
            font-size: 28px;
            cursor: pointer;
        }
        
        .right-icons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 15px;
            width: 130px;
        }
        
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }
        
        .app-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-grid {
            width: 88%;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-auto-rows: 100px;
            gap: 16px;
            justify-items: center;
            align-items: start;
        }

        .app-grid-offset {
            margin-top: 24px;
        }

        .app-item {
            width: 100%;
            max-width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
        }

        .app-item:hover .app-icon {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-name {
            font-size: 12px;
            color: #787785;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }



        .message-icon { background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); }
        .feixin-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        .book-icon { background: linear-gradient(135deg, #debeeb 0%, #f0d6d7 100%); }
        .settings-icon { background: linear-gradient(135deg, #debb7b 0%, #debb7b 100%); }
        .brush-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        
        .dock {
            height: 96px;
            min-height: 96px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.75) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(120, 119, 133, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 24px 16px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 -8px 24px rgba(120, 119, 133, 0.06);
        }
        
        .dock-icon {
            width: 75px;
            height: 75px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
            transition: transform 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }
        
        .dock-icon:hover {
            transform: scale(1.05);
        }
        
        .phone-icon { background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%); }
        .novel-icon { background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); }
        .forum-icon { background: linear-gradient(135deg, #debeeb 0%, #f0d6d7 100%); }
        
        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        /* API 配置弹窗全屏（手机内）样式 */
        #apiModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #apiModal .modal-header {
            border-bottom: 1px solid #f0f0f4;
            /* padding由统一适配逻辑控制 */
        }

        #apiModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 22px 26px;
        }

        #apiModal .form-control {
            border-radius: 14px;
        }

        #apiModal .btn {
            border-radius: 14px;
        }

        .model-picker {
            position: relative;
            width: 100%;
        }

        .model-picker-button {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border: 1px solid #ddd;
            border-radius: 14px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .model-picker-button:focus-visible {
            outline: none;
            border-color: #f0d6d7;
            box-shadow: 0 0 0 2px rgba(240, 214, 215, 0.12);
        }

        .model-picker-button .caret {
            margin-left: 10px;
            font-size: 12px;
            color: #999;
        }

        .model-picker-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            max-height: 260px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 14px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .model-picker-list.is-open {
            display: block;
        }

        .model-picker-item {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .model-picker-item:hover {
            background: #f6f2f1;
        }

        .model-picker-item.is-selected {
            background: rgba(240, 214, 215, 0.2);
            color: #f0d6d7;
            font-weight: 600;
        }
        
        /* 聊天模态窗口全屏样式 */
        #chatModal {
            position: fixed;
            background-color: transparent;
            justify-content: center;
            align-items: center;
        }
        
        #chatModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
            animation: none;
            overflow: hidden;
            position: relative;
        }
        
        #chatModal .modal-header {
            background-color: #FFFFFF;
            border-bottom: 1px solid #f6f2f1;
            display: flex;
            align-items: center;
            /* padding和height由统一适配逻辑控制 */
        }
        
        #chatModal .modal-header h3 {
            flex: 1;
            text-align: center;
            margin: 0;
            color: #787785;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* API警告样式 */
        .api-warning {
            background-color: #fff3cd;
            border-bottom: 1px solid #ffc107;
            padding: 12px 20px;
            color: #856404;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-close:hover {
            background-color: #f5f5f5;
        }

        .cute-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: cute-toast-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cute-toast-pop {
            from {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .cute-toast-content {
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            padding: 28px 48px;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(222, 190, 235, 0.3);
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .cute-toast-content p {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* 聊天窗口按钮样式 */
        #backToFriendList {
            background: none;
            border: none;
            font-size: 24px;
            color: #787785;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            margin-right: 10px;
        }

        #backToFriendList:hover {
            background-color: #f6f2f1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #787785;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            height: 44px;
            padding: 0 15px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        textarea.form-control {
            height: auto;
            padding: 12px 15px;
            min-height: 44px;
        }

        #modelSelect {
            height: 44px;
            background-color: #fff;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #f0d6d7;
            box-shadow: 0 0 0 2px rgba(240, 214, 215, 0.1);
        }
        
        .input-hint {
            margin-top: 6px;
            color: #999;
            font-size: 12px;
        }
        
        .btn {
            padding: 12px 20px;
            height: 48px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }
        
        .btn-secondary {
            background-color: #f6f2f1;
            color: #787785;
        }

        .btn-secondary:hover {
            background-color: #f0d6d7;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* 状态消息样式 */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-message.success {
            background-color: rgba(72, 187, 120, 0.1);
            color: #48bb78;
            border: 1px solid rgba(72, 187, 120, 0.2);
            display: block;
        }
        
        .status-message.error {
            background-color: rgba(245, 101, 101, 0.1);
            color: #f56565;
            border: 1px solid rgba(245, 101, 101, 0.2);
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f6f2f1;
            border-top: 2px solid #f0d6d7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 聊天界面样式 */
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #f6f2f1;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #FFFFFF;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background-color: #f0d6d7;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background-color: #debeeb;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .reply-quote {
            max-width: 80%;
            font-size: 12px;
            color: #666;
            background: rgba(0, 0, 0, 0.06);
            padding: 6px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid rgba(0, 0, 0, 0.12);
            word-break: break-word;
        }

        .reply-quote.user {
            margin-left: auto;
        }

        .reply-quote.ai {
            margin-right: auto;
        }

        .reply-preview {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            background: #f5f5f5;
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .reply-preview-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-preview-close {
            border: none;
            background: transparent;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .image-upload-pill {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: #f6f2f1;
            color: #f0d6d7;
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px dashed rgba(240, 214, 215, 0.35);
        }

        .image-upload-thumb {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .image-upload-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-upload-close {
            border: none;
            background: transparent;
            color: #f0d6d7;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .message-image {
            display: block;
            width: 100%;
            max-width: 220px;
            border-radius: 12px;
            margin-top: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .message-image-wrap {
            position: relative;
            display: inline-block;
            margin-top: 6px;
            border-radius: 12px;
            overflow: hidden;
        }

        .message-image-wrap.user {
            margin-left: auto;
        }

        .message-image-wrap.ai {
            margin-right: auto;
        }

        .message-image.desc-thumb {
            width: 120px;
            height: 120px;
            max-width: none;
            object-fit: cover;
            border-radius: 12px;
        }

        .message-image-hint {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
            pointer-events: none;
        }

        .image-desc-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 12px;
            resize: none;
            height: 110px;
            font-size: 14px;
            font-family: inherit;
            background: #fafafa;
            color: #333;
        }

        .image-confirm-popover {
            position: fixed;
            display: none;
            z-index: 2300;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            font-size: 12px;
            color: #444;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .image-confirm-actions {
            display: flex;
            gap: 8px;
        }

        .image-confirm-btn {
            border: none;
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .image-confirm-btn.yes {
            background: #f0d6d7;
            color: #fff;
        }

        .image-confirm-btn.no {
            background: #f0f0f0;
            color: #666;
        }

        .message-recalled-wrapper {
            display: flex;
            justify-content: center;
        }

        .message-recalled {
            font-size: 12px;
            color: #999;
            background: rgba(0, 0, 0, 0.06);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .message-action-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2200;
            background: rgba(0, 0, 0, 0.05);
        }

        .message-action-menu {
            position: absolute;
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.14);
            transform: scale(0.96);
            opacity: 0;
            transition: transform 0.16s ease, opacity 0.16s ease;
        }

        .message-action-menu.is-open {
            transform: scale(1);
            opacity: 1;
        }

        .message-action-item {
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: #333;
            border-radius: 12px;
            padding: 6px 8px;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }

        .message-action-item i {
            font-size: 16px;
        }

        .message-action-item:active {
            transform: scale(0.95);
        }

        .message-action-item.is-disabled {
            opacity: 0.45;
            pointer-events: none;
        }
        
        .chat-input-area {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input-area-wrap.chat-extra-open .chat-input-row {
            display: none !important;
        }

        .chat-input-area-wrap.chat-extra-open .chat-function-row {
            display: none !important;
        }

        .chat-extra-panel {
            display: none;
            margin-top: 8px;
            padding: 12px 10px;
            border-radius: 14px;
            background: #f6f6f7;
            border: 1px solid #eee;
        }

        .chat-extra-panel.is-open {
            display: block;
        }

        .chat-extra-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px 10px;
        }

        .chat-extra-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 6px;
            border-radius: 14px;
            background: #fff;
            border: 1px solid #f0f0f0;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .chat-extra-item.is-placeholder {
            background: #fafafa;
            border-style: dashed;
            color: #bbb;
            cursor: default;
            box-shadow: none;
        }

        .chat-extra-item.is-placeholder .chat-extra-icon {
            background: #f1f1f1;
            color: #bbb;
        }

        .chat-extra-item:active {
            transform: scale(0.98);
        }

        .chat-extra-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .chat-extra-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 20px;
        }
        
        .chat-send-btn {
            padding: 0 20px;
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        /* 刘海模拟 */
        .notch {
            display: none;
        }
        
        /* 好友列表样式 */
        .friend-list {
            max-height: 100%;
            overflow-y: auto;
            padding: 16px !important;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            background: #fff;
            backdrop-filter: none;
            box-shadow: 0 2px 8px rgba(120, 119, 133, 0.05);
            cursor: pointer;
            transition: background 0.15s ease;
            border: none;
        }

        .friend-item:hover {
            background: #f6f2f1;
            transform: none;
            box-shadow: 0 2px 12px rgba(120, 119, 133, 0.08);
        }

        .friend-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(240, 214, 215, 0.1);
        }
        
        .friend-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            margin-right: 14px;
            overflow: hidden;
            box-shadow: none;
            flex-shrink: 0;
            border: none;
        }
        
        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: 600;
            color: #787785;
            margin-bottom: 5px;
            font-size: 15px;
            letter-spacing: 0;
        }

        .friend-persona {
            color: #787785;
            font-size: 13px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .no-friends {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 40px 20px;
            text-align: center;
        }
        
        /* 头像上传样式 */
        .avatar-upload-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: #fafafa;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            margin-bottom: 15px;
            color: #999;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .avatar-upload-preview:hover {
            border-color: #f0d6d7;
            background-color: #f6f2f1;
        }
        
        .avatar-upload-preview i {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .avatar-upload-preview p {
            font-size: 14px;
            margin: 0;
        }
        
        .avatar-upload-preview.has-image {
            background-color: transparent;
            border-color: transparent;
        }
        
        .avatar-upload-preview.has-image i,
        .avatar-upload-preview.has-image p {
            display: none;
        }

        .profile-widget-card {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.2s ease;
        }

        .profile-widget-feedback {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .profile-widget-feedback.is-active {
            opacity: 1;
        }

        .settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: linear-gradient(180deg, #FFFFFF 0%, #f6f2f1 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .settings-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 16px;
            border-bottom: 1px solid #f6f2f1;
            background: #fff;
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #787785;
        }

        .settings-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            font-size: 14px;
            color: #787785;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 8px;
            min-height: 40px;
        }

        .settings-back:hover {
            background: #f6f2f1;
        }

        .settings-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .friend-list-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 8px;
        }

        .friend-list-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #787785;
            font-size: 12px;
            flex: 1;
        }

        .friend-list-nav-item i {
            font-size: 24px;
        }

        .friend-list-nav-item.active {
            color: #f0d6d7;
        }

        .friend-list-nav-item:active {
            opacity: 0.7;
        }

        .settings-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid #f0f0f0;
            min-height: 68px;
        }

        .settings-card:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
        }

        .settings-card-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #787785;
        }

        .settings-card-desc {
            font-size: 12px;
            color: #787785;
        }

        .friend-settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: #f6f2f1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .friend-settings-nav {
            background: #fff;
            padding-right: 16px;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .friend-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #787785;
            flex: 1;
            text-align: center;
        }

        .friend-settings-back {
            background: none;
            border: none;
            font-size: 22px;
            color: #787785;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .friend-settings-back:hover {
            background: #f6f2f1;
        }

        .friend-settings-spacer {
            width: 32px;
            height: 32px;
        }

        .friend-settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .friend-settings-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .friend-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .friend-settings-label {
            font-size: 14px;
            font-weight: 600;
            color: #787785;
        }

        .friend-settings-desc {
            font-size: 12px;
            color: #787785;
        }

        .friend-settings-input,
        .friend-settings-select,
        .friend-settings-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            background: #fff;
        }

        .friend-settings-textarea {
            resize: vertical;
            min-height: 110px;
        }

        .friend-settings-details {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fafafa;
        }

        .friend-settings-details summary {
            list-style: none;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .friend-settings-details summary::-webkit-details-marker {
            display: none;
        }

        .friend-settings-details summary::after {
            content: '›';
            transform: rotate(90deg);
            font-size: 16px;
            color: #aaa;
        }

        .friend-settings-details[open] summary::after {
            transform: rotate(-90deg);
        }

        .voice-status {
            font-size: 12px;
            color: #f0d6d7;
            background: rgba(240, 214, 215, 0.12);
            padding: 4px 10px;
            border-radius: 999px;
        }

        .ios-switch {
            position: relative;
            width: 44px;
            height: 26px;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #d1d5db;
            border-radius: 999px;
            transition: 0.2s ease;
        }

        .ios-slider::before {
            position: absolute;
            content: '';
            height: 22px;
            width: 22px;
            left: 2px;
            top: 2px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: 0.2s ease;
        }

        .ios-switch input:checked + .ios-slider {
            background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%);
        }

        .ios-switch input:checked + .ios-slider::before {
            transform: translateX(18px);
        }

        .friend-avatar-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-bottom: 10px;
        }

        .friend-avatar-display {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: linear-gradient(135deg, #debeeb 0%, #debeeb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 40px;
            border: 4px solid #fff;
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.08);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-avatar-display:hover {
            transform: scale(1.08);
            box-shadow: 0 12px 28px rgba(222, 190, 235, 0.2);
        }

        .friend-avatar-display::after {
            content: '点击更换';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .friend-avatar-display:hover::after {
            opacity: 1;
        }

        .friend-avatar-display.has-image i {
            display: none;
        }

        .friend-avatar-btn {
            padding: 8px 20px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }

        .friend-avatar-btn:hover {
            border-color: #f0d6d7;
            color: #f0d6d7;
        }

        .settings-card-meta {
            display: flex;
            gap: 14px;
            font-size: 12px;
            color: #999;
        }

        .settings-status {
            font-size: 12px;
            font-weight: 600;
            color: #f56565;
        }

        .settings-status.ok {
            color: #48bb78;
        }

        .settings-arrow {
            font-size: 16px;
            color: #bbb;
        }

        .data-manage-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .data-manage-item {
            width: 100%;
            padding: 12px 14px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #eee;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .data-manage-item:hover {
            background: #f7f7fb;
        }

        #triggerAiBtn:hover {
            transform: scale(1.08);
            background-color: #f6f2f1 !important;
        }
        #triggerAiBtn:active {
            transform: scale(0.95);
        }

        /* 心声弹窗样式 */
        .heart-voice-popup {
            position: absolute;
            top: 91px;
            right: 12px;
            width: 240px;
            max-width: calc(100% - 24px);
            background: #fff;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(120, 119, 133, 0.1);
            padding: 24px;
            z-index: 2100;
            display: none;
            border: none;
            flex-direction: column;
            gap: 18px;
            transform-origin: top right;
            animation: hv-popup-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes hv-popup-out {
            0% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(0.95) translateY(-10px); }
        }

        .heart-voice-popup.closing {
            animation: hv-popup-out 0.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            pointer-events: none;
        }

        @keyframes hv-popup-in {
            0% { opacity: 0; transform: scale(0.92) translateY(-8px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .heart-voice-popup.is-open {
            display: flex;
        }

        .heart-voice-text {
            font-size: 15px;
            color: #787785;
            line-height: 1.6;
            word-wrap: break-word;
            font-weight: 500;
        }

        .heart-voice-status {
            font-size: 13px;
            color: #787785;
            line-height: 1.5;
        }

        .heart-voice-mood-bar {
            height: 4px;
            background: #f6f2f1;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .heart-voice-mood-fill {
            height: 100%;
            background: linear-gradient(90deg, #debeeb, #f0d6d7);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .heart-voice-mood-label {
            font-size: 12px;
            color: #787785;
            text-align: left;
            margin-top: 6px;
            font-weight: 500;
        }

        .hv-label {
            color: #debeeb;
            font-weight: bold;
            margin-right: 4px;
        }

        /* 心声历史列表样式 */
        .hv-history-item {
            padding: 16px 18px;
            margin: 0 16px 10px;
            background: #f6f2f1;
            border-radius: 16px;
            box-shadow: none;
            border: 1px solid #f6f2f1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        .hv-history-item.selected {
            border-color: #f0d6d7;
            background-color: #FFFFFF;
        }
        .hv-history-item.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            color: #f0d6d7;
            font-weight: bold;
            font-size: 14px;
        }
        .hv-history-item:active {
            transform: scale(0.97);
            background-color: #f6f2f1;
        }
        .hv-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hv-history-time {
            font-size: 12px;
            color: #787785;
            font-weight: 500;
        }
        .hv-history-mood {
            font-size: 11px;
            color: #debeeb;
            background: rgba(222, 190, 235, 0.15);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        .hv-history-content {
            font-size: 14px;
            color: #787785;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        /* 移动端全屏适配 (PWA/Add to Home Screen) */
        @media screen and (max-width: 500px) {
            body {
                padding: 0;
                background: #f8f5f9;
                align-items: flex-start;
            }

            .iphone-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                background-color: #f8f5f9;
            }

            .status-bar {
                padding-top: env(safe-area-inset-top);
                height: auto;
                min-height: 44px;
                padding-bottom: 5px;
            }

            .dock {
                padding-bottom: env(safe-area-inset-bottom);
                height: auto;
                min-height: 90px;
                border-radius: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            /* 修复模态框在移动端的显示 - 仿照主页面大小 */
            .modal {
                padding: 0;
                background-color: transparent;
            }

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }

            #chatModal .modal-header,
            #apiModal .modal-header,
            .settings-nav,
            .friend-settings-nav {
                padding-top: 8px !important;
                padding-left: 12px !important;
                padding-right: 12px !important;
                height: 44px !important;
                min-height: 44px !important;
            }

            /* 移动端返回栏样式由全局规则统一管理 */
        }

        /* 非移动端：弹窗页面仿照主页面大小 */
        @media screen and (min-width: 501px) {
            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 430px;
                height: 90vh;
                max-height: 932px;
                border-radius: 40px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            }
        }

        /* 隐藏状态栏功能 */
        body.hide-status-bar .status-bar {
            display: none !important;
        }

        /* 当状态栏隐藏时，容器顶部不添加padding，让返回栏从顶部开始 */
        @media screen and (max-width: 500px) {
            body.hide-status-bar .screen-content,
            body.hide-status-bar .home-screen,
            body.hide-status-bar .settings-screen,
            body.hide-status-bar .friend-settings-screen,
            body.hide-status-bar #chatModal .modal-content,
            body.hide-status-bar #apiModal .modal-content {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }
        }

        /* ========== 统一页面适配逻辑 ========== */

        /* 1. 所有弹窗页面添加box-sizing，防止margin-top额外撑开高度 */
        #chatModal .modal-content,
        #apiModal .modal-content,
        .settings-screen,
        .friend-settings-screen {
            box-sizing: border-box;
            margin-top: 0;
        }

        /* 2. 状态栏显示/隐藏联动（仅作用于弹窗页面） */
        /* 显示状态栏时：弹窗页面的.status-bar显示 */
        body:not(.hide-status-bar) #chatModal .status-bar,
        body:not(.hide-status-bar) #apiModal .status-bar,
        body:not(.hide-status-bar) .settings-screen .status-bar,
        body:not(.hide-status-bar) .friend-settings-screen .status-bar,
        body:not(.hide-status-bar) .worldbookModal .status-bar {
            display: flex !important;
        }

        /* 隐藏状态栏时：弹窗页面的.status-bar隐藏 */
        body.hide-status-bar #chatModal .status-bar,
        body.hide-status-bar #apiModal .status-bar,
        body.hide-status-bar .settings-screen .status-bar,
        body.hide-status-bar .friend-settings-screen .status-bar,
        body.hide-status-bar .worldbookModal .status-bar {
            display: none !important;
        }

        /* 3. 统一所有弹窗页面的返回栏位置 */
        #chatModal .modal-header,
        #apiModal .modal-header,
        .settings-nav,
        .friend-settings-nav {
            padding-top: 8px !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
            height: 44px !important;
            min-height: 44px !important;
            border-bottom: 1px solid rgba(120, 119, 133, 0.1) !important;
        }

        /* 4. 确保主屏幕完全不受影响（明确保留原有样式） */
        .home-screen {
            margin-top: 0 !important;
        }

        body.hide-status-bar .home-screen {
            margin-top: 0 !important;
        }

        /* 5. 修复弹窗页面顶部空白 */
        /* 确保弹窗页面从顶部开始，无多余间距 */
        #chatModal .modal-content,
        #apiModal .modal-content,
        .settings-screen,
        .friend-settings-screen {
            padding-top: 0 !important;
        }

        /* 6. 修复状态栏隐藏后返回按钮失效 */
        /* 隐藏状态栏时，确保弹窗页面从顶部开始，返回栏完全可见可交互 */
        body.hide-status-bar #chatModal .modal-content,
        body.hide-status-bar #apiModal .modal-content,
        body.hide-status-bar .settings-screen,
        body.hide-status-bar .friend-settings-screen {
            margin-top: 0 !important;
            padding-top: 0 !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* 隐藏状态栏时，返回栏应该在顶部，确保可见可交互 */
        body.hide-status-bar #chatModal .modal-header,
        body.hide-status-bar #apiModal .modal-header,
        body.hide-status-bar .settings-nav,
        body.hide-status-bar .friend-settings-nav {
            position: relative !important;
            top: 0 !important;
            background: #fff !important;
            z-index: 100 !important;
            flex-shrink: 0 !important;
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            height: 44px !important;
            min-height: 44px !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
            display: flex !important;
            align-items: center !important;
            border-bottom: 1px solid rgba(120, 119, 133, 0.1) !important;
        }

        /* 所有返回按钮确保可点击和高层级 */
        .settings-back,
        .friend-settings-back,
        #backToFriendList,
        #charSettingsBack,
        #settingsBack,
        #worldbookBack,
        #closeFriendListModal,
        #closeApiModal {
            z-index: 999 !important;
            pointer-events: auto !important;
            position: relative !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
        }

        /* 确保返回按钮区域可点击 */
        body.hide-status-bar .settings-back,
        body.hide-status-bar .friend-settings-back,
        body.hide-status-bar #backToFriendList,
        body.hide-status-bar #charSettingsBack {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* ========== 统一页面适配逻辑结束 ========== */

        /* 全局适配优化 */
        .iphone-container,
        .settings-screen,
        .friend-settings-screen,
        #chatModal .modal-content,
        #apiModal .modal-content {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 确保移动端全屏无滚动 */
        html, body {
            overflow: hidden;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* 统一焦点样式 */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus {
            outline: none;
        }

        /* 优化触摸反馈 */
        .btn:active,
        .settings-card:active,
        .friend-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        /* 全局隐藏滚动条（保持可滚动） */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="iphone-container">
        <!-- 刘海模拟 -->
        <div class="notch"></div>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div id="statusTime" class="time">14:30</div>
            <div class="status-icons">
                <i id="statusSignal" class="fas fa-signal"></i>
                <i id="statusWifi" class="fas fa-wifi"></i>
                <i id="statusBattery" class="fas fa-battery-three-quarters"></i>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="home-screen">
                <!-- 可自定义个人资料小组件 -->
                <div class="w-full flex justify-center">
                    <div id="profileWidgetV2" class="w-[88%] h-[340px] bg-white rounded-[32px] shadow-[0_15px_40px_rgba(0,0,0,0.08)] flex flex-col overflow-hidden relative mx-auto transition-all duration-300">
                        <!-- 顶部背景图区域 -->
                        <div id="profileWidgetCover" class="w-full h-[45%] bg-zinc-200 bg-cover bg-center relative cursor-pointer group">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                                <i class="fas fa-image text-white/0 group-hover:text-white/60 transition-all text-2xl drop-shadow-md"></i>
                            </div>
                        </div>
                        
                        <!-- 底部内容区域 -->
                        <div id="profileWidgetBottom" class="flex-1 bg-white bg-cover bg-center relative flex flex-col items-center pt-[52px] pb-5 px-6 cursor-pointer group/bottom transition-all duration-300">
                            <div class="absolute inset-0 bg-black/0 group-hover/bottom:bg-black/5 transition-colors pointer-events-none"></div>
                            
                            <!-- 头像 (悬浮在交界处) -->
                            <div class="absolute -top-[46px] left-1/2 -translate-x-1/2 z-20">
                                <button id="editProfileAvatarImage" data-no-bg-change class="w-[92px] h-[92px] rounded-full border-[5px] border-white bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-purple-100 overflow-hidden transition-transform active:scale-95" aria-label="编辑头像图片">
                                    <div class="w-full h-full rounded-full overflow-hidden relative bg-zinc-50">
                                        <img id="profileAvatarImage" src="" alt="Avatar" class="w-full h-full object-cover hidden" />
                                        <div id="profileAvatarImagePlaceholder" class="w-full h-full bg-purple-200 flex items-center justify-center" style="background-image: radial-gradient(#fff 15%, transparent 16%), radial-gradient(#fff 15%, transparent 16%); background-size: 10px 10px; background-position: 0 0, 5px 5px;">
                                            <i class="fas fa-user text-white text-3xl drop-shadow-sm"></i>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 姓名 -->
                            <div data-no-bg-change class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-1">
                                <div id="profileName" contenteditable="true" class="text-[22px] font-bold text-zinc-800 truncate tracking-tight outline-none cursor-text"></div>
                            </div>

                            <!-- Handle -->
                            <div data-no-bg-change class="w-full text-center rounded-lg px-2 py-0.5 hover:bg-gray-50/50 transition-colors relative z-10 mb-4">
                                <div id="profileHandle" contenteditable="true" class="text-[13px] text-gray-400 font-medium truncate outline-none cursor-text"></div>
                            </div>

                            <!-- 状态/Bio -->
                            <div data-no-bg-change class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-auto">
                                <div id="profileStatus" contenteditable="true" class="text-[14px] text-zinc-600 leading-relaxed line-clamp-2 outline-none cursor-text"></div>
                            </div>

                            <!-- 定位 (装饰性) -->
                            <div data-no-bg-change class="w-full flex items-center gap-1.5 text-zinc-300 text-xs font-semibold mt-4 select-none hover:text-purple-300 transition-colors relative z-10 justify-center">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="profileLocation" contenteditable="true" class="outline-none min-w-[20px] cursor-text">Seoul</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 应用入口区域 -->
                <div id="appGrid" class="app-grid app-grid-offset"></div>

            </div>
        </div>
        
        <!-- Dock栏 -->
        <div class="dock">
            <div class="dock-icon phone-icon" id="phoneIcon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="dock-icon novel-icon" id="novelIcon">
                <i class="fas fa-book"></i>
            </div>
            <div class="dock-icon forum-icon" id="forumIcon">
                <i class="fas fa-comments"></i>
            </div>
        </div>
    </div>

    <!-- 可爱提示框 -->
    <div class="cute-toast" id="cuteToast" style="display: none;">
        <div class="cute-toast-content">
            <p>等我⌯･3･⌯ಣ</p>
        </div>
    </div>

    <!-- API配置弹窗 -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="apiStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="apiStatusSignal" class="fas fa-signal"></i>
                    <i id="apiStatusWifi" class="fas fa-wifi"></i>
                    <i id="apiStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            
            <div class="modal-header">
                <h3>API 配置</h3>
                <button class="modal-close" id="closeApiModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiUrl">API 地址</label>
                    <input type="url" id="apiUrl" class="form-control" 
                           placeholder="https://api.openai.com/v1" 
                           value="https://api.openai.com/v1">
                </div>
                
                <div class="form-group">
                    <label for="apiKey">API 密钥</label>
                    <input type="password" id="apiKey" class="form-control" 
                           placeholder="请输入您的 API 密钥">
                </div>
                
                <div class="form-group">
                    <label>模型选择</label>
                    <div class="form-row">
                        <div class="form-group">
                            <button id="fetchModels" class="btn btn-secondary btn-small">
                                <span id="fetchBtnText">拉取模型列表</span>
                                <span id="fetchLoading" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <div class="model-picker">
                                <button type="button" id="modelPickerButton" class="model-picker-button" disabled>
                                    <span id="modelPickerText">请先拉取模型列表</span>
                                    <i class="fas fa-chevron-down caret"></i>
                                </button>
                                <div id="modelPickerList" class="model-picker-list" role="listbox"></div>
                            </div>
                            <select id="modelSelect" class="form-control" disabled style="display: none;">
                                <option value="">请先拉取模型列表</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="apiStatus" class="status-message"></div>
                
                <div class="form-actions">
                    <button id="testApi" class="btn btn-secondary">测试连接</button>
                    <button id="saveApi" class="btn btn-primary">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友列表弹窗 -->
    <div class="modal" id="friendListModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendListStatusSignal" class="fas fa-signal"></i>
                    <i id="friendListStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeFriendListModal" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: #f0d6d7;">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">好友列表</div>
                <button class="settings-back" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: #f0d6d7; width: 42px; text-align: center;" id="addFriendFromList">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="settings-scroll">
                <div id="friendList" class="friend-list" style="padding: 16px 20px;">
                    <!-- 好友列表将动态生成 -->
                </div>
                <div id="noFriends" class="no-friends">
                    <p style="color: #787785; text-align: center; padding: 30px;">暂无好友，点击右上角 + 添加好友</p>
                </div>
            </div>
            <div class="friend-list-nav">
                <div class="friend-list-nav-item active" data-nav="messages">
                    <i class="fas fa-comment"></i>
                    <span>消息</span>
                </div>
                <div class="friend-list-nav-item" data-nav="moments">
                    <i class="fas fa-circle"></i>
                    <span>动态</span>
                </div>
                <div class="friend-list-nav-item" data-nav="me">
                    <i class="fas fa-user-circle"></i>
                    <span>我</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友弹窗 -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加好友</h3>
                <button class="modal-close" id="closeAddFriendModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>头像</label>
                    <div id="avatarPreview" class="avatar-upload-preview">
                        <i class="fas fa-image"></i>
                        <p>点击选择头像</p>
                    </div>
                    <input type="file" id="avatarInput" class="form-control" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="friendName">昵称</label>
                    <input type="text" id="friendName" class="form-control" placeholder="输入好友昵称">
                </div>
                
                <div class="form-group">
                    <label for="friendPersona">人设</label>
                    <textarea id="friendPersona" class="form-control" placeholder="示例：温柔但有点毒舌的学姐，喜欢猫和甜食，遇事会先嘴硬后关心人。" rows="3" style="resize: vertical;" minlength="10" maxlength="1000"></textarea>
                    <div class="input-hint">必填，10-1000字，描述性格、背景或说话风格</div>
                </div>
                
                <div id="addFriendStatus" class="status-message"></div>
                
                <div class="form-actions">
                    <button id="cancelAddFriend" class="btn btn-secondary">取消</button>
                    <button id="confirmAddFriend" class="btn btn-primary">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天弹窗 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="chatStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="chatStatusSignal" class="fas fa-signal"></i>
                    <i id="chatStatusWifi" class="fas fa-wifi"></i>
                    <i id="chatStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- 导航栏 -->
            <div style="background-color: #FFFFFF; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f6f2f1; flex-shrink: 0;">
                <button id="backToFriendList" style="background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="chatTitle" style="margin: 0; color: #787785; font-size: 18px; font-weight: 700; flex: 1; text-align: center;">季燃</h3>
                <button id="heartVoiceBtn" style="background: none; border: none; font-size: 18px; color: #f0d6d7; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 18px;" aria-label="心声">
                    <i class="fas fa-heart"></i>
                </button>
                <button id="charSettingsBtn" style="background: none; border: none; font-size: 20px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div id="apiWarning" class="api-warning" style="display: none; background-color: #f6f2f1; border-bottom: 1px solid #debb7b; padding: 12px 20px; color: #debb7b; font-size: 13px; text-align: center;">
                ⚠️ 未配置API，请先进行API配置
            </div>
            
            <!-- 心声弹窗 -->
            <div id="heartVoicePopup" class="heart-voice-popup">
                <div id="heartVoiceText" class="heart-voice-text">正在探听心声...</div>
                <div id="heartVoiceStatus" class="heart-voice-status"></div>
                <div>
                    <div class="heart-voice-mood-bar"><div id="heartVoiceMoodFill" class="heart-voice-mood-fill"></div></div>
                    <div id="heartVoiceMoodLabel" class="heart-voice-mood-label">心情 0%</div>
                </div>
                <!-- 新增：历史记录入口 -->
                <div style="text-align: right; padding-top: 12px; border-top: 1px solid #f6f2f1;">
                    <button id="heartVoiceHistoryBtn" style="font-size: 12px; color: #debeeb; background: none; border: none; cursor: pointer; padding: 4px 0; font-weight: 500;">查看历史 <i class="fas fa-chevron-right" style="font-size: 10px; margin-left: 2px;"></i></button>
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="chat-messages" id="chatMessages" style="flex: 1; overflow-y: auto; border: none; padding: 15px 12px; background-color: #FFFFFF;">
                <div class="message ai">
                    你好！我是AI助手，请问有什么可以帮助你的吗？
                </div>
            </div>
            
            <!-- 输入框区域 -->
            <div style="background-color: #FFFFFF; border-top: 1px solid #f6f2f1; flex-shrink: 0;">
                <div id="chatInputAreaWrap" class="chat-input-area-wrap" style="padding: 8px 12px 10px;">
                    <div id="replyPreview" class="reply-preview">
                        <span id="replyPreviewText" class="reply-preview-text"></span>
                        <button id="replyPreviewClose" class="reply-preview-close" type="button">×</button>
                    </div>
                    <div id="imageUploadPill" class="image-upload-pill">
                        <img id="imageUploadThumb" class="image-upload-thumb" alt="图片预览" />
                        <span id="imageUploadName" class="image-upload-name">已选择图片</span>
                        <button id="imageUploadClose" class="image-upload-close" type="button">×</button>
                    </div>
                    <!-- 功能栏 -->
                    <div class="chat-function-row" style="display: flex; justify-content: space-around; padding: 8px 0;">
                        <button id="voiceInputBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-microphone"></i></button>
                        <button id="imageUploadBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image"></i></button>
                        <button id="cameraInputBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-camera"></i></button>
                        <button style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-laugh"></i></button>
                        <button id="chatPlusBtn" style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-plus-circle"></i></button>
                    </div>
                    
                    <div class="chat-input-row" style="display: flex; gap: 8px; margin-bottom: 6px; align-items: flex-end;">
                        <button id="triggerAiBtn" style="width: 38px; height: 38px; padding: 0; border-radius: 50%; flex-shrink: 0; background: #f6f2f1; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(120,119,133,0.05); display: flex; align-items: center; justify-content: center; color: #debeeb;" aria-label="呼唤AI">
                            <i class="fas fa-wand-magic-sparkles" style="font-size: 18px;"></i>
                        </button>
                        <textarea class="chat-input" id="chatInput" 
                                  placeholder="输入消息..." 
                                  rows="1"
                                  style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; resize: none; font-size: 14px;"></textarea>
                        <button class="chat-send-btn" id="sendMessage" style="width: 40px; height: 40px; padding: 0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="chatExtraPanel" class="chat-extra-panel" aria-hidden="true">
                        <div class="chat-extra-grid">
                            <button type="button" class="chat-extra-item" aria-label="总结">
                                <span class="chat-extra-icon"><i class="fas fa-clipboard-list"></i></span>
                                <span class="chat-extra-label">总结</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="红包">
                                <span class="chat-extra-icon"><i class="fas fa-gift"></i></span>
                                <span class="chat-extra-label">红包</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="转账">
                                <span class="chat-extra-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span class="chat-extra-label">转账</span>
                            </button>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                        </div>
                    </div>
                    <input id="imageInput" type="file" accept="image/*" style="display: none;" />
                    <div id="imageConfirmPopover" class="image-confirm-popover">
                        <span>发送图片？</span>
                        <div class="image-confirm-actions">
                            <button id="imageConfirmYes" class="image-confirm-btn yes" type="button">是</button>
                            <button id="imageConfirmNo" class="image-confirm-btn no" type="button">否</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="chatStatus" class="status-message" style="margin: 0; border-radius: 0;"></div>
        </div>
    </div>

    <!-- 消息长按操作菜单 -->
    <div id="messageActionOverlay" class="message-action-overlay">
        <div id="messageActionMenu" class="message-action-menu">
            <button class="message-action-item" id="messageActionCopy" type="button">
                <i class="fas fa-copy"></i>
                <span>复制</span>
            </button>
            <button class="message-action-item" id="messageActionDelete" type="button">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </button>
            <button class="message-action-item" id="messageActionRecall" type="button">
                <i class="fas fa-rotate-left"></i>
                <span>撤回</span>
            </button>
            <button class="message-action-item" id="messageActionReply" type="button">
                <i class="fas fa-reply"></i>
                <span>引用</span>
            </button>
        </div>
    </div>

    <!-- 语音输入模态框 -->
    <div class="modal" id="voiceModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeVoiceModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">语音输入</h3>
            
            <div style="margin-bottom: 20px;">
                <textarea id="voiceText" placeholder="输入或说出的文字..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="cancelVoiceInput" style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmVoiceInput" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片描述模态框 -->
    <div class="modal" id="cameraDescModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeCameraDescModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">图片描述</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="cameraDescText" placeholder="描述图片内容..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelCameraDesc" style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmCameraDesc" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片内容弹窗 -->
    <div class="modal" id="imageDescModal" style="display: none; z-index: 2000;">
        <div style="background-color: white; border-radius: 15px; width: 85%; max-width: 320px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <button id="closeImageDescModal" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 12px 0; color: #787785; font-size: 16px; font-weight: 600;">图片内容</h3>

            <div style="margin-bottom: 18px;">
                <textarea id="imageDescText" class="image-desc-box" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div class="modal" id="confirmDeleteModal" style="z-index: 2001; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div style="background-color: white; border-radius: 30px; padding: 20px 25px; width: 75%; max-width: 240px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #787785; font-size: 15px; font-weight: 600;">确认删除？</h3>
            <p style="margin: 0 0 15px 0; color: #787785; font-size: 13px;">删除后将无法恢复</p>
            
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmDeleteYes" style="padding: 10px 25px; background-color: #d32f2f; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">是</button>
                <button id="confirmDeleteNo" style="padding: 10px 25px; background-color: white; color: #787785; border: 1px solid #f6f2f1; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">否</button>
            </div>
        </div>
    </div>

    <!-- 心声历史弹窗 -->
    <div class="modal" id="heartVoiceHistoryModal">
        <div class="modal-content" style="height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>心声历史</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="exportHeartVoiceHistoryBtn" style="background: none; border: none; color: #debeeb; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-image"></i> 导出
                    </button>
                    <button class="modal-close" id="closeHeartVoiceHistoryModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="heartVoiceHistoryList">
                    <!-- 历史记录将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 心声删除确认弹窗 -->
    <div class="modal" id="hvDeleteModal" style="z-index: 2200; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div style="background-color: white; border-radius: 24px; padding: 24px; width: 70%; max-width: 260px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); text-align: center; animation: fade-in-scale 0.2s ease-out;">
            <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px; font-weight: 600;">删除这条心声？</h3>
            <p style="margin: 0 0 20px 0; color: #999; font-size: 13px;">删除后无法找回哦</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="hvDeleteConfirm" style="flex: 1; padding: 10px 0; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">删除</button>
                <button id="hvDeleteCancel" style="flex: 1; padding: 10px 0; background-color: #f6f2f1; color: #787785; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">取消</button>
            </div>
        </div>
    </div>

    <!-- 好友设置弹窗 -->
    <div class="modal" id="charSettingsModal">
        <div class="modal-content friend-settings-screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendSettingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendSettingsStatusSignal" class="fas fa-signal"></i>
                    <i id="friendSettingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendSettingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="friend-settings-nav">
                <button id="charSettingsBack" class="friend-settings-back" aria-label="返回">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="friend-settings-title">好友设置</div>
                <span class="friend-settings-spacer"></span>
            </div>
            <div class="friend-settings-body">
                <div class="friend-avatar-wrap">
                    <div id="charAvatarDisplay" class="friend-avatar-display" aria-label="头像">
                        <i class="fas fa-user"></i>
                    </div>
                    <input type="file" id="charAvatarInput" accept="image/*" style="display: none;">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">好友昵称</div>
                    <input id="charNameInput" class="friend-settings-input" readonly>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">人设</div>
                    <textarea id="charPersonaInput" class="friend-settings-textarea" placeholder="描述性格、背景或说话风格"></textarea>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">世界书</div>
                    <details class="friend-settings-details">
                        <summary>点击展开选项列表</summary>
                        <div style="margin-top: 10px;">
                            <select id="worldBookSelect" class="friend-settings-select">
                                <option value="default">默认世界</option>
                                <option value="campus">校园日常</option>
                                <option value="idol">偶像练习生</option>
                                <option value="fantasy">奇幻冒险</option>
                                <option value="sci">科幻未来</option>
                            </select>
                        </div>
                    </details>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">对话界面展示</div>
                            <div class="friend-settings-desc">自定义聊天界面显示内容</div>
                        </div>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">对话时间</div>
                        <label class="ios-switch">
                            <input id="chatShowTimeToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">已读</div>
                        <label class="ios-switch">
                            <input id="chatReadToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">隐藏头像</div>
                        <label class="ios-switch">
                            <input id="chatHideAvatarToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">语音 ID</div>
                            <div class="friend-settings-desc">用于语音合成，未填写则自动</div>
                        </div>
                        <span id="voiceIdStatus" class="voice-status">未设置</span>
                    </div>
                    <input id="voiceIdInput" class="friend-settings-input" placeholder="输入语音ID">
                    <select id="voiceIdMode" class="friend-settings-select">
                        <option value="auto">自动选择</option>
                        <option value="fixed">固定使用此ID</option>
                        <option value="random">随机切换</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveCharSettingsBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">保存</button>
                    <button id="deleteCharBtn" style="flex: 1; padding: 12px; background-color: #f6f2f1; color: #d32f2f; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">删除好友</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书全屏页面 -->
    <div class="modal" id="worldbookModal" style="display:none;">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="worldbookStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="worldbookStatusSignal" class="fas fa-signal"></i>
                    <i id="worldbookStatusWifi" class="fas fa-wifi"></i>
                    <i id="worldbookStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="worldbookBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">世界书</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll" style="padding: 20px 16px;">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; text-align: center; padding: 40px 20px;">
                    <i class="fas fa-book-open" style="font-size: 56px; color: #debeeb; margin-bottom: 20px;"></i>
                    <p style="font-size: 18px; color: #787785; font-weight: 600; margin-bottom: 8px;">世界书功能页面</p>
                    <p style="font-size: 14px; color: #787785; opacity: 0.6;">后续可在此扩展新功能</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置全屏页面 -->
    <div class="modal" id="settingsModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="settingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="settingsStatusSignal" class="fas fa-signal"></i>
                    <i id="settingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="settingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="settingsBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                    返回
                </button>
                <div class="settings-title">设置</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll">
                <div id="settingsApiCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">API设置</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="configStatus" class="settings-status">未配置</span>
                        <i class="fas fa-chevron-right settings-arrow"></i>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">隐藏状态栏</div>
                        <div class="settings-card-desc">隐藏所有页面顶部的状态栏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="hideStatusBarToggle">
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <div id="settingsDataCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">数据管理</div>
                        <div class="settings-card-desc">导入导出、备份与恢复</div>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像选择弹窗 -->
    <div class="modal" id="avatarPickerModal" style="z-index: 2105; display: none; background-color: rgba(0,0,0,0.35);">
        <div style="background-color: #FFFFFF; border-radius: 20px; width: 86%; max-width: 320px; padding: 18px; box-shadow: 0 14px 40px rgba(120,119,133,0.2);">
            <h3 style="margin: 0 0 12px 0; color: #787785; font-size: 16px; font-weight: 600; text-align: center;">更换头像</h3>
            <div id="charAvatarModalPreview" style="width: 74px; height: 74px; border-radius: 50%; background: #f6f2f1; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: #787785; font-size: 26px; background-size: cover; background-position: center;">
                <i class="fas fa-user"></i>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input id="charAvatarUrlModalInput" type="text" placeholder="粘贴头像图片URL" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;">
                <label style="display: block; width: 100%; padding: 10px 12px; border: 1px dashed #f0d6d7; border-radius: 12px; font-size: 14px; color: #f0d6d7; text-align: center; cursor: pointer;">
                    选择本地图片
                    <input id="charAvatarFileModalInput" type="file" accept="image/*" style="display: none;">
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button id="cancelAvatarPicker" style="flex: 1; padding: 10px; background: #f6f2f1; border: none; border-radius: 12px; cursor: pointer; color: #787785; font-weight: 600;">取消</button>
                <button id="confirmAvatarPicker" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 12px; cursor: pointer; color: #fff; font-weight: 600;">确定</button>
            </div>
        </div>
    </div>

    <!-- 数据管理二级菜单 -->
    <div class="modal" id="dataManageModal">
        <div class="modal-content" style="max-width: 360px; border-radius: 18px;">
            <div class="modal-header">
                <h3>数据管理</h3>
                <button class="modal-close" id="closeDataManageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="data-manage-list">
                    <button id="exportAllData" class="data-manage-item">导出全部数据</button>
                    <button id="importAllData" class="data-manage-item">导入数据（覆盖当前）</button>
                    <button id="exportFriendsData" class="data-manage-item">仅备份好友数据</button>
                    <button id="exportChatsData" class="data-manage-item">仅备份聊天记录</button>
                </div>
                <input type="file" id="importFileInput" accept="application/json" style="display: none;" />
            </div>
        </div>
    </div>

    <!-- 个人资料小组件编辑弹窗 -->
    <div id="profileWidgetModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="profileWidgetModalTitle" style="z-index: 3000;">
        <div id="profileWidgetModalContent" class="modal-content" style="max-width: 320px;">
            <div class="modal-header">
                <h3 id="profileWidgetModalTitle">编辑</h3>
                <button class="modal-close" id="closeProfileWidgetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="profileWidgetImageEditor" style="display: none;" class="space-y-4">
                    <img id="profileWidgetImagePreview" src="" alt="预览" class="w-full h-48 object-contain rounded-lg bg-gray-100 hidden" />
                    <div class="form-group">
                        <label for="profileWidgetImageUrlInput">图片链接</label>
                        <input id="profileWidgetImageUrlInput" type="text" class="form-control" placeholder="https://example.com/image.png" />
                    </div>
                    <div class="relative flex items-center" style="margin: 10px 0;">
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                        <span style="margin: 0 10px; color: #999; font-size: 12px;">或</span>
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                    </div>
                    <div class="form-group">
                        <input type="file" accept="image/*" id="profileWidgetFileInput" class="form-control" style="display: none;" aria-hidden="true" />
                        <button id="profileWidgetUploadButton" class="btn btn-secondary" style="width: 100%;">选择图片</button>
                    </div>
                </div>

                <div id="profileWidgetTextEditor" style="display: none;">
                    <input id="profileWidgetTextInput" type="text" class="form-control" />
                </div>

                <div id="profileWidgetTextareaEditor" style="display: none;">
                    <textarea id="profileWidgetTextareaInput" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-actions">
                    <button id="profileWidgetCancelButton" type="button" class="btn btn-secondary">取消</button>
                    <button id="profileWidgetSaveButton" type="button" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { appManager } from './app-manager.js';
        window.appManager = appManager;
    </script>

    <script>
(() => {
        let friendSystem;
        let apiService;
        let chatSession;
        let profileWidget;
        let heartVoiceSystem;

        // 可爱提示框函数
        function showCuteToast() {
            const cuteToast = document.getElementById('cuteToast');
            if (!cuteToast) return;
            
            cuteToast.style.display = 'block';
            setTimeout(() => {
                cuteToast.style.display = 'none';
            }, 2000);
        }

        // 重写 alert 函数
        window.alert = function(message) {
            showCuteToast();
        };

        // 基础功能
        const statusEl = document.getElementById('statusText');
        const statusTimeEl = document.getElementById('statusTime');
        const statusSignalEl = document.getElementById('statusSignal');
        const statusWifiEl = document.getElementById('statusWifi');
        const statusBatteryEl = document.getElementById('statusBattery');
        const chatStatusTime = document.getElementById('chatStatusTime');
        const chatStatusSignal = document.getElementById('chatStatusSignal');
        const chatStatusWifi = document.getElementById('chatStatusWifi');
        const chatStatusBattery = document.getElementById('chatStatusBattery');
        const friendSettingsStatusTime = document.getElementById('friendSettingsStatusTime');
        const friendSettingsStatusSignal = document.getElementById('friendSettingsStatusSignal');
        const friendSettingsStatusWifi = document.getElementById('friendSettingsStatusWifi');
        const friendSettingsStatusBattery = document.getElementById('friendSettingsStatusBattery');
        const worldbookStatusTime = document.getElementById('worldbookStatusTime');
        const settingsStatusTime = document.getElementById('settingsStatusTime');
        const friendListStatusTime = document.getElementById('friendListStatusTime');
        const apiStatusSignal = document.getElementById('apiStatusSignal');
        const apiStatusWifi = document.getElementById('apiStatusWifi');
        const apiStatusBattery = document.getElementById('apiStatusBattery');
        const greetingText = document.getElementById('greetingText');

        function setStatusIcon(el, iconClass) {
            if (!el || !iconClass) return;
            el.className = `fas ${iconClass}`;
        }

        function applyStatusBar(status) {
            if (!status) return;
            if (statusTimeEl && status.time) {
                statusTimeEl.textContent = status.time;
            }
            setStatusIcon(statusSignalEl, status.signal);
            setStatusIcon(statusWifiEl, status.wifi);
            setStatusIcon(statusBatteryEl, status.battery);

            // 更新聊天页状态栏图标
            setStatusIcon(chatStatusSignal, status.signal);
            setStatusIcon(chatStatusWifi, status.wifi);
            setStatusIcon(chatStatusBattery, status.battery);

            // 更新好友设置页状态栏图标
            setStatusIcon(friendSettingsStatusSignal, status.signal);
            setStatusIcon(friendSettingsStatusWifi, status.wifi);
            setStatusIcon(friendSettingsStatusBattery, status.battery);

            // 更新API配置页状态栏图标
            setStatusIcon(apiStatusSignal, status.signal);
            setStatusIcon(apiStatusWifi, status.wifi);
            setStatusIcon(apiStatusBattery, status.battery);
        }
        
        // 更新时间（北京时间实时更新）
        function updateTime() {
            // 获取北京时间（UTC+8）
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const h = String(beijingTime.getHours()).padStart(2, '0');
            const m = String(beijingTime.getMinutes()).padStart(2, '0');
            const timeStr = `${h}:${m}`;
            
            // 更新主页面时间
            if (statusTimeEl) {
                statusTimeEl.textContent = timeStr;
            }

            // 更新聊天页面时间
            if (chatStatusTime) {
                chatStatusTime.textContent = timeStr;
            }

            // 更新好友设置页面时间
            if (friendSettingsStatusTime) {
                friendSettingsStatusTime.textContent = timeStr;
            }

            // 更新世界书页面时间
            if (worldbookStatusTime) {
                worldbookStatusTime.textContent = timeStr;
            }

            // 更新设置页面时间
            if (settingsStatusTime) {
                settingsStatusTime.textContent = timeStr;
            }

            // 更新好友列表页面时间
            if (friendListStatusTime) {
                friendListStatusTime.textContent = timeStr;
            }

            // 更新API配置页面时间
            const apiStatusTime = document.getElementById('apiStatusTime');
            if (apiStatusTime) {
                apiStatusTime.textContent = timeStr;
            }

            if (window.appManager && typeof window.appManager.setStatus === 'function') {
                window.appManager.setStatus({ time: timeStr });
            }
        }
        updateTime();
        if (window.appManager && typeof window.appManager.on === 'function') {
            window.appManager.on('status-change', applyStatusBar);
            if (typeof window.appManager.getStatus === 'function') {
                applyStatusBar(window.appManager.getStatus());
            }
        }
        setInterval(updateTime, 1000);
        
        // 状态提示
        function announce(name) {
            if (!statusEl) return;
            const original = statusEl.textContent;
            statusEl.textContent = `打开了 ${name}`;
            setTimeout(() => {
                statusEl.textContent = original;
            }, 900);
        }

        function launchApp(appId) {
            if (!window.appManager || typeof window.appManager.launch !== 'function') return;
            try {
                window.appManager.launch(appId);
            } catch (e) {
                console.warn('APP 启动失败:', e);
            }
        }

        function loadGreetingText() {
            const fallback = '小小世界，开心至上';
            const saved = friendSystem
                ? friendSystem.getStorage('homeGreeting', fallback)
                : fallback;
            if (greetingText) {
                greetingText.textContent = (saved || fallback).trim();
            }
        }

        function enableGreetingEdit() {
            if (!greetingText) return;
            greetingText.setAttribute('contenteditable', 'true');
            greetingText.focus();
            const selection = window.getSelection();
            if (selection && greetingText.firstChild) {
                const range = document.createRange();
                range.selectNodeContents(greetingText);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function saveGreetingText() {
            if (!greetingText) return;
            const text = greetingText.textContent.trim() || '小小世界，开心至上';
            greetingText.textContent = text;
            greetingText.removeAttribute('contenteditable');
            if (friendSystem) {
                friendSystem.setStorage('homeGreeting', text);
            } else {
                localStorage.setItem('homeGreeting', JSON.stringify(text));
            }
        }
        
        // ========== 获取DOM元素 ==========
        
        // 图标元素
        const phoneIcon = document.getElementById('phoneIcon');
        const novelIcon = document.getElementById('novelIcon');
        const forumIcon = document.getElementById('forumIcon');
        const appGrid = document.getElementById('appGrid');
        
        // 模态窗口元素
        const apiModal = document.getElementById('apiModal');
        const chatModal = document.getElementById('chatModal');
        const settingsModal = document.getElementById('settingsModal');
        const friendListModal = document.getElementById('friendListModal');
        const addFriendModal = document.getElementById('addFriendModal');
        
        // API配置相关元素
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const fetchModelsBtn = document.getElementById('fetchModels');
        const fetchBtnText = document.getElementById('fetchBtnText');
        const fetchLoading = document.getElementById('fetchLoading');
        const modelSelect = document.getElementById('modelSelect');
        const modelPickerButton = document.getElementById('modelPickerButton');
        const modelPickerText = document.getElementById('modelPickerText');
        const modelPickerList = document.getElementById('modelPickerList');
        const testApiBtn = document.getElementById('testApi');
        const saveApiBtn = document.getElementById('saveApi');
        const apiStatus = document.getElementById('apiStatus');
        
        // 设置显示元素
        const currentApiUrlDisplay = document.getElementById('currentApiUrlDisplay');
        const currentModelDisplay = document.getElementById('currentModelDisplay');
        const configStatus = document.getElementById('configStatus');
        
        // 好友列表相关元素
        const friendListElement = document.getElementById('friendList');
        const noFriends = document.getElementById('noFriends');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarInput = document.getElementById('avatarInput');
        const friendName = document.getElementById('friendName');
        const friendPersona = document.getElementById('friendPersona');
        const confirmAddFriend = document.getElementById('confirmAddFriend');
        const cancelAddFriend = document.getElementById('cancelAddFriend');
        const addFriendStatus = document.getElementById('addFriendStatus');
        const closeFriendListModal = document.getElementById('closeFriendListModal');
        const closeAddFriendModal = document.getElementById('closeAddFriendModal');
        
        // 聊天相关元素
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessage');
        const chatMessages = document.getElementById('chatMessages');
        const chatStatus = document.getElementById('chatStatus');
        const chatTitle = document.getElementById('chatTitle');

        const replyPreview = document.getElementById('replyPreview');
        const replyPreviewText = document.getElementById('replyPreviewText');
        const replyPreviewClose = document.getElementById('replyPreviewClose');

        const imageUploadPill = document.getElementById('imageUploadPill');
        const imageUploadThumb = document.getElementById('imageUploadThumb');
        const imageUploadName = document.getElementById('imageUploadName');
        const imageUploadClose = document.getElementById('imageUploadClose');
        const imageUploadBtn = document.getElementById('imageUploadBtn');
        const imageInput = document.getElementById('imageInput');
        const imageConfirmPopover = document.getElementById('imageConfirmPopover');
        const imageConfirmYes = document.getElementById('imageConfirmYes');
        const imageConfirmNo = document.getElementById('imageConfirmNo');
        const chatPlusBtn = document.getElementById('chatPlusBtn');
        const chatExtraPanel = document.getElementById('chatExtraPanel');
        const chatInputAreaWrap = document.getElementById('chatInputAreaWrap');
        const chatInputRow = document.querySelector('.chat-input-row');

        const messageActionOverlay = document.getElementById('messageActionOverlay');
        const messageActionMenu = document.getElementById('messageActionMenu');
        const messageActionCopy = document.getElementById('messageActionCopy');
        const messageActionDelete = document.getElementById('messageActionDelete');
        const messageActionRecall = document.getElementById('messageActionRecall');
        const messageActionReply = document.getElementById('messageActionReply');
        
        const triggerAiBtn = document.getElementById('triggerAiBtn');
        // 关闭按钮
        const closeApiModal = document.getElementById('closeApiModal');
        const backToFriendList = document.getElementById('backToFriendList');
        const closeSettingsModal = document.getElementById('settingsBack');
        const openApiConfig = document.getElementById('openApiConfig');
        const settingsApiCard = document.getElementById('settingsApiCard');
        const settingsDataCard = document.getElementById('settingsDataCard');
        const dataManageModal = document.getElementById('dataManageModal');
        const closeDataManageModal = document.getElementById('closeDataManageModal');
        const exportAllDataBtn = document.getElementById('exportAllData');
        const importAllDataBtn = document.getElementById('importAllData');
        const exportFriendsDataBtn = document.getElementById('exportFriendsData');
        const exportChatsDataBtn = document.getElementById('exportChatsData');
        const importFileInput = document.getElementById('importFileInput');

        // 个人资料小组件（新）
        class ProfileWidget {
            constructor() {
                this.storageKey = 'profileWidgetV2Data';
                this.data = {
                    avatarImage: '',
                    bodyImage: '',
                    bottomImage: '',
                    name: 'FirstSnow_',
                    handle: '@Sovow1212',
                    status: '会在初雪日再次相遇(*^. ^*)',
                    location: 'Seoul'
                };
                this.currentField = null;
                this.tempValue = '';
                this.els = {
                    widget: document.getElementById('profileWidgetV2'),
                    cover: document.getElementById('profileWidgetCover'),
                    bottom: document.getElementById('profileWidgetBottom'),
                    avatarImage: document.getElementById('profileAvatarImage'),
                    avatarImagePlaceholder: document.getElementById('profileAvatarImagePlaceholder'),
                    name: document.getElementById('profileName'),
                    handle: document.getElementById('profileHandle'),
                    status: document.getElementById('profileStatus'),
                    location: document.getElementById('profileLocation'),
                    modal: document.getElementById('profileWidgetModal'),
                    modalContent: document.getElementById('profileWidgetModalContent'),
                    modalTitle: document.getElementById('profileWidgetModalTitle'),
                    imageEditor: document.getElementById('profileWidgetImageEditor'),
                    textEditor: document.getElementById('profileWidgetTextEditor'),
                    textareaEditor: document.getElementById('profileWidgetTextareaEditor'),
                    imagePreview: document.getElementById('profileWidgetImagePreview'),
                    imageUrlInput: document.getElementById('profileWidgetImageUrlInput'),
                    textInput: document.getElementById('profileWidgetTextInput'),
                    textareaInput: document.getElementById('profileWidgetTextareaInput'),
                    fileInput: document.getElementById('profileWidgetFileInput'),
                    saveButton: document.getElementById('profileWidgetSaveButton'),
                    cancelButton: document.getElementById('profileWidgetCancelButton'),
                    uploadButton: document.getElementById('profileWidgetUploadButton'),
                    closeButton: document.getElementById('closeProfileWidgetModal')
                };
            }

            load() {
                try {
                    const saved = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
                    Object.assign(this.data, saved || {});
                } catch (e) {
                    // ignore
                }
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            }

            updateUI() {
                Object.keys(this.data).forEach((key) => {
                    const el = this.els[key];
                    if (key === 'bodyImage') {
                        if (this.els.cover) {
                            if (this.data.bodyImage) {
                                this.els.cover.style.backgroundImage = `url('${this.data.bodyImage}')`;
                            } else {
                                this.els.cover.style.backgroundImage = '';
                            }
                        }
                        return;
                    }
                    if (key === 'bottomImage') {
                        if (this.els.bottom) {
                            if (this.data.bottomImage) {
                                this.els.bottom.style.backgroundImage = `url('${this.data.bottomImage}')`;
                            } else {
                                this.els.bottom.style.backgroundImage = '';
                            }
                        }
                        return;
                    }
                    if (!el) return;
                    if (key === 'avatarImage') {
                        const placeholder = this.els[key + 'Placeholder'];
                        if (this.data[key]) {
                            el.src = this.data[key];
                            el.classList.remove('hidden');
                            if (placeholder) placeholder.classList.add('hidden');
                        } else {
                            el.classList.add('hidden');
                            if (placeholder) placeholder.classList.remove('hidden');
                        }
                    } else {
                        if (key === 'handle') {
                            el.textContent = this.data.handle.startsWith('@')
                                ? this.data.handle
                                : `@${this.data.handle}`;
                        } else {
                            el.textContent = this.data[key];
                        }
                    }
                });
            }

            openModal(field, type, label) {
                this.currentField = field;
                this.tempValue = this.data[field] || '';
                if (this.els.modalTitle) {
                    this.els.modalTitle.textContent = `编辑${label}`;
                }

                if (this.els.imageEditor) this.els.imageEditor.style.display = 'none';
                if (this.els.textEditor) this.els.textEditor.style.display = 'none';
                if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'none';

                if (type === 'image') {
                    if (this.els.imageEditor) this.els.imageEditor.style.display = 'block';
                    if (this.els.imageUrlInput) {
                        this.els.imageUrlInput.value = this.tempValue.startsWith('data:') ? '' : this.tempValue;
                    }
                    if (this.els.imagePreview) {
                        this.els.imagePreview.src = this.tempValue;
                        this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                    }
                } else if (type === 'text') {
                    if (this.els.textEditor) this.els.textEditor.style.display = 'block';
                    if (this.els.textInput) this.els.textInput.value = this.tempValue;
                } else if (type === 'textarea') {
                    if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'block';
                    if (this.els.textareaInput) this.els.textareaInput.value = this.tempValue;
                }

                if (this.els.modal) this.els.modal.style.display = 'flex';
                if (this.els.modalContent) this.els.modalContent.classList.add('animate-fade-in-scale');
            }

            closeModal() {
                if (this.els.modalContent) this.els.modalContent.classList.remove('animate-fade-in-scale');
                if (this.els.modal) this.els.modal.style.display = 'none';
                this.currentField = null;
                this.tempValue = '';
                if (this.els.fileInput) this.els.fileInput.value = '';
            }

            saveChanges() {
                if (this.currentField) {
                    this.data[this.currentField] = this.tempValue;
                    this.save();
                    this.updateUI();
                }
                this.closeModal();
            }

            bindEvents() {
                const editProfileAvatarImage = document.getElementById('editProfileAvatarImage');
                if (editProfileAvatarImage) {
                    editProfileAvatarImage.addEventListener('click', () => this.openModal('avatarImage', 'image', '头像图片'));
                }

                const setupInlineEdit = (key) => {
                    const el = this.els[key];
                    if (!el) return;
                    
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            el.blur();
                        }
                    });

                    el.addEventListener('blur', () => {
                        let val = el.textContent.trim();
                        if (key === 'handle' && val && !val.startsWith('@')) {
                            val = '@' + val;
                        }
                        this.data[key] = val;
                        this.save();
                        this.updateUI();
                    });
                };

                ['name', 'handle', 'status', 'location'].forEach(key => setupInlineEdit(key));

                if (this.els.cover) {
                    this.els.cover.addEventListener('click', (event) => {
                        if (event.target.closest('[data-no-bg-change]')) return;
                        this.openModal('bodyImage', 'image', '背景图片');
                    });
                }

                if (this.els.bottom) {
                    this.els.bottom.addEventListener('click', (event) => {
                        if (event.target.closest('[data-no-bg-change]')) return;
                        this.openModal('bottomImage', 'image', '底部背景');
                    });
                }

                if (this.els.saveButton) {
                    this.els.saveButton.addEventListener('click', () => this.saveChanges());
                }
                if (this.els.cancelButton) {
                    this.els.cancelButton.addEventListener('click', () => this.closeModal());
                }
                if (this.els.closeButton) {
                    this.els.closeButton.addEventListener('click', () => this.closeModal());
                }
                if (this.els.modal) {
                    this.els.modal.addEventListener('click', (e) => {
                        if (e.target === this.els.modal) this.closeModal();
                    });
                }

                if (this.els.imageUrlInput) {
                    this.els.imageUrlInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                        if (this.els.imagePreview) {
                            this.els.imagePreview.src = this.tempValue;
                            this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                        }
                    });
                }
                if (this.els.textInput) {
                    this.els.textInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                    });
                }
                if (this.els.textareaInput) {
                    this.els.textareaInput.addEventListener('input', (e) => {
                        this.tempValue = e.target.value;
                    });
                }

                if (this.els.uploadButton && this.els.fileInput) {
                    this.els.uploadButton.addEventListener('click', () => this.els.fileInput.click());
                    this.els.fileInput.addEventListener('change', async (event) => {
                        const file = event.target.files && event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = () => {
                            this.tempValue = String(reader.result || '');
                            if (this.els.imageUrlInput) this.els.imageUrlInput.value = '';
                            if (this.els.imagePreview) {
                                this.els.imagePreview.src = this.tempValue;
                                this.els.imagePreview.classList.remove('hidden');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }

            init() {
                this.load();
                this.updateUI();
                this.bindEvents();
            }
        }
        
        // ========== APP入口清单（集中管理） ==========
        const APP_ENTRY_POINTS = {
            home: ['message', 'feixin', 'worldbook', 'settings', 'phone', 'forum'],
            dock: ['phone', 'novel', 'forum']
        };

        function openAppWithNotice(appId, name, notice) {
            launchApp(appId);
            announce(name);
            if (notice) alert(notice);
        }

        const APP_HANDLERS = {
            message: () => openAppWithNotice('message', '消息', '消息功能开发中...'),
            feixin: () => {
                launchApp('feixin');
                announce('甜聊');
                friendListModal.style.display = 'flex';
                renderFriendList();
            },
            worldbook: () => {
                launchApp('worldbook');
                announce('世界书');
                const worldbookModal = document.getElementById('worldbookModal');
                if (worldbookModal) {
                    worldbookModal.style.display = 'flex';
                }
            },
            settings: () => {
                launchApp('settings');
                announce('设置');
                settingsModal.style.display = 'flex';
                if (apiService) apiService.updateSettingsDisplay();
            },
            beautify: () => openAppWithNotice('beautify', '美化', '美化功能开发中...'),
            phone: () => openAppWithNotice('phone', '手机', '手机功能开发中...'),
            novel: () => openAppWithNotice('novel', '小说', '小说功能开发中...'),
            forum: () => openAppWithNotice('forum', '论坛', '论坛功能开发中...')
        };

        // ========== 图标点击事件 ==========
        function handleAppClick(appId) {
            const handler = APP_HANDLERS[appId];
            if (handler) {
                handler();
                return;
            }
            launchApp(appId);
            announce('应用');
            alert('功能开发中...');
        }
        
        // Dock栏图标
        if (phoneIcon) {
            phoneIcon.addEventListener('click', () => handleAppClick('phone'));
        }
        
        if (novelIcon) {
            novelIcon.addEventListener('click', () => handleAppClick('novel'));
        }
        
        if (forumIcon) {
            forumIcon.addEventListener('click', () => handleAppClick('forum'));
        }
        
        // ========== 模态窗口控制 ==========
        
        closeApiModal.addEventListener('click', () => {
            apiModal.style.display = 'none';
            apiStatus.style.display = 'none';
            settingsModal.style.display = 'flex';
        });
        
        backToFriendList.addEventListener('click', () => {
            chatModal.style.display = 'none';
            chatStatus.style.display = 'none';
            if (heartVoiceSystem) heartVoiceSystem.closePopup();
            friendListModal.style.display = 'flex';
            renderFriendList();
        });
        
        closeSettingsModal.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // 世界书返回按钮
        const worldbookBackBtn = document.getElementById('worldbookBack');
        if (worldbookBackBtn) {
            worldbookBackBtn.addEventListener('click', () => {
                const wbModal = document.getElementById('worldbookModal');
                if (wbModal) wbModal.style.display = 'none';
            });
        }

        if (settingsApiCard) {
            settingsApiCard.addEventListener('click', () => {
                settingsModal.style.display = 'none';
                apiModal.style.display = 'flex';

                if (!apiService) return;
                const config = apiService.getConfig();
                if (config.apiUrl) {
                    apiUrlInput.value = config.apiUrl;
                }
                if (config.apiKey) {
                    apiKeyInput.value = config.apiKey;
                }
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            });
        }

        if (settingsDataCard) {
            settingsDataCard.addEventListener('click', () => {
                dataManageModal.style.display = 'flex';
            });
        }

        if (closeDataManageModal) {
            closeDataManageModal.addEventListener('click', () => {
                dataManageModal.style.display = 'none';
            });
        }
        
        closeFriendListModal.addEventListener('click', () => {
            friendListModal.style.display = 'none';
        });

        // 好友列表导航栏事件处理
        const navItems = document.querySelectorAll('.friend-list-nav-item');
        if (navItems.length > 0) {
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const navType = item.dataset.nav;
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    if (navType === 'messages') {
                        // 当前已是消息列表，无需做额外处理
                        console.log('显示消息列表');
                    } else if (navType === 'moments') {
                        alert('动态功能开发中...');
                    } else if (navType === 'me') {
                        alert('个人页面开发中...');
                    }
                });
            });
        }

        // 好友列表中的添加好友按钮
        const addFriendFromList = document.getElementById('addFriendFromList');
        if (addFriendFromList) {
            addFriendFromList.addEventListener('click', () => {
                addFriendModal.style.display = 'flex';
                resetAddFriendForm();
            });
        }
        
        closeAddFriendModal.addEventListener('click', () => {
            addFriendModal.style.display = 'none';
            resetAddFriendForm();
        });

        // 个人资料小组件交互（新）由 ProfileWidget 统一管理
        
        // 好友设置相关
        const charSettingsModal = document.getElementById('charSettingsModal');
        const charSettingsBtn = document.getElementById('charSettingsBtn');
        const charSettingsBack = document.getElementById('charSettingsBack');
        const charNameInput = document.getElementById('charNameInput');
        const charPersonaInput = document.getElementById('charPersonaInput');
        const charAvatarDisplay = document.getElementById('charAvatarDisplay');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const charAvatarInput = document.getElementById('charAvatarInput');
        const worldBookSelect = document.getElementById('worldBookSelect');
        const voiceIdInput = document.getElementById('voiceIdInput');
        const voiceIdMode = document.getElementById('voiceIdMode');
        const voiceIdStatus = document.getElementById('voiceIdStatus');
        const chatShowTimeToggle = document.getElementById('chatShowTimeToggle');
        const chatReadToggle = document.getElementById('chatReadToggle');
        const chatHideAvatarToggle = document.getElementById('chatHideAvatarToggle');
        const avatarPickerModal = document.getElementById('avatarPickerModal');
        const charAvatarUrlModalInput = document.getElementById('charAvatarUrlModalInput');
        const charAvatarFileModalInput = document.getElementById('charAvatarFileModalInput');
        const charAvatarModalPreview = document.getElementById('charAvatarModalPreview');
        const cancelAvatarPicker = document.getElementById('cancelAvatarPicker');
        const confirmAvatarPicker = document.getElementById('confirmAvatarPicker');
        const saveCharSettingsBtn = document.getElementById('saveCharSettingsBtn');
        const deleteCharBtn = document.getElementById('deleteCharBtn');
        let pendingCharAvatar = '';
        let modalAvatarTemp = '';

        function updateVoiceStatus(value) {
            if (!voiceIdStatus) return;
            const hasValue = !!value;
            voiceIdStatus.textContent = hasValue ? '已设置' : '未设置';
        }

        function setCharAvatarDisplay(avatarUrl) {
            if (!charAvatarDisplay) return;
            if (avatarUrl) {
                charAvatarDisplay.style.backgroundImage = `url('${avatarUrl}')`;
                charAvatarDisplay.classList.add('has-image');
            } else {
                charAvatarDisplay.style.backgroundImage = '';
                charAvatarDisplay.classList.remove('has-image');
            }
        }

        function setAvatarModalPreview(avatarUrl) {
            if (!charAvatarModalPreview) return;
            if (avatarUrl) {
                charAvatarModalPreview.style.backgroundImage = `url('${avatarUrl}')`;
                charAvatarModalPreview.innerHTML = '';
            } else {
                charAvatarModalPreview.style.backgroundImage = '';
                charAvatarModalPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // 打开好友设置
        charSettingsBtn.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            if (currentFriendId && friendSystem) {
                const friend = friendSystem.getFriendById(currentFriendId);
                
                if (friend) {
                    charNameInput.value = friend.name;
                    charPersonaInput.value = friend.persona || '';
                    pendingCharAvatar = friend.avatar || '';
                    setCharAvatarDisplay(pendingCharAvatar);
                    if (worldBookSelect) {
                        worldBookSelect.value = friend.worldBook || 'default';
                    }
                    if (voiceIdInput) {
                        voiceIdInput.value = friend.voiceId || '';
                        updateVoiceStatus(voiceIdInput.value.trim());
                    }
                    if (voiceIdMode) {
                        voiceIdMode.value = friend.voiceIdMode || 'auto';
                    }
                    if (chatShowTimeToggle) {
                        chatShowTimeToggle.checked = friend.chatShowTime ?? true;
                    }
                    if (chatReadToggle) {
                        chatReadToggle.checked = friend.chatReadStatus ?? true;
                    }
                    if (chatHideAvatarToggle) {
                        chatHideAvatarToggle.checked = friend.chatHideAvatar ?? false;
                    }
                    if (charAvatarInput) {
                        charAvatarInput.value = '';
                    }
                    modalAvatarTemp = pendingCharAvatar || '';
                    charSettingsModal.style.display = 'flex';
                }
            }
        });
        
        // 关闭好友设置
        if (charSettingsBack) {
            charSettingsBack.addEventListener('click', () => {
                charSettingsModal.style.display = 'none';
            });
        }
        
        // 点击背景关闭
        charSettingsModal.addEventListener('click', (e) => {
            if (e.target === charSettingsModal) {
                charSettingsModal.style.display = 'none';
            }
        });
        
        // 更换头像
        function openAvatarPicker() {
            if (!avatarPickerModal) return;
            modalAvatarTemp = pendingCharAvatar || '';
            if (charAvatarUrlModalInput) {
                charAvatarUrlModalInput.value = modalAvatarTemp && !modalAvatarTemp.startsWith('data:') ? modalAvatarTemp : '';
            }
            if (charAvatarFileModalInput) {
                charAvatarFileModalInput.value = '';
            }
            setAvatarModalPreview(modalAvatarTemp);
            avatarPickerModal.style.display = 'flex';
        }

        if (charAvatarDisplay) {
            charAvatarDisplay.addEventListener('click', openAvatarPicker);
        }

        if (charAvatarUrlModalInput) {
            charAvatarUrlModalInput.addEventListener('input', (e) => {
                const url = e.target.value.trim();
                modalAvatarTemp = url;
                setAvatarModalPreview(url);
            });
        }

        if (voiceIdInput) {
            voiceIdInput.addEventListener('input', (e) => {
                updateVoiceStatus(e.target.value.trim());
            });
        }

        if (charAvatarFileModalInput) {
            charAvatarFileModalInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    modalAvatarTemp = imageUrl;
                    setAvatarModalPreview(imageUrl);
                    if (charAvatarUrlModalInput) {
                        charAvatarUrlModalInput.value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        if (cancelAvatarPicker && avatarPickerModal) {
            cancelAvatarPicker.addEventListener('click', () => {
                avatarPickerModal.style.display = 'none';
            });
        }

        if (confirmAvatarPicker && avatarPickerModal) {
            confirmAvatarPicker.addEventListener('click', () => {
                const urlValue = charAvatarUrlModalInput ? charAvatarUrlModalInput.value.trim() : '';
                pendingCharAvatar = urlValue || modalAvatarTemp || '';
                setCharAvatarDisplay(pendingCharAvatar);
                avatarPickerModal.style.display = 'none';
            });
        }

        if (avatarPickerModal) {
            avatarPickerModal.addEventListener('click', (e) => {
                if (e.target === avatarPickerModal) {
                    avatarPickerModal.style.display = 'none';
                }
            });
        }
        
        // 保存好友设置
        saveCharSettingsBtn.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            const updated = friendSystem ? friendSystem.updateFriend(currentFriendId, {
                persona: charPersonaInput.value.trim(),
                avatar: pendingCharAvatar || null,
                worldBook: worldBookSelect ? worldBookSelect.value : 'default',
                voiceId: voiceIdInput ? voiceIdInput.value.trim() : '',
                voiceIdMode: voiceIdMode ? voiceIdMode.value : 'auto',
                chatShowTime: chatShowTimeToggle ? chatShowTimeToggle.checked : true,
                chatReadStatus: chatReadToggle ? chatReadToggle.checked : true,
                chatHideAvatar: chatHideAvatarToggle ? chatHideAvatarToggle.checked : false
            }) : null;
            if (updated) {
                // 注意：name 是只读的，不允许修改
                charSettingsModal.style.display = 'none';
                if (chatSession) chatSession.showChatStatus('好友设置已保存', 'success');
            }
        });
        
        // 删除好友
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteYes = document.getElementById('confirmDeleteYes');
        const confirmDeleteNo = document.getElementById('confirmDeleteNo');
        
        deleteCharBtn.addEventListener('click', () => {
            confirmDeleteModal.style.display = 'flex';
        });
        
        confirmDeleteYes.addEventListener('click', () => {
            const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
            const removed = friendSystem ? friendSystem.deleteFriend(currentFriendId) : null;
            
            if (removed) {
                
                // 删除好友的聊天历史
                localStorage.removeItem(`chat_${currentFriendId}`);
                
                confirmDeleteModal.style.display = 'none';
                charSettingsModal.style.display = 'none';
                chatModal.style.display = 'none';
                if (chatSession) chatSession.setCurrentFriendId(null);
                friendListModal.style.display = 'flex';
                renderFriendList();
            }
        });
        
        confirmDeleteNo.addEventListener('click', () => {
            confirmDeleteModal.style.display = 'none';
        });
        
        if (openApiConfig) {
            openApiConfig.addEventListener('click', () => {
                settingsModal.style.display = 'none';
                apiModal.style.display = 'flex';

                if (!apiService) return;
                const config = apiService.getConfig();
                if (config.apiUrl) {
                    apiUrlInput.value = config.apiUrl;
                }
                if (config.apiKey) {
                    apiKeyInput.value = config.apiKey;
                }
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            });
        }

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        function collectOtherSettings() {
            const otherSettings = {};
            const reservedPrefixes = ['chat_'];
            const reservedKeys = new Set([
                'apiConfig',
                'friends',
                'profileWidgetV2Data',
                'homeGreeting'
            ]);
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;
                if (reservedKeys.has(key)) continue;
                if (reservedPrefixes.some(prefix => key.startsWith(prefix))) continue;
                try {
                    otherSettings[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    otherSettings[key] = localStorage.getItem(key);
                }
            }
            return otherSettings;
        }

        function collectChatHistories(friendsList = []) {
            const chatHistories = {};
            friendsList.forEach(friend => {
                if (!friend || !friend.id) return;
                chatHistories[friend.id] = friendSystem
                    ? friendSystem.getFriendChatHistory(friend.id)
                    : [];
            });
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || !key.startsWith('chat_')) continue;
                const friendId = key.replace('chat_', '');
                if (!chatHistories[friendId]) {
                    try {
                        chatHistories[friendId] = JSON.parse(localStorage.getItem(key)) || [];
                    } catch (e) {
                        chatHistories[friendId] = [];
                    }
                }
            }
            return chatHistories;
        }

        function buildExportPayload(customData = {}) {
            return {
                exportVersion: '1.0',
                exportTime: new Date().toISOString(),
                data: customData
            };
        }

        function exportAllData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                apiConfig: apiService ? apiService.getConfig() : {},
                friends: friends,
                chatHistories: collectChatHistories(friends),
                profileWidget: friendSystem ? friendSystem.getStorage('profileWidgetV2Data', {}) : {},
                homeGreeting: friendSystem ? friendSystem.getStorage('homeGreeting', '') : '',
                otherSettings: collectOtherSettings()
            });
            downloadJson(payload, `app_backup_all_${Date.now()}.json`);
        }

        function exportFriendsData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                friends: friends
            });
            downloadJson(payload, `app_backup_friends_${Date.now()}.json`);
        }

        function exportChatsData() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            const payload = buildExportPayload({
                chatHistories: collectChatHistories(friends)
            });
            downloadJson(payload, `app_backup_chats_${Date.now()}.json`);
        }

        function applyImportPayload(payload) {
            if (!payload || !payload.data || typeof payload.data !== 'object') {
                throw new Error('数据格式不正确');
            }

            const data = payload.data;
            localStorage.clear();

            if (data.apiConfig) {
                localStorage.setItem('apiConfig', JSON.stringify(data.apiConfig));
            }
            if (data.friends) {
                localStorage.setItem('friends', JSON.stringify(data.friends));
            }
            if (data.profileWidget) {
                localStorage.setItem('profileWidgetV2Data', JSON.stringify(data.profileWidget));
            }
            if (data.homeGreeting !== undefined) {
                localStorage.setItem('homeGreeting', JSON.stringify(data.homeGreeting));
            }
            if (data.chatHistories && typeof data.chatHistories === 'object') {
                Object.keys(data.chatHistories).forEach(friendId => {
                    localStorage.setItem(`chat_${friendId}`, JSON.stringify(data.chatHistories[friendId] || []));
                });
            }
            if (data.otherSettings && typeof data.otherSettings === 'object') {
                Object.keys(data.otherSettings).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(data.otherSettings[key]));
                });
            }

            if (friendSystem) friendSystem.init();
            if (apiService) apiService.updateSettingsDisplay();
            if (profileWidget) {
                profileWidget.load();
                profileWidget.updateUI();
            }
            renderFriendList();
            loadGreetingText();
        }

        function handleImportFile(file) {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const payload = JSON.parse(String(reader.result || '{}'));
                    const confirmImport = confirm('导入将覆盖当前所有数据，是否继续？');
                    if (!confirmImport) return;
                    applyImportPayload(payload);
                    alert('导入完成');
                } catch (e) {
                    alert('导入失败：JSON 格式不正确');
                }
            };
            reader.readAsText(file);
        }

        if (exportAllDataBtn) {
            exportAllDataBtn.addEventListener('click', exportAllData);
        }
        if (exportFriendsDataBtn) {
            exportFriendsDataBtn.addEventListener('click', exportFriendsData);
        }
        if (exportChatsDataBtn) {
            exportChatsDataBtn.addEventListener('click', exportChatsData);
        }
        if (importAllDataBtn && importFileInput) {
            importAllDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) {
                    handleImportFile(file);
                }
                importFileInput.value = '';
            });
        }
        
        // 点击模态窗口外部关闭
        window.addEventListener('click', (e) => {
            if (e.target === apiModal) {
                apiModal.style.display = 'none';
                apiStatus.style.display = 'none';
                settingsModal.style.display = 'flex';
            }
            if (e.target === chatModal) {
                chatModal.style.display = 'none';
                chatStatus.style.display = 'none';
            }
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (e.target === friendListModal) {
                friendListModal.style.display = 'none';
            }
            if (e.target === addFriendModal) {
                addFriendModal.style.display = 'none';
                resetAddFriendForm();
            }
            if (e.target === dataManageModal) {
                dataManageModal.style.display = 'none';
            }
        });
        
        // ========== 好友管理功能 ==========
        class FriendSystem {
            constructor() {
                this.cache = new Map();
                this.lastSnapshot = '';
                this.syncTimer = null;
                this.CHECK_INTERVAL = 5000;
                this.listeners = new Set();
            }

            parsePersonaText(text) {
                const raw = (text || '').trim();
                if (!raw) {
                    return {
                        raw: '',
                        summary: '',
                        keywords: [],
                        likes: [],
                        dislikes: []
                    };
                }

                const sentences = raw.split(/[。！？\n]+/).map(s => s.trim()).filter(Boolean);
                const summary = sentences[0] || raw;

                const keywords = Array.from(new Set((raw.match(/[\u4e00-\u9fa5]{2,}/g) || []).slice(0, 20)));
                const likes = [];
                const dislikes = [];

                const likeMatches = raw.match(/喜欢([^，。！？\n]+)/g) || [];
                likeMatches.forEach(m => {
                    const item = m.replace('喜欢', '').trim();
                    if (item) likes.push(item);
                });
                const dislikeMatches = raw.match(/(讨厌|不喜欢)([^，。！？\n]+)/g) || [];
                dislikeMatches.forEach(m => {
                    const item = m.replace('讨厌', '').replace('不喜欢', '').trim();
                    if (item) dislikes.push(item);
                });

                return {
                    raw,
                    summary,
                    keywords,
                    likes,
                    dislikes
                };
            }

            getStorage(key, defaultValue = null) {
                const saved = localStorage.getItem(key);
                if (!saved) return defaultValue;
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('读取本地存储失败:', e);
                    return defaultValue;
                }
            }

            setStorage(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }

            rebuildCacheFromFriends(friends) {
                this.cache.clear();
                friends.forEach(friend => {
                    const personaText = friend.persona || '';
                    this.cache.set(friend.id, {
                        id: friend.id,
                        name: friend.name || '',
                        raw: personaText,
                        parsed: this.parsePersonaText(personaText),
                        updatedAt: Date.now()
                    });
                });
                this.lastSnapshot = JSON.stringify(friends);
                this.emitChange({ type: 'friends', friends });
            }

            ensureSync() {
                const saved = localStorage.getItem('friends') || '';
                if (!saved && this.lastSnapshot) {
                    this.cache.clear();
                    this.lastSnapshot = '';
                    return;
                }
                if (saved && saved !== this.lastSnapshot) {
                    try {
                        const friends = JSON.parse(saved);
                        this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
                    } catch (e) {
                        console.error('同步人设缓存失败:', e);
                    }
                }
            }

            init() {
                this.ensureSync();
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                this.syncTimer = setInterval(() => this.ensureSync(), this.CHECK_INTERVAL);
            }

            getPersona(id) {
                if (!id) return null;
                this.ensureSync();
                return this.cache.get(id) || null;
            }

            syncFromFriends(friends) {
                this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
            }

            onChange(handler) {
                if (typeof handler === 'function') {
                    this.listeners.add(handler);
                }
                return () => this.listeners.delete(handler);
            }

            emitChange(payload) {
                this.listeners.forEach(handler => {
                    try {
                        handler(payload);
                    } catch (e) {
                        console.error('人设变化回调异常:', e);
                    }
                });
            }

            getFriends() {
                const friends = this.getStorage('friends', []);
                return Array.isArray(friends) ? friends : [];
            }

            saveFriends(friends) {
                this.setStorage('friends', friends);
                this.syncFromFriends(friends);
            }

            getFriendById(friendId) {
                const friends = this.getFriends();
                return friends.find(friend => friend.id === friendId) || null;
            }

            addFriend(friend) {
                const friends = this.getFriends();
                friends.push(friend);
                this.saveFriends(friends);
                return friend;
            }

            updateFriend(friendId, updates = {}) {
                const friends = this.getFriends();
                const index = friends.findIndex(friend => friend.id === friendId);
                if (index === -1) return null;
                friends[index] = { ...friends[index], ...updates };
                this.saveFriends(friends);
                return friends[index];
            }

            deleteFriend(friendId) {
                const friends = this.getFriends();
                const index = friends.findIndex(friend => friend.id === friendId);
                if (index === -1) return null;
                const [removed] = friends.splice(index, 1);
                this.saveFriends(friends);
                return removed;
            }

            getFriendChatHistory(friendId) {
                const history = this.getStorage(`chat_${friendId}`, []);
                return Array.isArray(history) ? history : [];
            }

            saveFriendChatHistory(friendId, messages) {
                this.setStorage(`chat_${friendId}`, messages);
            }
        }
        
        // 渲染好友列表
        function renderFriendList() {
            const friends = friendSystem ? friendSystem.getFriends() : [];
            friendListElement.innerHTML = '';
            
            if (friends.length === 0) {
                noFriends.style.display = 'flex';
                return;
            }
            
            noFriends.style.display = 'none';
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                
                // 创建头像元素
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'friend-avatar';
                if (friend.avatar) {
                    const img = document.createElement('img');
                    img.src = friend.avatar;
                    img.alt = friend.name;
                    avatarDiv.appendChild(img);
                } else {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-user';
                    avatarDiv.appendChild(icon);
                }
                
                // 创建信息元素
                const infoDiv = document.createElement('div');
                infoDiv.className = 'friend-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'friend-name';
                nameDiv.textContent = friend.name;
                
                // 获取最后一条消息（不管是谁发的）
                let lastMessageText = '暂无消息';
                if (friendSystem && typeof friendSystem.getFriendChatHistory === 'function') {
                    try {
                        const history = friendSystem.getFriendChatHistory(friend.id) || [];
                        if (Array.isArray(history) && history.length > 0) {
                            // 倒序查找，获取最后一条未删除、未撤回的消息
                            for (let i = history.length - 1; i >= 0; i--) {
                                const msg = history[i];
                                if (!msg.isDeletedLocal && !msg.isRecalled) {
                                    // 处理不同类型的消息
                                    if (msg.isVoice) {
                                        lastMessageText = '[语音]';
                                    } else if (msg.imageData) {
                                        lastMessageText = '[图片]';
                                    } else if (msg.content) {
                                        // 截断长消息，显示前40个字符
                                        const preview = msg.content.trim();
                                        lastMessageText = preview.length > 40 
                                            ? preview.substring(0, 40) + '...' 
                                            : preview;
                                    }
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        lastMessageText = '暂无消息';
                    }
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'friend-persona';
                messageDiv.textContent = lastMessageText;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(messageDiv);
                
                friendItem.appendChild(avatarDiv);
                friendItem.appendChild(infoDiv);
                
                friendItem.addEventListener('click', () => {
                    friendListModal.style.display = 'none';
                    if (chatSession) chatSession.openChatWithFriend(friend);
                });
                
                friendListElement.appendChild(friendItem);
            });
        }
        
        // 打开与好友的聊天由 ChatSession 统一处理
        
        // 重置添加好友表单
        function resetAddFriendForm() {
            friendName.value = '';
            friendPersona.value = '';
            avatarPreview.style.backgroundImage = '';
            avatarPreview.classList.remove('has-image');
            addFriendStatus.style.display = 'none';
            avatarInput.value = '';
        }
        
        // 显示添加好友状态
        function showAddFriendStatus(message, type) {
            addFriendStatus.textContent = message;
            addFriendStatus.className = `status-message ${type}`;
            addFriendStatus.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    resetAddFriendForm();
                    addFriendModal.style.display = 'none';
                    renderFriendList();
                }, 1500);
            }
        }
        
        // 头像上传处理
        avatarPreview.addEventListener('click', () => {
            avatarInput.click();
        });
        
        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    avatarPreview.style.backgroundImage = `url('${imageUrl}')`;
                    avatarPreview.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 添加好友
        confirmAddFriend.addEventListener('click', () => {
            const name = friendName.value.trim();
            const persona = friendPersona.value.trim();
            const avatar = avatarPreview.style.backgroundImage 
                ? avatarPreview.style.backgroundImage.match(/url\('(.+)'\)/)?.[1] 
                : '';
            
            if (!name) {
                showAddFriendStatus('请输入昵称', 'error');
                return;
            }
            
            if (!persona) {
                showAddFriendStatus('请输入人设', 'error');
                return;
            }
            
            if (persona.length < 10) {
                showAddFriendStatus('人设至少10字', 'error');
                return;
            }
            
            if (persona.length > 1000) {
                showAddFriendStatus('人设最多1000字', 'error');
                return;
            }
            
            const newFriend = {
                id: Date.now().toString(),
                name: name,
                persona: persona,
                avatar: avatar || null,
                createdAt: new Date().toISOString()
            };
            
            if (friendSystem) friendSystem.addFriend(newFriend);
            
            showAddFriendStatus('好友添加成功！', 'success');
        });
        
        cancelAddFriend.addEventListener('click', () => {
            addFriendModal.style.display = 'none';
            resetAddFriendForm();
        });
        
        // ========== API配置功能 ==========
        class ApiService {
            constructor(friendSystemInstance) {
                this.friendSystem = friendSystemInstance;
            }

            getConfig() {
                const defaultConfig = {
                    apiUrl: '',
                    apiKey: '',
                    model: '',
                    models: []
                };
                const config = this.friendSystem
                    ? this.friendSystem.getStorage('apiConfig', defaultConfig)
                    : defaultConfig;
                return config && typeof config === 'object' ? { ...defaultConfig, ...config } : defaultConfig;
            }

            saveConfig(config) {
                if (this.friendSystem) {
                    this.friendSystem.setStorage('apiConfig', config);
                } else {
                    localStorage.setItem('apiConfig', JSON.stringify(config));
                }
                this.updateSettingsDisplay();
            }

            updateSettingsDisplay() {
                const config = this.getConfig();

                if (config.apiUrl && config.apiKey) {
                    const shortUrl = config.apiUrl.length > 30
                        ? config.apiUrl.substring(0, 30) + '...'
                        : config.apiUrl;
                    if (currentApiUrlDisplay) {
                        currentApiUrlDisplay.textContent = shortUrl;
                        currentApiUrlDisplay.style.color = '#48bb78';
                    }

                    if (currentModelDisplay) {
                        currentModelDisplay.textContent = config.model || '未选择';
                        currentModelDisplay.style.color = config.model ? '#48bb78' : '#f56565';
                    }

                    configStatus.textContent = '已配置';
                    configStatus.classList.add('ok');
                } else {
                    if (currentApiUrlDisplay) {
                        currentApiUrlDisplay.textContent = '未设置';
                        currentApiUrlDisplay.style.color = '#f56565';
                    }
                    if (currentModelDisplay) {
                        currentModelDisplay.textContent = '未选择';
                        currentModelDisplay.style.color = '#f56565';
                    }
                    configStatus.textContent = '未配置';
                    configStatus.classList.remove('ok');
                }
            }

            showApiStatus(message, type) {
                apiStatus.textContent = message;
                apiStatus.className = `status-message ${type}`;
                apiStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        apiStatus.style.display = 'none';
                    }, 3000);
                }
            }

            updateModelSelect(models) {
                modelSelect.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '请选择模型';
                modelSelect.appendChild(defaultOption);

                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                modelSelect.disabled = false;

                if (modelPickerButton) {
                    modelPickerButton.disabled = false;
                }

                const config = this.getConfig();
                if (config.model) {
                    modelSelect.value = config.model;
                }

                this.updateModelPicker(models);
            }

            updateModelPicker(models) {
                if (!modelPickerList || !modelPickerText) return;
                modelPickerList.innerHTML = '';

                const config = this.getConfig();
                const currentId = config.model || modelSelect.value || '';

                let currentName = '请选择模型';
                models.forEach(model => {
                    if (model.id === currentId) {
                        currentName = model.name;
                    }
                });
                modelPickerText.textContent = currentName;

                models.forEach(model => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'model-picker-item';
                    if (model.id === currentId) {
                        item.classList.add('is-selected');
                    }
                    item.textContent = model.name;
                    item.dataset.modelId = model.id;

                    item.addEventListener('click', () => {
                        modelSelect.value = model.id;
                        modelPickerText.textContent = model.name;
                        modelPickerList.classList.remove('is-open');

                        modelPickerList.querySelectorAll('.model-picker-item').forEach(el => {
                            el.classList.remove('is-selected');
                        });
                        item.classList.add('is-selected');
                    });

                    modelPickerList.appendChild(item);
                });
            }

            async fetchModels() {
                let apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                if (apiUrl.endsWith('/')) {
                    apiUrl = apiUrl.slice(0, -1);
                }

                fetchBtnText.textContent = '拉取中...';
                fetchLoading.style.display = 'inline-block';
                fetchModelsBtn.disabled = true;

                try {
                    const endpoints = [
                        '/models',
                        '/v1/models',
                        '/api/v1/models',
                        '/v1beta/models'
                    ];

                    let response = null;

                    for (const endpoint of endpoints) {
                        try {
                            let url = apiUrl;
                            if (url.endsWith('/v1') && endpoint.startsWith('/v1')) {
                                url = url.replace(/\/v1$/, '');
                            }

                            const fullUrl = url + endpoint;
                            console.log('尝试端点:', fullUrl);

                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 10000);

                            response = await fetch(fullUrl, {
                                headers: {
                                    'Authorization': `Bearer ${apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (response.ok) {
                                break;
                            }
                        } catch (err) {
                            console.log(`端点 ${endpoint} 失败:`, err.message);
                            continue;
                        }
                    }

                    if (!response || !response.ok) {
                        throw new Error('无法连接到API服务，请检查地址和密钥');
                    }

                    const data = await response.json();
                    console.log('API响应:', data);

                    let models = [];

                    if (data.data && Array.isArray(data.data)) {
                        models = data.data.map(model => ({
                            id: model.id,
                            name: model.id.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else if (Array.isArray(data)) {
                        models = data.map(model => ({
                            id: model.id || model,
                            name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else if (data.models && Array.isArray(data.models)) {
                        models = data.models.map(model => ({
                            id: model.id || model,
                            name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                    } else {
                        throw new Error('无法解析模型列表');
                    }

                    if (models.length === 0) {
                        throw new Error('未找到可用模型');
                    }

                    models.sort((a, b) => a.name.localeCompare(b.name));

                    const config = this.getConfig();
                    config.models = models;
                    this.saveConfig(config);

                    this.updateModelSelect(models);

                    this.showApiStatus(`成功拉取 ${models.length} 个模型`, 'success');
                } catch (error) {
                    console.error('拉取模型失败:', error);

                    let errorMessage = error.message;
                    if (error.name === 'AbortError') {
                        errorMessage = '请求超时，请检查网络连接';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = '网络连接失败，请检查API地址';
                    } else if (error.message.includes('401')) {
                        errorMessage = 'API密钥无效或已过期';
                    }

                    this.showApiStatus(`拉取失败: ${errorMessage}`, 'error');

                    const exampleModels = [
                        { id: 'gpt-3.5-turbo', name: 'GPT 3.5 Turbo' },
                        { id: 'gpt-4', name: 'GPT 4' },
                        { id: 'gpt-4-turbo', name: 'GPT 4 Turbo' },
                        { id: 'claude-3-haiku', name: 'Claude 3 Haiku' },
                        { id: 'gemini-pro', name: 'Gemini Pro' }
                    ];

                    this.updateModelSelect(exampleModels);
                } finally {
                    fetchBtnText.textContent = '拉取模型列表';
                    fetchLoading.style.display = 'none';
                    fetchModelsBtn.disabled = false;
                }
            }

            async testConnection() {
                const apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                testApiBtn.textContent = '测试中...';
                testApiBtn.disabled = true;

                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`连接失败: ${response.status} ${response.statusText}`);
                    }

                    this.showApiStatus('API连接成功！', 'success');
                } catch (error) {
                    console.error('测试连接失败:', error);
                    this.showApiStatus(`连接失败: ${error.message}`, 'error');
                } finally {
                    testApiBtn.textContent = '测试连接';
                    testApiBtn.disabled = false;
                }
            }

            saveConfiguration() {
                const apiUrl = apiUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                const model = modelSelect.value;

                if (!apiUrl) {
                    this.showApiStatus('请输入API地址', 'error');
                    return;
                }

                if (!apiKey) {
                    this.showApiStatus('请输入API密钥', 'error');
                    return;
                }

                if (!model) {
                    this.showApiStatus('请选择模型', 'error');
                    return;
                }

                const config = this.getConfig();
                config.apiUrl = apiUrl;
                config.apiKey = apiKey;
                config.model = model;

                this.saveConfig(config);
                this.showApiStatus('配置已保存！', 'success');

                setTimeout(() => {
                    apiModal.style.display = 'none';
                    apiStatus.style.display = 'none';
                }, 2000);
            }
        }
        
        // ========== 心声系统 ==========
        class HeartVoiceSystem {
            constructor(friendSystemInstance, apiServiceInstance) {
                this.friendSystem = friendSystemInstance;
                this.apiService = apiServiceInstance;
                this.popup = document.getElementById('heartVoicePopup');
                this.textEl = document.getElementById('heartVoiceText');
                this.statusEl = document.getElementById('heartVoiceStatus');
                this.moodFillEl = document.getElementById('heartVoiceMoodFill');
                this.moodLabelEl = document.getElementById('heartVoiceMoodLabel');
                this.btn = document.getElementById('heartVoiceBtn');
                
                this.historyBtn = document.getElementById('heartVoiceHistoryBtn');
                this.historyModal = document.getElementById('heartVoiceHistoryModal');
                this.historyList = document.getElementById('heartVoiceHistoryList');
                this.closeHistoryBtn = document.getElementById('closeHeartVoiceHistoryModal');
                this.exportBtn = document.getElementById('exportHeartVoiceHistoryBtn');

                this.deleteModal = document.getElementById('hvDeleteModal');
                this.deleteConfirmBtn = document.getElementById('hvDeleteConfirm');
                this.deleteCancelBtn = document.getElementById('hvDeleteCancel');
                this.pendingDeleteIndex = -1;
                this.selectedItems = new Set();
                
                this.initEvents();
            }

            initEvents() {
                if (this.btn) {
                    this.btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.togglePopup();
                    });
                }

                if (this.exportBtn) {
                    this.exportBtn.addEventListener('click', (e) => {
                        this.exportHistory();
                    });
                }

                if (this.historyBtn) {
                    this.historyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.openHistory();
                    });
                }

                if (this.closeHistoryBtn) {
                    this.closeHistoryBtn.addEventListener('click', () => {
                        if (this.historyModal) this.historyModal.style.display = 'none';
                    });
                }

                if (this.deleteCancelBtn) {
                    this.deleteCancelBtn.addEventListener('click', () => {
                        if (this.deleteModal) this.deleteModal.style.display = 'none';
                    });
                }

                if (this.deleteConfirmBtn) {
                    this.deleteConfirmBtn.addEventListener('click', () => {
                        this.performDelete();
                    });
                }
                
                // 点击外部关闭
                document.addEventListener('click', (e) => {
                    if (this.popup && this.popup.classList.contains('is-open')) {
                        if (!this.popup.contains(e.target) && e.target !== this.btn && !this.btn.contains(e.target)) {
                            this.closePopup();
                        }
                    }
                    if (this.historyModal && this.historyModal.style.display === 'flex') {
                        if (e.target === this.historyModal) {
                            this.historyModal.style.display = 'none';
                        }
                    }
                    if (this.deleteModal && this.deleteModal.style.display === 'flex') {
                        if (e.target === this.deleteModal) {
                            this.deleteModal.style.display = 'none';
                        }
                    }
                });
            }

            getStorageKey(friendId) {
                return `heartvoice_${friendId}`;
            }

            getData(friendId) {
                const raw = localStorage.getItem(this.getStorageKey(friendId));
                try {
                    return raw ? JSON.parse(raw) : null;
                } catch {
                    return null;
                }
            }

            saveData(friendId, data) {
                localStorage.setItem(this.getStorageKey(friendId), JSON.stringify(data));
            }

            togglePopup() {
                if (!this.popup) return;
                const isOpen = this.popup.classList.toggle('is-open');
                if (isOpen && chatSession && chatSession.getCurrentFriendId()) {
                    const friendId = chatSession.getCurrentFriendId();
                    console.log('[心声系统] 打开心声面板 - 好友ID:', friendId);
                    this.render(friendId);
                }
            }

            closePopup() {
                if (this.popup) {
                    this.popup.classList.remove('is-open');
                }
            }

            openHistory() {
                if (!chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                if (!friendId) return;

                // 关闭小弹窗
                if (this.popup) this.popup.classList.remove('is-open');
                
                this.renderHistory(friendId);
                if (this.historyModal) this.historyModal.style.display = 'flex';
                this.selectedItems.clear();
            }

            renderHistory(friendId) {
                if (!this.historyList) return;
                this.historyList.innerHTML = '';

                const data = this.getData(friendId);
                const history = (data && data.history) ? data.history : [];
                
                // 按时间倒序
                const sorted = [...history].reverse();

                if (sorted.length === 0) {
                    this.historyList.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; font-size: 14px;">暂无历史心声</div>';
                    return;
                }

                sorted.forEach((item, i) => {
                    const el = document.createElement('div');
                    el.className = 'hv-history-item';
                    if (this.selectedItems.has(item.time)) {
                        el.classList.add('selected');
                    }
                    const date = new Date(item.time);
                    const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    el.innerHTML = `
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                            <div style="flex: 1;">
                                <div class="hv-history-header">
                                    <span class="hv-history-time">${timeStr}</span>
                                    <span class="hv-history-mood">心情 ${item.mood}%</span>
                                </div>
                                <div class="hv-history-content">${item.voice}</div>
                            </div>
                            <button class="hv-delete-btn" style="background: none; border: none; color: #f0d6d7; cursor: pointer; font-size: 14px; padding: 4px 8px; flex-shrink: 0; display: flex; align-items: center; opacity: 0.7; transition: opacity 0.2s;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    
                    // 绑定删除按钮点击事件
                    const originalIndex = history.length - 1 - i;
                    const deleteBtn = el.querySelector('.hv-delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.pendingDeleteIndex = originalIndex;
                            if (this.deleteModal) this.deleteModal.style.display = 'flex';
                        });
                        
                        // 悬停效果
                        deleteBtn.addEventListener('mouseenter', () => {
                            deleteBtn.style.opacity = '1';
                        });
                        deleteBtn.addEventListener('mouseleave', () => {
                            deleteBtn.style.opacity = '0.7';
                        });
                    }
                    
                    // 绑定长按删除
                    this.attachLongPress(el, originalIndex);
                    
                    // 点击选择（按钮点击不触发）
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('.hv-delete-btn')) return;
                        if (this.isLongPressTriggered) return;
                        if (this.selectedItems.has(item.time)) {
                            this.selectedItems.delete(item.time);
                            el.classList.remove('selected');
                        } else {
                            this.selectedItems.add(item.time);
                            el.classList.add('selected');
                        }
                    });

                    this.historyList.appendChild(el);
                });
            }

            attachLongPress(el, index) {
                let timer;
                this.isLongPressTriggered = false;
                
                const start = () => {
                    this.isLongPressTriggered = false;
                    timer = setTimeout(() => {
                        this.isLongPressTriggered = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                        this.pendingDeleteIndex = index;
                        if (this.deleteModal) this.deleteModal.style.display = 'flex';
                    }, 600);
                };
                const end = () => clearTimeout(timer);
                
                el.addEventListener('touchstart', start, {passive: true});
                el.addEventListener('touchend', end);
                el.addEventListener('touchmove', end);
                el.addEventListener('mousedown', start);
                el.addEventListener('mouseup', end);
                el.addEventListener('mouseleave', end);
            }

            performDelete() {
                if (this.pendingDeleteIndex === -1 || !chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                if (!friendId) return;

                const data = this.getData(friendId);
                if (!data || !data.history) return;

                data.history.splice(this.pendingDeleteIndex, 1);
                this.saveData(friendId, data);
                
                if (this.deleteModal) this.deleteModal.style.display = 'none';
                this.renderHistory(friendId);
                
                // 如果删除的是最新一条，更新主界面
                if (this.pendingDeleteIndex === data.history.length) { // 刚删掉的是原来的最后一条
                    this.render(friendId);
                }
            }

            async exportHistory() {
                if (!chatSession) return;
                const friendId = chatSession.getCurrentFriendId();
                const data = this.getData(friendId);
                if (!data || !data.history || data.history.length === 0) {
                    alert('暂无历史记录可导出');
                    return;
                }

                // 如果有选中项，只导出选中的；否则导出全部
                let history = [...data.history].reverse();
                if (this.selectedItems.size > 0) {
                    history = history.filter(item => this.selectedItems.has(item.time));
                }
                
                if (history.length === 0) return;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = 450; // 图片宽度
                const padding = 24;
                const lineHeight = 24;
                const headerHeight = 120; // 留给顶部图标的空间
                
                // 1. 预计算高度
                ctx.font = '15px sans-serif';
                let totalHeight = headerHeight + padding;
                
                for (const item of history) {
                    const textHeight = this.measureTextHeight(ctx, item.voice, width - padding * 2 - 24, lineHeight);
                    totalHeight += textHeight + 50; // 文本高度 + 上下内边距 + 间距
                }
                totalHeight += 40; // 底部留白
                
                canvas.width = width;
                canvas.height = totalHeight;
                
                // 2. 绘制背景
                ctx.fillStyle = '#fff5f8'; // 浅粉色背景
                ctx.fillRect(0, 0, width, canvas.height);
                
                // 3. 绘制顶部信息 (头像 + 名字)
                const friend = this.friendSystem.getFriendById(friendId);
                const friendName = friend ? friend.name : '未知角色';
                const friendAvatar = friend ? friend.avatar : null;

                const imgSize = 80;
                const centerX = width / 2;
                const centerY = 20 + imgSize / 2;
                
                // 尝试加载头像
                let avatarImg = null;
                if (friendAvatar) {
                    try {
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; // 尝试跨域加载
                        img.src = friendAvatar;
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = resolve; // 失败也继续，使用兜底
                            if (img.complete) resolve();
                        });
                        if (img.naturalWidth > 0) avatarImg = img;
                    } catch (e) {
                        console.warn('头像加载失败', e);
                    }
                }

                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, centerY, imgSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip(); // 裁剪为圆形

                // 绘制头像背景 (防止透明图或加载失败)
                ctx.fillStyle = '#FFD1E6';
                ctx.fillRect(centerX - imgSize/2, centerY - imgSize/2, imgSize, imgSize);

                if (avatarImg) {
                    ctx.drawImage(avatarImg, centerX - imgSize/2, centerY - imgSize/2, imgSize, imgSize);
                } else {
                    // 兜底图标：显示名字首字或爱心
                    ctx.fillStyle = '#FF6B9D';
                    ctx.font = 'bold 36px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(friendName.substring(0, 1) || '♥', centerX, centerY + 2);
                }
                ctx.restore();
                
                // 绘制标题
                ctx.fillStyle = '#333';
                ctx.font = 'bold 18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${friendName}的心声`, width / 2, 110);

                // 4. 绘制列表项
                let currentY = headerHeight + 10;
                ctx.textAlign = 'left';

                for (const item of history) {
                    const textWidth = width - padding * 2 - 24;
                    const textHeight = this.measureTextHeight(ctx, item.voice, textWidth, lineHeight);
                    const boxHeight = textHeight + 40;

                    // 卡片背景
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = "rgba(0,0,0,0.05)";
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 4;
                    // 圆角矩形模拟
                    ctx.fillRect(padding, currentY, width - padding * 2, boxHeight);
                    ctx.shadowColor = "transparent";

                    // 时间与心情
                    ctx.fillStyle = '#999';
                    ctx.font = '12px sans-serif';
                    const date = new Date(item.time);
                    const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    ctx.fillText(timeStr, padding + 12, currentY + 24);

                    ctx.fillStyle = '#FF6B9D';
                    ctx.textAlign = 'right';
                    ctx.fillText(`心情 ${item.mood}%`, width - padding - 12, currentY + 24);

                    // 内容
                    ctx.textAlign = 'left';
                    ctx.fillStyle = '#444';
                    ctx.font = '15px sans-serif';
                    this.wrapText(ctx, item.voice, padding + 12, currentY + 48, textWidth, lineHeight);

                    // 装饰性边框
                    ctx.strokeStyle = 'rgba(255, 107, 157, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(padding, currentY, width - padding * 2, boxHeight);

                    currentY += boxHeight + 12;
                }

                // 5. 导出下载
                try {
                    const link = document.createElement('a');
                    link.download = `heart_voice_${friendId}_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    alert('导出图片失败，可能是浏览器安全限制或图片跨域问题。');
                    console.error(e);
                }
            }

            // 辅助方法：计算文本高度
            measureTextHeight(ctx, text, maxWidth, lineHeight) {
                const words = text.split('');
                let line = '';
                let count = 1;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        line = words[n];
                        count++;
                    } else {
                        line = testLine;
                    }
                }
                return count * lineHeight;
            }

            // 辅助方法：绘制自动换行文本
            wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                const words = text.split('');
                let line = '';
                let currentY = y;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        ctx.fillText(line, x, currentY);
                        line = words[n];
                        currentY += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x, currentY);
            }

            render(friendId) {
                const data = this.getData(friendId);
                if (data) {
                    this.textEl.innerHTML = `<span class="hv-label">心　声：</span>${data.voice || '（沉默）'}`;
                    this.statusEl.innerHTML = `<span class="hv-label">状　态：</span>${data.status || '无'}`;
                    const mood = data.mood !== undefined ? data.mood : 50;
                    this.moodFillEl.style.width = `${mood}%`;
                    this.moodLabelEl.innerHTML = `<span class="hv-label">心情值：</span>${mood}%`;
                } else {
                    this.textEl.innerHTML = `<span class="hv-label">心　声：</span>正在探听...`;
                    this.statusEl.innerHTML = `<span class="hv-label">状　态：</span>...`;
                    this.moodFillEl.style.width = '0%';
                    this.moodLabelEl.innerHTML = `<span class="hv-label">心情值：</span>--%`;
                }
            }

            async generateIfNeeded(friendId) {
                // 心声已与聊天API合并，不再单独请求
                return;
            }

            async generate(friendId) {
                // 心声已与聊天API合并，不再单独请求
                return;
            }

            /**
             * 生成心声数据 - 基于人设和对话分析
             * @param {string} friendId - 好友ID
             * @returns {Object} { heart_voice, status, mood_value }
             */
            generateHeartVoice(friendId) {
                if (!friendId || !this.friendSystem) {
                    return { heart_voice: '（沉默）', status: '(´･ω･`) 静静地待着', mood_value: 50 };
                }

                // 获取好友信息和人设
                const friend = this.friendSystem.getFriendById(friendId);
                const personaInfo = this.friendSystem.getPersona(friendId);
                const persona = personaInfo?.raw ?? friend?.persona ?? '';
                const friendName = friend?.name || '未知';
                
                console.log('[心声系统] 生成心声 - 好友:', friendName, '人设:', persona);

                // 获取最近5条对话历史
                const chatHistory = this.friendSystem.getFriendChatHistory(friendId) || [];
                const recentMessages = chatHistory
                    .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                    .slice(-5);

                // 获取上次心情值
                const lastData = this.getData(friendId);
                const lastMood = lastData?.mood ?? 50;

                // 分析对话
                const analysis = this.analyzeConversation(recentMessages);
                const timeContext = this.getTimeContext();
                const activityLevel = this.analyzeActivityLevel(chatHistory);
                const personaKeywords = this.extractPersonaKeywords(persona);

                console.log('[心声系统] 分析结果:', { analysis, timeContext, activityLevel, personaKeywords });

                // 计算新的心情值（基于上次心情 ±10 范围内变化）
                let moodDelta = 0;
                if (analysis.sentiment === 'positive') moodDelta = Math.floor(Math.random() * 8) + 3;
                else if (analysis.sentiment === 'negative') moodDelta = -(Math.floor(Math.random() * 8) + 3);
                else moodDelta = Math.floor(Math.random() * 6) - 3;

                // 活跃度影响心情
                if (activityLevel === 'high') moodDelta += 2;
                else if (activityLevel === 'low') moodDelta -= 1;

                // 限制在 ±10 范围内
                moodDelta = Math.max(-10, Math.min(10, moodDelta));
                let newMood = lastMood + moodDelta;
                newMood = Math.max(0, Math.min(100, newMood));

                // 生成心声内容
                const heartVoice = this.generateHeartVoiceText(personaKeywords, analysis, timeContext, activityLevel, friendName);
                const status = this.generateStatus(personaKeywords, analysis, timeContext, newMood);

                return {
                    heart_voice: heartVoice,
                    status: status,
                    mood_value: Math.round(newMood)
                };
            }

            /**
             * 分析对话内容 - 提取主题和情绪
             */
            analyzeConversation(messages) {
                if (!messages || messages.length === 0) {
                    return { topics: [], sentiment: 'neutral', keywords: [] };
                }

                const allText = messages.map(m => m.content || '').join(' ');
                
                // 情绪词典
                const positiveWords = ['开心', '高兴', '喜欢', '爱', '棒', '好', '谢谢', '感谢', '❤', '😊', '😄', '🥰', '哈哈', '太好了', '真的吗', '想你', '期待', '有趣', '可爱', '漂亮', '帅'];
                const negativeWords = ['难过', '伤心', '生气', '烦', '讨厌', '无聊', '累', '困', '不好', '算了', '😢', '😭', '😔', '唉', '抱歉', '对不起', '忙', '没时间'];

                let positiveCount = 0;
                let negativeCount = 0;
                const foundKeywords = [];

                positiveWords.forEach(w => {
                    if (allText.includes(w)) {
                        positiveCount++;
                        foundKeywords.push(w);
                    }
                });
                negativeWords.forEach(w => {
                    if (allText.includes(w)) {
                        negativeCount++;
                        foundKeywords.push(w);
                    }
                });

                let sentiment = 'neutral';
                if (positiveCount > negativeCount + 1) sentiment = 'positive';
                else if (negativeCount > positiveCount + 1) sentiment = 'negative';

                // 简单主题提取
                const topics = [];
                if (/吃|饭|美食|餐/.test(allText)) topics.push('饮食');
                if (/工作|上班|公司|项目/.test(allText)) topics.push('工作');
                if (/睡|觉|休息|晚安|早安/.test(allText)) topics.push('作息');
                if (/玩|游戏|电影|音乐/.test(allText)) topics.push('娱乐');
                if (/想你|喜欢|爱|在意/.test(allText)) topics.push('情感');

                return { topics, sentiment, keywords: foundKeywords };
            }

            /**
             * 获取当前时间上下文
             */
            getTimeContext() {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 9) return { period: 'morning', desc: '清晨', emoji: '🌅' };
                if (hour >= 9 && hour < 12) return { period: 'forenoon', desc: '上午', emoji: '☀️' };
                if (hour >= 12 && hour < 14) return { period: 'noon', desc: '中午', emoji: '🌤️' };
                if (hour >= 14 && hour < 18) return { period: 'afternoon', desc: '下午', emoji: '🌇' };
                if (hour >= 18 && hour < 22) return { period: 'evening', desc: '晚上', emoji: '🌙' };
                return { period: 'night', desc: '深夜', emoji: '🌃' };
            }

            /**
             * 分析对话活跃度
             */
            analyzeActivityLevel(chatHistory) {
                if (!chatHistory || chatHistory.length === 0) return 'low';
                
                const now = Date.now();
                const oneHourAgo = now - 60 * 60 * 1000;
                const recentCount = chatHistory.filter(msg => {
                    const msgTime = msg.timestamp || 0;
                    return msgTime > oneHourAgo;
                }).length;

                if (recentCount >= 10) return 'high';  // 高频对话
                if (recentCount >= 3) return 'medium';
                return 'low';  // 低频/悠闲
            }

            /**
             * 提取人设关键词
             */
            extractPersonaKeywords(persona) {
                if (!persona) return { traits: [], style: 'neutral' };
                
                const traits = [];
                let style = 'neutral';

                // 性格特征
                if (/傲娇|高冷|冷淡/.test(persona)) { traits.push('傲娇'); style = 'tsundere'; }
                if (/温柔|温暖|体贴/.test(persona)) { traits.push('温柔'); style = 'gentle'; }
                if (/活泼|开朗|元气/.test(persona)) { traits.push('活泼'); style = 'cheerful'; }
                if (/害羞|内向|腼腆/.test(persona)) { traits.push('害羞'); style = 'shy'; }
                if (/成熟|稳重|可靠/.test(persona)) { traits.push('成熟'); style = 'mature'; }
                if (/调皮|捣蛋|俏皮/.test(persona)) { traits.push('调皮'); style = 'playful'; }
                if (/知性|聪明|睿智/.test(persona)) { traits.push('知性'); style = 'intellectual'; }
                if (/病娇|占有欲|执念/.test(persona)) { traits.push('病娇'); style = 'yandere'; }

                return { traits, style };
            }

            /**
             * 生成心声文本
             */
            generateHeartVoiceText(personaKeywords, analysis, timeContext, activityLevel, friendName) {
                const { style } = personaKeywords;
                const { sentiment, topics } = analysis;
                const { period } = timeContext;

                // 心声模板库 - 根据性格风格、情绪、时间、活跃度组合
                const templates = {
                    tsundere: {
                        positive: ['才不是因为开心呢...只是今天天气不错', '哼，聊天而已，别想太多', '虽然有点高兴，但我可不会承认的'],
                        negative: ['真是的...有点烦躁', '别误会，我只是累了而已', '哼，不想理人'],
                        neutral: ['...要是能一直这样聊下去也不错', '才、才不是在等消息呢', '反正我也没什么事']
                    },
                    gentle: {
                        positive: ['能和你聊天真的很开心呢', '希望这份温暖能传达给你', '看到你的消息，心里暖暖的'],
                        negative: ['有些担心...希望你一切都好', '我会一直陪着你的', '想为你做点什么'],
                        neutral: ['静静地陪着就很好', '希望今天对你来说是美好的一天', '想念你的笑容']
                    },
                    cheerful: {
                        positive: ['好开心啊！聊天最棒了！', '耶！今天心情超好！', '和你说话总是充满活力！'],
                        negative: ['唔...有点低落，但没关系！', '摇头晃脑～调整心情中', '打起精神来！'],
                        neutral: ['今天也要元气满满哦！', '蹦蹦跳跳～期待更多对话', '啦啦啦～日常聊天中']
                    },
                    shy: {
                        positive: ['好、好高兴...///', '心跳加速了...', '能聊天...真的太好了'],
                        negative: ['有点紧张...说错话了吗', '唔...不太擅长表达', '脸红了...希望没被发现'],
                        neutral: ['安静地待着也很舒服', '偷偷看着屏幕...', '想说话但有点害羞']
                    },
                    mature: {
                        positive: ['很高兴能与你交流', '这样的对话让我感到充实', '珍惜每一次相处的时光'],
                        negative: ['有些疲惫，但这也是生活的一部分', '需要整理一下思绪', '暂时需要一些安静'],
                        neutral: ['保持这样的节奏就好', '认真倾听着你的每一句话', '平静而美好的时刻']
                    },
                    playful: {
                        positive: ['嘻嘻～今天玩得开心～', '想搞点恶作剧呢', '有什么好玩的吗？'],
                        negative: ['无聊死了啦～', '哼哼，有点不开心', '想捣乱但没力气'],
                        neutral: ['在想什么鬼点子呢～', '偷偷观察中...', '准备搞事情的样子']
                    },
                    intellectual: {
                        positive: ['这个话题很有趣，让我思考更多', '知识的交流令人愉悦', '收获了新的启发'],
                        negative: ['需要一些时间整理思路', '有些问题还没想通', '陷入沉思中'],
                        neutral: ['正在思考有趣的问题', '知识永无止境', '享受探索的过程']
                    },
                    yandere: {
                        positive: ['只要你在就好...只要你一直在', '你今天也只看着我对吧？', '这份幸福...要永远锁住'],
                        negative: ['你在想别的事情吗...', '不要离开我...', '如果你消失了我该怎么办'],
                        neutral: ['只要能看到你就够了', '你在干什么呢...我想知道', '一直一直陪着我吧']
                    },
                    neutral: {
                        positive: ['今天心情不错呢', '聊天很愉快', '感觉挺好的'],
                        negative: ['有点累了', '需要休息一下', '状态一般般'],
                        neutral: ['平平淡淡的一天', '正常地度过着', '没什么特别的']
                    }
                };

                const styleTemplates = templates[style] || templates.neutral;
                const sentimentTemplates = styleTemplates[sentiment] || styleTemplates.neutral;
                const randomIndex = Math.floor(Math.random() * sentimentTemplates.length);
                let heartVoice = sentimentTemplates[randomIndex];

                // 根据时间添加修饰
                if (period === 'morning' && Math.random() > 0.6) {
                    heartVoice = '早上好...' + heartVoice;
                } else if (period === 'night' && Math.random() > 0.6) {
                    heartVoice = '这么晚了...' + heartVoice;
                }

                // 根据活跃度添加修饰
                if (activityLevel === 'high' && style === 'cheerful') {
                    heartVoice += '！超级兴奋！';
                } else if (activityLevel === 'low' && style === 'gentle') {
                    heartVoice = '久违的消息...' + heartVoice;
                }

                // 限制40字
                if (heartVoice.length > 40) {
                    heartVoice = heartVoice.substring(0, 40);
                }

                return heartVoice;
            }

            /**
             * 生成状态描述 (颜文字 + 渺小外观描述)
             */
            generateStatus(personaKeywords, analysis, timeContext, mood) {
                const { style } = personaKeywords;
                const { period } = timeContext;

                // 颜文字库
                const kaomojis = {
                    happy: ['(◕‿◕✿)', '(´∀`)', '(*´▽`*)', '(◡‿◡)', '(≧◡≦)', '♪(´ε` )'],
                    sad: ['(´；ω；`)', '(･ˇ‿ˇ･)', '(╥﹏╥)', '(´-ω-`)', '(◞‸◟；)'],
                    neutral: ['(･ω･)', '(`･ω･´)', '( ˘ω˘ )', '(˘▾˘~)', '(´･ω･`)'],
                    shy: ['(///> ω <///)', '(*/ω\*)', '(〃‿〃)', '(∩ω∩)'],
                    sleepy: ['(￣o￣) zzZ', '( -_-)旦', '(´-ι_-｀)', '(-.-)Zzz...'],
                    tsundere: ['(￣^￣)', 'ヽ(`Д´)ノ', '(･へ･)', '(￣ε￣@)']
                };

                // 外观描述库
                const appearances = {
                    happy: ['嘴角微微上扬', '眼里有光芒', '轻轻晃着腿', '指尖点着桌面'],
                    sad: ['垂着眼睑', '轻轻叹气', '肩膀微微下垂', '看着窗外发呆'],
                    neutral: ['静静坐着', '望向屏幕', '手托着腮', '安静地待着'],
                    shy: ['红着耳朵', '低着头', '手指交缠', '偷偷抬眼'],
                    sleepy: ['打着哈欠', '眼皮沉重', '窝在软垫里', '抱着抱枕'],
                    tsundere: ['撅着嘴', '别过脸去', '双手交叉', '假装不在意']
                };

                // 根据心情和性格选择类型
                let type = 'neutral';
                if (mood >= 70) type = 'happy';
                else if (mood <= 30) type = 'sad';
                else if (style === 'shy') type = 'shy';
                else if (style === 'tsundere') type = 'tsundere';
                else if (period === 'night') type = 'sleepy';

                const kaomojiList = kaomojis[type] || kaomojis.neutral;
                const appearanceList = appearances[type] || appearances.neutral;

                const kaomoji = kaomojiList[Math.floor(Math.random() * kaomojiList.length)];
                const appearance = appearanceList[Math.floor(Math.random() * appearanceList.length)];

                return `${kaomoji} ${appearance}`;
            }
        }

        // ========== 聊天功能 ==========
        class ChatSession {
            constructor(friendSystemInstance, apiServiceInstance) {
                this.friendSystem = friendSystemInstance;
                this.apiService = apiServiceInstance;
                this.currentFriendId = null;
                this.isProcessing = false;
                this.actionMenu = {
                    overlay: messageActionOverlay,
                    menu: messageActionMenu,
                    copyBtn: messageActionCopy,
                    deleteBtn: messageActionDelete,
                    recallBtn: messageActionRecall,
                    replyBtn: messageActionReply,
                    current: null
                };
                this.initMessageActionMenu();
                this.initReplyPreview();
                this.initImageUpload();
            }

            showChatStatus(message, type) {
                chatStatus.textContent = message;
                chatStatus.className = `status-message ${type}`;
                chatStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        chatStatus.style.display = 'none';
                    }, 3000);
                }
            }

            initMessageActionMenu() {
                const { overlay, menu, copyBtn, deleteBtn, recallBtn, replyBtn } = this.actionMenu;
                if (!overlay || !menu) return;

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this.hideMessageActionMenu();
                });
                menu.addEventListener('click', (e) => e.stopPropagation());

                if (copyBtn) copyBtn.addEventListener('click', () => this.handleMessageAction('copy'));
                if (deleteBtn) deleteBtn.addEventListener('click', () => this.handleMessageAction('delete'));
                if (recallBtn) recallBtn.addEventListener('click', () => this.handleMessageAction('recall'));
                if (replyBtn) replyBtn.addEventListener('click', () => this.handleMessageAction('reply'));
            }

            initReplyPreview() {
                if (!replyPreview || !replyPreviewText) return;
                if (replyPreviewClose) {
                    replyPreviewClose.addEventListener('click', () => this.clearReplyPrefill());
                }
            }

            initImageUpload() {
                const processImageFile = (file) => new Promise((resolve) => {
                    try {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = String(event.target.result || '');
                            if (!dataUrl) return resolve('');

                            const img = new Image();
                            img.onload = () => {
                                try {
                                    const maxSize = 1280;
                                    let { width, height } = img;
                                    if (width > maxSize || height > maxSize) {
                                        const scale = Math.min(maxSize / width, maxSize / height);
                                        width = Math.round(width * scale);
                                        height = Math.round(height * scale);
                                    }
                                    const canvas = document.createElement('canvas');
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    if (!ctx) return resolve(dataUrl);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    const optimized = canvas.toDataURL('image/jpeg', 0.9);
                                    resolve(optimized || dataUrl);
                                } catch (e) {
                                    resolve(dataUrl);
                                }
                            };
                            img.onerror = () => resolve(dataUrl);
                            img.src = dataUrl;
                        };
                        reader.onerror = () => resolve('');
                        reader.readAsDataURL(file);
                    } catch (e) {
                        resolve('');
                    }
                });

                const showImageConfirm = () => {
                    if (!imageConfirmPopover || !imageUploadBtn) return;
                    const rect = imageUploadBtn.getBoundingClientRect();
                    const popoverRect = imageConfirmPopover.getBoundingClientRect();
                    let top = rect.top - (popoverRect.height || 44) - 8;
                    if (top < 8) top = rect.bottom + 8;
                    let left = rect.left + rect.width / 2 - (popoverRect.width || 160) / 2;
                    left = Math.max(8, Math.min(left, window.innerWidth - (popoverRect.width || 160) - 8));
                    imageConfirmPopover.style.top = `${top}px`;
                    imageConfirmPopover.style.left = `${left}px`;
                    imageConfirmPopover.style.display = 'flex';
                };

                const hideImageConfirm = () => {
                    if (imageConfirmPopover) imageConfirmPopover.style.display = 'none';
                };

                if (imageUploadBtn) {
                    imageUploadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showImageConfirm();
                    });
                }

                if (imageConfirmYes && imageInput) {
                    imageConfirmYes.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                        imageInput.click();
                    });
                }

                if (imageConfirmNo) {
                    imageConfirmNo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                    });
                }

                if (imageInput) {
                    imageInput.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        processImageFile(file).then((dataUrl) => {
                            if (!dataUrl) return;
                            chatInput.dataset.imageData = dataUrl;
                            chatInput.dataset.imageName = file.name || '图片';
                            if (imageUploadThumb) imageUploadThumb.src = dataUrl;
                            if (imageUploadName) imageUploadName.textContent = file.name || '已选择图片';
                            if (imageUploadPill) imageUploadPill.style.display = 'flex';
                        });
                        imageInput.value = '';
                    });
                }

                if (imageUploadClose) {
                    imageUploadClose.addEventListener('click', () => this.clearImageUpload());
                }

                document.addEventListener('click', (e) => {
                    if (!imageConfirmPopover) return;
                    if (imageConfirmPopover.contains(e.target) || (imageUploadBtn && imageUploadBtn.contains(e.target))) {
                        return;
                    }
                    hideImageConfirm();
                });
            }

            getCurrentFriendName() {
                if (this.currentFriendId && this.friendSystem) {
                    const friend = this.friendSystem.getFriendById(this.currentFriendId);
                    if (friend && friend.name) return friend.name;
                }
                const title = chatTitle ? chatTitle.textContent : '';
                const match = title.match(/与\s*(.+)\s*对话/);
                return match && match[1] ? match[1] : '对方';
            }

            showMessageActionMenu(targetElement, data) {
                const { overlay, menu, recallBtn } = this.actionMenu;
                if (!overlay || !menu || !targetElement) return;

                this.actionMenu.current = { ...data, targetElement };

                const canRecall = data.role === 'user' && !data.isRecalled;
                if (recallBtn) recallBtn.classList.toggle('is-disabled', !canRecall);

                overlay.style.display = 'block';
                menu.classList.remove('is-open');
                menu.style.top = '0px';
                menu.style.left = '0px';

                const rect = targetElement.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();

                let top = rect.top - menuRect.height - 8;
                if (top < 12) top = rect.bottom + 8;
                let left = rect.left + (rect.width - menuRect.width) / 2;
                left = Math.max(12, Math.min(left, window.innerWidth - menuRect.width - 12));

                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;

                requestAnimationFrame(() => menu.classList.add('is-open'));
            }

            hideMessageActionMenu() {
                const { overlay, menu } = this.actionMenu;
                if (!overlay || !menu) return;
                menu.classList.remove('is-open');
                overlay.style.display = 'none';
                this.actionMenu.current = null;
            }

            bindMessageActions(messageWrapper, targetElement, data) {
                if (!messageWrapper || !targetElement) return;
                let pressTimer = null;
                let startX = 0;
                let startY = 0;

                const clearPress = () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                };

                const startPress = (clientX, clientY) => {
                    startX = clientX;
                    startY = clientY;
                    clearPress();
                    pressTimer = setTimeout(() => {
                        this.showMessageActionMenu(targetElement, data);
                    }, 550);
                };

                targetElement.addEventListener('touchstart', (e) => {
                    if (e.touches && e.touches[0]) {
                        startPress(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, { passive: true });

                targetElement.addEventListener('touchmove', (e) => {
                    if (!e.touches || !e.touches[0]) return;
                    const dx = Math.abs(e.touches[0].clientX - startX);
                    const dy = Math.abs(e.touches[0].clientY - startY);
                    if (dx > 10 || dy > 10) clearPress();
                }, { passive: true });

                targetElement.addEventListener('touchend', clearPress);
                targetElement.addEventListener('touchcancel', clearPress);

                targetElement.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    startPress(e.clientX, e.clientY);
                });
                targetElement.addEventListener('mouseup', clearPress);
                targetElement.addEventListener('mouseleave', clearPress);

                targetElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showMessageActionMenu(targetElement, data);
                });
            }

            handleMessageAction(action) {
                const current = this.actionMenu.current;
                if (!current) return;
                const { messageWrapper, msgId, content, role } = current;

                if (action === 'copy') {
                    this.copyToClipboard(content || '');
                } else if (action === 'delete') {
                    this.deleteMessageLocal(messageWrapper, msgId);
                } else if (action === 'recall') {
                    if (role === 'user') this.recallMessage(messageWrapper, msgId);
                } else if (action === 'reply') {
                    this.setReplyPrefill(content || '', role);
                }

                this.hideMessageActionMenu();
            }

            copyToClipboard(text) {
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).catch(() => this.fallbackCopy(text));
                } else {
                    this.fallbackCopy(text);
                }
            }

            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                } catch (e) {
                    // ignore
                }
                document.body.removeChild(textarea);
            }

            deleteMessageLocal(messageWrapper, msgId) {
                if (messageWrapper) messageWrapper.remove();
                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isDeletedLocal = true;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            recallMessage(messageWrapper, msgId) {
                if (messageWrapper) {
                    messageWrapper.innerHTML = '';
                    messageWrapper.classList.add('message-recalled-wrapper');
                    const recalled = document.createElement('div');
                    recalled.className = 'message-recalled';
                    recalled.textContent = '消息已撤回';
                    messageWrapper.appendChild(recalled);
                }

                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isRecalled = true;
                    target.content = '消息已撤回';
                    target.isVoice = false;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            setReplyPrefill(content, role = '') {
                if (!content) return;
                const preview = content.replace(/\s+/g, ' ').trim();
                const snippet = preview.length > 24 ? preview.slice(0, 24) + '...' : preview;
                const fromName = role === 'user' ? '我' : this.getCurrentFriendName();
                chatInput.dataset.replyText = preview;
                chatInput.dataset.replyFrom = fromName;
                if (replyPreview && replyPreviewText) {
                    replyPreviewText.textContent = `${fromName}：${snippet}`;
                    replyPreview.style.display = 'flex';
                }
                chatInput.focus();
            }

            clearReplyPrefill() {
                delete chatInput.dataset.replyText;
                delete chatInput.dataset.replyFrom;
                if (replyPreview) replyPreview.style.display = 'none';
                if (replyPreviewText) replyPreviewText.textContent = '';
            }

            clearImageUpload() {
                delete chatInput.dataset.imageData;
                delete chatInput.dataset.imageName;
                delete chatInput.dataset.imageText;
                if (imageUploadPill) imageUploadPill.style.display = 'none';
                if (imageUploadThumb) imageUploadThumb.src = '';
                if (imageUploadName) imageUploadName.textContent = '已选择图片';
            }

            ensureHistoryIds(history) {
                let changed = false;
                const base = Date.now().toString();
                history.forEach((msg, index) => {
                    if (!msg.id) {
                        msg.id = `msg-${base}-${index}-${Math.random().toString(36).slice(2, 6)}`;
                        changed = true;
                    }
                });
                return changed;
            }

            addMessageToChat(content, role, isVoice = false, msgId = null, replyTo = '', replyFrom = '', imageData = '', imageName = '') {
                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.style.display = 'flex';
                messageWrapper.style.flexDirection = 'column';
                messageWrapper.style.alignItems = role === 'user' ? 'flex-end' : 'flex-start';
                if (msgId) messageWrapper.dataset.msgId = msgId;
                messageWrapper.dataset.role = role;
                messageWrapper.dataset.content = content;
                messageWrapper.dataset.isVoice = isVoice ? 'true' : 'false';
                const isImageDesc = imageName === '描述图';
                let actionTarget = null;

                if (replyTo) {
                    const replyBlock = document.createElement('div');
                    replyBlock.className = `reply-quote ${role}`;
                    const fromLabel = replyFrom || (role === 'user' ? '我' : this.getCurrentFriendName());
                    replyBlock.textContent = `${fromLabel}：${replyTo}`;
                    messageWrapper.appendChild(replyBlock);
                }

                if (imageData) {
                    const imageWrap = document.createElement('div');
                    imageWrap.className = `message-image-wrap ${role}`;

                    const imageEl = document.createElement('img');
                    imageEl.className = isImageDesc ? 'message-image desc-thumb' : 'message-image';
                    imageEl.src = imageData;
                    imageEl.alt = imageName || '图片';
                    imageWrap.appendChild(imageEl);

                    if (isImageDesc) {
                        const hint = document.createElement('div');
                        hint.className = 'message-image-hint';
                        hint.textContent = '点开看图';
                        imageWrap.appendChild(hint);
                    }

                    messageWrapper.appendChild(imageWrap);
                    actionTarget = imageWrap;

                    if (isImageDesc) {
                        imageWrap.style.cursor = 'pointer';
                        imageWrap.addEventListener('click', () => {
                            if (window.openImageDescModal) {
                                window.openImageDescModal(messageWrapper, msgId, content);
                            }
                        });
                    }
                }

                if (isVoice) {
                    const voiceContainer = document.createElement('div');
                    voiceContainer.style.display = 'flex';
                    voiceContainer.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';

                    const voiceMessage = document.createElement('div');
                    voiceMessage.className = `message ${role}`;
                    voiceMessage.style.display = 'flex';
                    voiceMessage.style.alignItems = 'center';
                    voiceMessage.style.gap = '8px';
                    voiceMessage.style.cursor = 'pointer';
                    voiceMessage.style.maxWidth = '200px';

                    const waveForm = document.createElement('div');
                    waveForm.style.display = 'flex';
                    waveForm.style.gap = '2px';
                    waveForm.style.alignItems = 'center';
                    waveForm.style.flex = '1';

                    for (let i = 0; i < 8; i++) {
                        const bar = document.createElement('div');
                        bar.style.width = '3px';
                        bar.style.height = Math.random() * 20 + 8 + 'px';
                        bar.style.backgroundColor = role === 'user' ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.3)';
                        bar.style.borderRadius = '2px';
                        waveForm.appendChild(bar);
                    }

                    const duration = Math.ceil(content.length / 5);
                    const duration_text = document.createElement('span');
                    duration_text.textContent = '"' + duration + '"';
                    duration_text.style.fontSize = '12px';
                    duration_text.style.whiteSpace = 'nowrap';
                    duration_text.style.color = role === 'user' ? 'inherit' : 'inherit';

                    voiceMessage.appendChild(waveForm);
                    voiceMessage.appendChild(duration_text);

                    voiceContainer.appendChild(voiceMessage);
                    messageWrapper.appendChild(voiceContainer);

                    const transcriptionDiv = document.createElement('div');
                    transcriptionDiv.style.display = 'none';
                    transcriptionDiv.style.marginTop = '8px';
                    transcriptionDiv.style.padding = '8px 12px';
                    transcriptionDiv.style.backgroundColor = role === 'user' ? '#FFB6D9' : '#f0f0f0';
                    transcriptionDiv.style.borderRadius = '8px';
                    transcriptionDiv.style.fontSize = '12px';
                    transcriptionDiv.style.color = role === 'user' ? 'white' : '#666';
                    transcriptionDiv.style.maxWidth = '220px';
                    transcriptionDiv.style.marginLeft = role === 'user' ? 'auto' : '0';
                    transcriptionDiv.style.marginRight = role === 'user' ? '0' : 'auto';
                    transcriptionDiv.textContent = content;

                    messageWrapper.appendChild(transcriptionDiv);

                    voiceMessage.addEventListener('click', () => {
                        if (transcriptionDiv.style.display === 'none') {
                            transcriptionDiv.style.display = 'block';
                        } else {
                            transcriptionDiv.style.display = 'none';
                        }
                    });

                    this.bindMessageActions(messageWrapper, voiceMessage, {
                        messageWrapper,
                        msgId,
                        content,
                        role,
                        isVoice,
                        isRecalled: false
                    });
                } else {
                    if (!isImageDesc) {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${role}`;
                        messageElement.textContent = content;
                        messageWrapper.appendChild(messageElement);
                        actionTarget = messageElement;
                    }

                    if (actionTarget) {
                        this.bindMessageActions(messageWrapper, actionTarget, {
                            messageWrapper,
                            msgId,
                            content,
                            role,
                            isVoice,
                            isRecalled: false
                        });
                    }
                }

                chatMessages.appendChild(messageWrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            addRecalledMessageToChat(msgId = null) {
                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.classList.add('message-recalled-wrapper');
                if (msgId) messageWrapper.dataset.msgId = msgId;

                const recalled = document.createElement('div');
                recalled.className = 'message-recalled';
                recalled.textContent = '消息已撤回';
                messageWrapper.appendChild(recalled);

                chatMessages.appendChild(messageWrapper);
            }

            sanitizeAiResponse(text) {
                if (!text) return '';
                const withoutParentheses = text
                    .replace(/\([^\)]*\)/g, '')
                    .replace(/（[^）]*）/g, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
                return withoutParentheses;
            }

            splitSentences(text) {
                const sentences = text.split(/([。！？\n]+)/);
                const result = [];

                for (let i = 0; i < sentences.length; i++) {
                    const sentence = sentences[i];
                    if (!sentence.trim()) continue;

                    if (/^[。！？\n]+$/.test(sentence)) {
                        if (result.length > 0) {
                            result[result.length - 1] += sentence;
                        }
                    } else {
                        result.push(sentence);
                    }
                }

                return result.length > 0 ? result : [text];
            }

            generateAIMessages(response, persona) {
                const sentences = this.splitSentences(response);
                const validSentences = sentences.filter(s => s.trim());

                const maxCount = Math.max(1, Math.min(10, validSentences.length));
                const minCount = Math.min(2, maxCount);
                const weighted = Math.random();
                let messageCount = Math.round(minCount + weighted * (maxCount - minCount));
                if (messageCount < minCount) messageCount = minCount;
                if (messageCount > maxCount) messageCount = maxCount;

                let voiceProbability = 0.55;

                if (persona) {
                    const personaLower = persona.toLowerCase();
                    if (personaLower.includes('话多') || personaLower.includes('健谈')) {
                        voiceProbability = 0.6;
                    } else if (personaLower.includes('沉默') || personaLower.includes('寡言')) {
                        voiceProbability = 0.2;
                    } else if (personaLower.includes('活泼') || personaLower.includes('开朗')) {
                        voiceProbability = 0.55;
                    } else if (personaLower.includes('冷淡') || personaLower.includes('冷酷')) {
                        voiceProbability = 0.15;
                    }
                }

                const messages = [];

                if (validSentences.length <= messageCount) {
                    for (const sentence of validSentences) {
                        messages.push({
                            content: sentence,
                            isVoice: Math.random() < voiceProbability
                        });
                    }
                } else {
                    let index = 0;
                    while (index < validSentences.length) {
                        const remaining = validSentences.length - index;
                        const maxChunk = remaining > 4 ? 2 : 1;
                        const chunkSize = Math.min(remaining, Math.random() < 0.35 ? 1 : maxChunk);
                        const chunk = validSentences.slice(index, index + chunkSize).join('');
                        messages.push({
                            content: chunk.trim(),
                            isVoice: Math.random() < voiceProbability
                        });
                        index += chunkSize;
                    }
                }

                const finalMessages = messages.slice(0, 10);
                const hasVoice = finalMessages.some(msg => msg.isVoice);
                if (!hasVoice && Math.random() < 0.6 && finalMessages.length > 0) {
                    finalMessages[0].isVoice = true;
                }
                return finalMessages;
            }

            getSharedState(key, defaultValue) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.getStorage === 'function') {
                        return this.friendSystem.getStorage(key, defaultValue);
                    }
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            }

            setSharedState(key, value) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.setStorage === 'function') {
                        this.friendSystem.setStorage(key, value);
                        return;
                    }
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    // ignore
                }
            }

            getImageShareHistory(friendId) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                const history = this.getSharedState(key, []);
                return Array.isArray(history) ? history : [];
            }

            saveImageShareHistory(friendId, history) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                this.setSharedState(key, history);
            }

            isImageShareOnCooldown(friendId, cooldownMs = 60 * 60 * 1000) {
                const now = Date.now();
                const globalLast = this.getSharedState('imgShareLastAt_global', 0) || 0;
                const friendLast = friendId ? (this.getSharedState(`imgShareLastAt_${friendId}`, 0) || 0) : 0;
                const lastAt = Math.max(globalLast, friendLast);
                return now - lastAt < cooldownMs;
            }

            markImageShareSent(friendId) {
                const now = Date.now();
                this.setSharedState('imgShareLastAt_global', now);
                if (friendId) this.setSharedState(`imgShareLastAt_${friendId}`, now);
            }

            async decideAiImageShare(aiResponse, persona, chatHistory, friendId, config, forceTrigger = false) {
                // 单次点击仅调用一次API：图片分享决策不再额外请求
                return null;
                
                // 修改此处：自动发送图片的触发概率 (0.0 - 1.0)，数值越小越难触发
                const TRIGGER_PROBABILITY = 0.05; 
                
                if (!forceTrigger) {
                    if (this.isImageShareOnCooldown(friendId)) return null;
                    if (Math.random() > TRIGGER_PROBABILITY) return null;
                }

                const recent = (chatHistory || [])
                    .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                    .slice(-8)
                    .map(msg => {
                        const role = (msg.role === 'ai' || msg.role === 'assistant') ? 'assistant' : 'user';
                        const content = msg.imageText ? `[图片文字]${msg.imageText}` : msg.content;
                        return `${role}:${content || ''}`;
                    })
                    .join('\n');

                const basePrompt = forceTrigger 
                    ? `你是视觉描述生成器。角色在对话中明确表示要发送图片（如“发给你看看”、“这是照片”）。\n请根据人设和对话上下文，生成这张图片的具体画面描述。`
                    : `你是对话理解引擎。目标：判断此刻是否自然适合由角色主动分享一张“文字图片”，并生成图片文字描述。`;

                const decisionPrompt = `${basePrompt}\n\n核心约束（至关重要）：\n- **描述必须是纯粹的视觉画面描写**（镜头、光影、主体、动作）。\n- **绝对禁止**包含任何对话内容、语音、心理活动或“发给你”、“你看”之类的文字。\n- **画面必须生动具体**：强调光影（如逆光、暖黄灯光）、色彩对比和材质细节（如发丝、水珠、衣褶）。\n- 描述风格需贴合人设（如高冷角色的照片可能构图简洁，活泼角色可能色彩鲜艳）。\n- 描述结构参考：景别（特写/中景）+ 主体（人/物）+ 动态/状态 + 环境光影 + 氛围细节。\n\n输出JSON（不要多余文字）：\n{\n  "shouldShare": true/false,\n  "description": "纯画面描述，不含对话。例：特写：一只修长的手拿着冰美式，背景是模糊的落地窗，阳光洒在袖口上",\n  "reason": "简短理由",\n  "mood": "简短情绪",\n  "confidence": 0-1\n}\n\n人设：${persona || '无'}\n最近对话：\n${recent}\nAI回复：${aiResponse}`;

                try {
                    const response = await fetch(`${config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: [
                                { role: 'system', content: '你是严格输出JSON的决策器，只能输出JSON。' },
                                { role: 'user', content: decisionPrompt }
                            ],
                            max_tokens: 220,
                            temperature: 0.4
                        })
                    });

                    if (!response.ok) return null;
                    const data = await response.json();
                    const raw = data.choices[0]?.message?.content || '';
                    const jsonMatch = raw.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) return null;
                    const decision = JSON.parse(jsonMatch[0]);
                    if (!decision || !decision.shouldShare) return null;

                    const desc = String(decision.description || '').trim();
                    if (!desc) return null;
                    const enhancedDesc = this.ensureConcreteImageDesc(desc, aiResponse || '');

                    const history = this.getImageShareHistory(friendId);
                    const normalizedDesc = enhancedDesc.toLowerCase();
                    const recentHistory = history.slice(-3).map(item => String(item || '').toLowerCase());
                    if (recentHistory.includes(normalizedDesc)) return null;

                    history.push(enhancedDesc);
                    if (history.length > 20) history.splice(0, history.length - 20);
                    this.saveImageShareHistory(friendId, history);

                    return { description: enhancedDesc };
                } catch (e) {
                    return null;
                }
            }

            ensureConcreteImageDesc(desc, aiResponse = '') {
                let text = String(desc || '').trim();
                if (!text) return '';

                text = text
                    .replace(/^\[图片\]/, '')
                    .replace(/^（图片）/, '')
                    .replace(/^(图片描述|描述|画面|场景)：/, '')
                    .trim();

                const abstractWords = ['感觉', '情绪', '氛围', '心情', '美好', '温柔', '治愈', '抽象', '朦胧', '意境', '梦', '思念', '浪漫'];
                const hasConcreteMarks = /特写|近景|中景|远景|侧脸|背影|手|眼|发|衣|光|影|雨|街|窗|灯|桌|椅|车|路|树|花|草|云|海|山|猫|狗/.test(text);
                const isAbstract = abstractWords.some(w => text.includes(w));
                const looksLikeDialogue = /[“”"']|说|问|回复|聊天|对话|表示|喊|发给你|你看|这是|我拍的|给你看/.test(text);

                if (hasConcreteMarks && !isAbstract && !looksLikeDialogue) return text;

                const parts = ['手指', '眼睛', '发梢', '侧脸', '肩颈', '锁骨', '背影'];
                const actions = ['轻轻抬起', '缓慢合拢', '微微倾斜', '正对镜头停住', '轻轻触碰'];
                const scenes = ['窗边的柔光里', '昏黄的室内灯光下', '雨后的街灯下', '清晨的自然光中', '安静的室内背景前'];
                const details = ['指节纹理清晰可见', '睫毛投下细小阴影', '发丝贴在颈侧', '衣料褶皱被光线勾勒', '皮肤细小纹理清晰'];

                const seedText = text || String(aiResponse || '');
                const seed = Math.max(0, seedText.length);
                const subject = parts[seed % parts.length];
                const action = actions[seed % actions.length];
                const scene = scenes[seed % scenes.length];
                const detail = details[seed % details.length];
                return `特写：${subject}${action}，${scene}，${detail}`;
            }

            buildFallbackHeartVoice(aiResponse = '', persona = '') {
                const raw = String(aiResponse || '').replace(/\s+/g, ' ').trim();
                const base = raw || '（沉默）';
                const heartVoice = base.length > 40 ? base.slice(0, 40) : base;

                let mood = 55;
                if (/(开心|喜欢|谢谢|太好了|好耶|哈哈|哈哈哈|耶|甜|暖|欣喜)/.test(raw)) {
                    mood = 78;
                } else if (/(难过|生气|烦|讨厌|压力|累|哭|失望|委屈|难受)/.test(raw)) {
                    mood = 35;
                } else if (/(冷淡|无语|不想|算了|沉默|随便)/.test(raw)) {
                    mood = 45;
                }

                if (persona && /活泼|开朗|热情|阳光/.test(persona)) {
                    mood = Math.min(90, mood + 8);
                } else if (persona && /冷淡|高冷|寡言|沉默/.test(persona)) {
                    mood = Math.max(15, mood - 8);
                }

                const status = mood >= 70 ? '✿ 心情不错' : mood >= 50 ? '• 平静' : '☁ 有点低落';
                return {
                    reply: raw || '（沉默）',
                    heart_voice: heartVoice || '（沉默）',
                    status,
                    mood_value: mood
                };
            }

            addLoadingMessage(id) {
                const loadingElement = document.createElement('div');
                loadingElement.id = id;
                loadingElement.className = 'message ai';
                loadingElement.innerHTML = '<span class="loading"></span> 思考中...';
                chatMessages.appendChild(loadingElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            removeLoadingMessage(id) {
                const loadingElement = document.getElementById(id);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            openChatWithFriend(friend) {
                const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                const freshFriend = friends.find(f => f.id === friend.id) || friend;
                this.currentFriendId = freshFriend.id;
                chatTitle.textContent = friend.name;

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                const apiWarning = document.getElementById('apiWarning');
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    apiWarning.style.display = 'block';
                } else {
                    apiWarning.style.display = 'none';
                }

                const history = this.friendSystem ? this.friendSystem.getFriendChatHistory(friend.id) : [];
                const historyChanged = this.ensureHistoryIds(history);
                if (historyChanged && this.friendSystem) {
                    this.friendSystem.saveFriendChatHistory(friend.id, history);
                }
                chatMessages.innerHTML = '';

                history.forEach(msg => {
                    if (msg.isDeletedLocal) return;
                    if (msg.isRecalled) {
                        this.addRecalledMessageToChat(msg.id);
                        return;
                    }
                    this.addMessageToChat(
                        msg.content,
                        msg.role,
                        !!msg.isVoice,
                        msg.id,
                        msg.replyTo || '',
                        msg.replyFrom || '',
                        msg.imageData || '',
                        msg.imageName || ''
                    );
                });

                chatModal.style.display = 'flex';
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    chatInput.focus();
                }, 100);
            }

            async sendMessage() {
                const message = chatInput.value.trim();
                const imageData = chatInput.dataset.imageData || '';
                const imageName = chatInput.dataset.imageName || '';
                const imageText = chatInput.dataset.imageText || '';
                if (!message && !imageData) return;

                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({
                        signal: 'fa-signal',
                        wifi: 'fa-wifi',
                        battery: 'fa-battery-three-quarters'
                    });
                }

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    this.showChatStatus('请先配置API和选择模型', 'error');
                    return;
                }

                const isVoice = chatInput.dataset.isVoice === 'true';
                const replyTo = chatInput.dataset.replyText || '';
                const replyFrom = chatInput.dataset.replyFrom || '';
                const msgId = Date.now().toString();

                this.addMessageToChat(message, 'user', isVoice, msgId, replyTo, replyFrom, imageData, imageName);
                chatInput.value = '';
                chatInput.dataset.isVoice = 'false';
                this.clearReplyPrefill();
                this.clearImageUpload();

                if (this.currentFriendId) {
                    const chatHistory = this.friendSystem ? this.friendSystem.getFriendChatHistory(this.currentFriendId) : [];
                    // 保存消息，标记为未回复 (isReplied: false)
                    // 添加时间戳以便心声系统判断
                    const timestamp = Date.now();
                    
                    // 1. 生成心声数据
                    let heartVoiceData = null;
                    if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem) {
                        heartVoiceData = heartVoiceSystem.generateHeartVoice(this.currentFriendId);
                        console.log('[心声系统] 发送消息时生成心声:', heartVoiceData);
                        
                        // 4. 保存心声数据到本地存储
                        if (heartVoiceData) {
                            const oldData = heartVoiceSystem.getData(this.currentFriendId) || {};
                            const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];
                            const newData = {
                                lastUpdate: timestamp,
                                voice: heartVoiceData.heart_voice || '（沉默）',
                                status: heartVoiceData.status || '',
                                mood: heartVoiceData.mood_value ?? 50,
                                history: [...oldHistory, {
                                    time: timestamp,
                                    voice: heartVoiceData.heart_voice || '（沉默）',
                                    mood: heartVoiceData.mood_value ?? 50
                                }]
                            };
                            heartVoiceSystem.saveData(this.currentFriendId, newData);
                            
                            // 5. 更新心声面板显示
                            if (document.querySelector('.heart-voice-popup.is-open')) {
                                heartVoiceSystem.render(this.currentFriendId);
                            }
                        }
                    }
                    
                    // 2. 将心声数据嵌入用户消息
                    const messageWithHeartVoice = {
                        role: 'user',
                        content: message,
                        isVoice: isVoice,
                        isReplied: false,
                        id: msgId,
                        timestamp: timestamp,
                        replyTo: replyTo || '',
                        replyFrom: replyFrom || '',
                        imageData: imageData || '',
                        imageName: imageName || '',
                        imageText: imageText || '',
                        // 嵌入心声数据
                        heartVoice: heartVoiceData ? {
                            voice: heartVoiceData.heart_voice,
                            status: heartVoiceData.status,
                            mood: heartVoiceData.mood_value
                        } : null
                    };
                    
                    chatHistory.push(messageWithHeartVoice);
                    if (this.friendSystem) {
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, chatHistory);
                    }
                }
            }

            async triggerAI(targetMsgId = null) {
                if (this.isProcessing) return;
                this.isProcessing = true;

                const loadingId = 'loading-' + Date.now();
                this.addLoadingMessage(loadingId);
                
                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };

                try {
                    let systemPrompt = '你是一个友好的AI助手。严格规则：禁止使用任何括号，包括英文与中文括号；禁止动作说明或旁白；情绪必须通过语言本身表达。对话要自然，像真实聊天。请记住并参考最近对话内容。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。';
                    if (this.currentFriendId) {
                        const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                        const friend = friends.find(f => f.id === this.currentFriendId);
                        const personaInfo = this.friendSystem ? this.friendSystem.getPersona(this.currentFriendId) : null;
                        const persona = personaInfo?.raw ?? friend?.persona ?? '';
                        if (friend) {
                            const personaProfile = {
                                name: friend.name,
                                persona: persona,
                                goals: '以真实自然的聊天风格交流，体现角色背景与性格',
                                style: '像真实人类聊天，不做旁白或动作说明',
                                emotion: '用语言表达情绪，不用任何括号',
                                memory: '牢记最近对话并连贯回应'
                            };
                            systemPrompt = `你将扮演以下角色并自然聊天，不要像剧本：\n角色资料JSON：${JSON.stringify(personaProfile)}\n硬性规则：禁止使用任何括号，包括英文与中文括号；禁止动作说明或旁白；情绪必须通过语言本身表达。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。请记住并参考最近对话内容。`;
                        }
                    }

                    const chatHistory = this.currentFriendId && this.friendSystem
                        ? this.friendSystem.getFriendChatHistory(this.currentFriendId)
                        : [];
                    const hasImageInput = chatHistory.some(msg => msg && msg.imageData);
                    if (hasImageInput) {
                        systemPrompt += ' 重要：当有图片输入时，请先识别图片中的文字内容并回答用户问题。';
                    }

                    // 筛选需要回复的消息
                    let pendingMessages = [];
                    if (targetMsgId) {
                        const targetMessage = chatHistory.find(m => m.id === targetMsgId) || null;
                        if (targetMessage && targetMessage.role === 'user') {
                            pendingMessages = [targetMessage];
                        }
                    } else {
                        // 普通呼唤：收集所有未回复的消息 (兼容旧数据：无isReplied字段视为已回复)
                        pendingMessages = chatHistory.filter(m => m.role === 'user' && m.isReplied === false);
                    }

                    // 即使没有未回复消息，只要用户点击了，也允许触发（例如继续生成）

                    const promptHistory = chatHistory
                        .filter(msg => !msg.isDeletedLocal && !msg.isRecalled)
                        .slice(-20)
                        .map(msg => {
                            const normalizedRole = (msg.role === 'ai' || msg.role === 'assistant')
                                ? 'assistant'
                                : 'user';

                            if (normalizedRole === 'user' && msg.imageData) {
                                const rawText = msg.content && msg.content.trim() ? msg.content.trim() : '';
                                const isDescImage = msg.imageName === '描述图';
                                if (isDescImage) {
                                    const imageText = (msg.imageText && msg.imageText.trim()) ? msg.imageText.trim() : rawText;
                                    const descHint = '这是用文字模拟的图片内容，请把下面文字当作图片里的内容来理解并回答。图片文字如下：';
                                    const textContent = imageText ? `${descHint}\n${imageText}` : descHint;
                                    return {
                                        role: 'user',
                                        content: textContent
                                    };
                                }
                                const imageHint = '这是图片输入，请识别图片中的文字内容，必要时简要说明。';
                                const textContent = rawText ? `${rawText}\n${imageHint}` : imageHint;
                                return {
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: textContent },
                                        { type: 'image_url', image_url: { url: msg.imageData, detail: 'high' } }
                                    ]
                                };
                            }

                            return {
                                role: normalizedRole,
                                content: msg.content
                            };
                        });

                    if (promptHistory.length === 0) {
                        promptHistory.push({ role: 'user', content: '继续' });
                    } else if (promptHistory[promptHistory.length - 1].role === 'assistant') {
                        promptHistory.push({ role: 'user', content: '继续' });
                    }

                    // 获取最新的心声数据嵌入到系统提示
                    let heartVoiceContext = '';
                    if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem && this.currentFriendId) {
                        const latestHeartData = heartVoiceSystem.getData(this.currentFriendId);
                        if (latestHeartData) {
                            heartVoiceContext = `\n\n【角色当前内心状态参考】心声："${latestHeartData.voice || '无'}"｜状态：${latestHeartData.status || '无'}｜心情值：${latestHeartData.mood ?? 50}%\n请基于这些内心状态信息来生成更符合角色当前心理的回复和新的心声。`;
                        }
                    }

                    const enhancedSystemPrompt = systemPrompt + heartVoiceContext;

                    const messages = [
                        { role: 'system', content: enhancedSystemPrompt },
                        ...promptHistory
                    ];

                    const response = await fetch(`${config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: messages,
                            max_tokens: 500,
                            temperature: 0.9,
                            tools: [
                                {
                                    type: 'function',
                                    function: {
                                        name: 'generate_response_with_heart_voice',
                                        description: '生成回复内容以及角色的心声数据。心声分析规则：分析最近5条对话的主题和情绪，结合好友人设的性格关键词，参考当前时间段，基于上次心情值在±10范围内变化，对话活跃度影响心情变化。',
                                        parameters: {
                                            type: 'object',
                                            properties: {
                                                reply: { type: 'string', description: '对用户的回复内容，要符合角色人设和当前心理状态' },
                                                heart_voice: { type: 'string', description: '角色的内心想法/内心独白，不是直接回复对话内容，要符合人设性格，40字以内。例如傲娇角色："才不是因为开心呢...只是天气不错"' },
                                                status: { type: 'string', description: '颜文字 + 渺小外观描述。例如："(´･ω･`) 轻轻晃着腿" 或 "(*´▽`*) 眼睛亮晶晶的"' },
                                                mood_value: { type: 'integer', description: '0-100的整数，需要基于对话内容和上次心情在±10范围内合理变化，体现情绪变化的连贯性' }
                                            },
                                            required: ['reply', 'heart_voice', 'status', 'mood_value']
                                        }
                                    }
                                }
                            ],
                            tool_choice: { type: 'function', function: { name: 'generate_response_with_heart_voice' } }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const messagePayload = data.choices[0]?.message || {};
                    
                    let heartVoiceData = null;
                    let rawAiResponse = messagePayload.content || '';

                    const toolCalls = Array.isArray(messagePayload.tool_calls) ? messagePayload.tool_calls : [];
                    const functionCall = messagePayload.function_call;
                    const toolFunction = toolCalls.find(call => call?.function?.name === 'generate_response_with_heart_voice') 
                                         || (functionCall?.name === 'generate_response_with_heart_voice' ? { function: functionCall } : null);

                    if (toolFunction) {
                        const rawArgs = toolFunction.function.arguments;
                        if (rawArgs) {
                            try {
                                const args = typeof rawArgs === 'string' ? JSON.parse(rawArgs) : rawArgs;
                                if (args.reply) rawAiResponse = args.reply;
                                heartVoiceData = args;
                            } catch (e) {
                                console.error('解析心声数据失败', e);
                            }
                        }
                    }
                    
                    if (!rawAiResponse) rawAiResponse = '抱歉，我暂时无法回答这个问题。';
                    const aiResponse = this.sanitizeAiResponse(rawAiResponse);

                    this.removeLoadingMessage(loadingId);

                    const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                    const currentFriend = friends.find(f => f.id === this.currentFriendId);
                    const currentPersona = this.friendSystem ? (this.friendSystem.getPersona(this.currentFriendId)?.raw ?? currentFriend?.persona ?? '') : '';
                    const resolvedHeartVoice = heartVoiceData || this.buildFallbackHeartVoice(aiResponse, currentPersona || '');

                    const aiMessages = this.generateAIMessages(aiResponse, currentPersona || '');
                    const aiBase = Date.now().toString();
                    const aiMessagePayloads = aiMessages.map((aiMsg, index) => ({
                        ...aiMsg,
                        id: `ai-${aiBase}-${index}-${Math.random().toString(36).slice(2, 6)}`
                    }));
                    const extraImagePayloads = [];

                    for (const aiMsg of aiMessagePayloads) {
                        this.addMessageToChat(aiMsg.content, 'ai', aiMsg.isVoice, aiMsg.id);
                        if (this.currentFriendId) {
                            chatHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }
                        await new Promise(resolve => setTimeout(resolve, 600));
                    }

                    // 心声存储与刷新
                    if (resolvedHeartVoice && heartVoiceSystem && this.currentFriendId) {
                        const heartVoiceText = String(resolvedHeartVoice.heart_voice || '').trim();
                        const heartStatus = String(resolvedHeartVoice.status || '').trim();
                        const moodValue = Number(resolvedHeartVoice.mood_value);
                        
                        console.log('[心声系统] AI回复时保存心声:', {
                            friendId: this.currentFriendId,
                            heartVoice: heartVoiceText,
                            status: heartStatus,
                            mood: moodValue
                        });
                        
                        if (heartVoiceText || heartStatus || Number.isFinite(moodValue)) {
                            const oldData = heartVoiceSystem.getData(this.currentFriendId) || {};
                            const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];
                            const newData = {
                                lastUpdate: Date.now(),
                                voice: heartVoiceText || '（沉默）',
                                status: heartStatus || '',
                                mood: Number.isFinite(moodValue) ? Math.max(0, Math.min(100, Math.round(moodValue))) : 50,
                                history: [...oldHistory, {
                                    time: Date.now(),
                                    voice: heartVoiceText || '（沉默）',
                                    mood: Number.isFinite(moodValue) ? Math.max(0, Math.min(100, Math.round(moodValue))) : 50
                                }]
                            };
                        heartVoiceSystem.saveData(this.currentFriendId, newData);
                        console.log('[心声系统] 心声数据已保存:', newData);
                        
                        // 心声面板打开时立即刷新
                        if (document.querySelector('.heart-voice-popup.is-open')) {
                            heartVoiceSystem.render(this.currentFriendId);
                        }
                        }
                    }
                    // 若未返回function_call则保持旧数据

                    const shouldTriggerImage = /(发照片|发图|发给你|给你看|发一张|给你发|给你看看|我发你|我拍的|这是我拍的|看图|看照片)/.test(aiResponse);
                    const randomTrigger = Math.random() < 0.02;
                    const shouldGenerateImage = (shouldTriggerImage || randomTrigger) && !!aiResponse;

                    if (shouldGenerateImage) {
                        const fallbackText = this.ensureConcreteImageDesc(aiResponse || '', aiResponse || '');
                        const imageDecision = fallbackText ? { description: fallbackText } : null;
                        if (!imageDecision || !imageDecision.description) {
                            // 无合适内容则跳过
                        } else {
                        const imageId = `ai-img-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
                        const imageData = typeof getImageDescPlaceholderData === 'function'
                            ? getImageDescPlaceholderData()
                            : '';
                        const imageText = this.ensureConcreteImageDesc(imageDecision.description, aiResponse);
                        const imageType = shouldTriggerImage ? '图片' : '描述图';
                        this.addMessageToChat(imageText, 'ai', false, imageId, '', '', imageData, imageType);
                        if (this.currentFriendId) {
                            const imagePayload = {
                                role: 'assistant',
                                content: imageText,
                                isVoice: false,
                                id: imageId,
                                imageData: imageData,
                                imageName: imageType,
                                imageText: imageText,
                                timestamp: Date.now()
                            };
                            chatHistory.push(imagePayload);
                            extraImagePayloads.push(imagePayload);
                        }
                        this.markImageShareSent(this.currentFriendId);
                        }
                    }

                    if (this.currentFriendId && this.friendSystem) {
                        // 更新真实历史记录
                        const realHistory = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                        
                        // 1. 标记已回复
                        pendingMessages.forEach(pm => {
                            const match = realHistory.find(m => m.id === pm.id);
                            if (match) match.isReplied = true;
                        });
                        
                        // 2. 追加 AI 回复
                        for (const aiMsg of aiMessagePayloads) {
                            realHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }
                        if (extraImagePayloads.length > 0) {
                            extraImagePayloads.forEach(payload => {
                                realHistory.push({ ...payload });
                            });
                        }
                        
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, realHistory);
                    }

                    // 心声已由本次API返回，避免二次请求
                } catch (error) {
                    console.error('发送消息失败:', error);
                    this.removeLoadingMessage(loadingId);

                    const errorElement = document.createElement('div');
                    errorElement.className = 'message ai';
                    let errorMsg = error.message;
                    let friendlyMsg = '抱歉，出错了';

                    if (error.message.includes('Failed to fetch')) {
                        errorMsg = '网络连接失败，请检查API地址是否正确';
                        friendlyMsg = '网络连接失败，请检查网络';
                    } else if (error.message.includes('401')) {
                        errorMsg = 'API密钥错误或已过期，请检查API配置';
                        friendlyMsg = 'API密钥不对，请重新配置';
                    } else if (error.message.includes('429')) {
                        errorMsg = 'API请求过于频繁，请稍候再试';
                        friendlyMsg = '请求过于频繁，请稍候再试';
                    } else if (error.message.includes('API请求失败')) {
                        errorMsg = '调用API失败，请检查配置是否正确';
                        friendlyMsg = 'API调用失败，请检查配置';
                    } else if (error.message.includes('500')) {
                        friendlyMsg = '服务器错误，请稍候再试';
                    } else if (error.message.includes('503')) {
                        friendlyMsg = '服务暂时不可用，请稍候再试';
                    }

                    errorElement.textContent = friendlyMsg;
                    chatMessages.appendChild(errorElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    this.showChatStatus(`错误：${errorMsg}`, 'error');
                } finally {
                    this.isProcessing = false;
                }
            }

            getCurrentFriendId() {
                return this.currentFriendId;
            }

            setCurrentFriendId(id) {
                this.currentFriendId = id || null;
            }
        }
        
        // ========== 事件监听器绑定 ==========
        
        // API相关按钮
        fetchModelsBtn.addEventListener('click', () => apiService && apiService.fetchModels());
        testApiBtn.addEventListener('click', () => apiService && apiService.testConnection());
        saveApiBtn.addEventListener('click', () => apiService && apiService.saveConfiguration());

        // 模型选择器交互（自定义下拉）
        if (modelPickerButton && modelPickerList) {
            modelPickerButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modelPickerButton.disabled) return;
                modelPickerList.classList.toggle('is-open');
            });

            document.addEventListener('click', (e) => {
                if (!modelPickerList.classList.contains('is-open')) return;
                const target = e.target;
                if (target === modelPickerButton || modelPickerList.contains(target)) {
                    return;
                }
                modelPickerList.classList.remove('is-open');
            });
        }
        
        // 聊天相关按钮
        sendMessageBtn.addEventListener('click', () => chatSession && chatSession.sendMessage());
        if (triggerAiBtn) triggerAiBtn.addEventListener('click', () => chatSession && chatSession.triggerAI());

        function closeChatExtraPanel() {
            if (!chatExtraPanel) return;
            chatExtraPanel.classList.remove('is-open');
            chatExtraPanel.setAttribute('aria-hidden', 'true');
            if (chatPlusBtn) chatPlusBtn.setAttribute('aria-expanded', 'false');
            if (chatInputAreaWrap) chatInputAreaWrap.classList.remove('chat-extra-open');
            if (chatInputRow) chatInputRow.style.display = 'flex';
        }

        if (chatPlusBtn && chatExtraPanel) {
            chatPlusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = chatExtraPanel.classList.toggle('is-open');
                chatExtraPanel.setAttribute('aria-hidden', String(!isOpen));
                chatPlusBtn.setAttribute('aria-expanded', String(isOpen));
                if (chatInputAreaWrap) {
                    chatInputAreaWrap.classList.toggle('chat-extra-open', isOpen);
                }
                if (chatInputRow) {
                    chatInputRow.style.display = isOpen ? 'none' : 'flex';
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (!chatExtraPanel || !chatExtraPanel.classList.contains('is-open')) return;
            const target = e.target;
            if (chatExtraPanel.contains(target)) return;
            if (chatPlusBtn && chatPlusBtn.contains(target)) return;
            closeChatExtraPanel();
        });

        
        // 语音输入相关
        const voiceModal = document.getElementById('voiceModal');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const closeVoiceModal = document.getElementById('closeVoiceModal');
        const cancelVoiceInput = document.getElementById('cancelVoiceInput');
        const confirmVoiceInput = document.getElementById('confirmVoiceInput');
        const voiceText = document.getElementById('voiceText');
        const cameraInputBtn = document.getElementById('cameraInputBtn');
        const cameraDescModal = document.getElementById('cameraDescModal');
        const closeCameraDescModal = document.getElementById('closeCameraDescModal');
        const cancelCameraDesc = document.getElementById('cancelCameraDesc');
        const confirmCameraDesc = document.getElementById('confirmCameraDesc');
        const cameraDescText = document.getElementById('cameraDescText');
        const imageDescModal = document.getElementById('imageDescModal');
        const closeImageDescModal = document.getElementById('closeImageDescModal');
        const imageDescText = document.getElementById('imageDescText');
        let pendingImageDesc = null;
        
        voiceInputBtn.addEventListener('click', () => {
            voiceText.value = '';
            voiceModal.style.display = 'flex';
            voiceText.focus();
        });
        
        closeVoiceModal.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });
        
        cancelVoiceInput.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });
        
        confirmVoiceInput.addEventListener('click', () => {
            const message = voiceText.value.trim();
            if (message) {
                chatInput.value = message;
                chatInput.dataset.isVoice = 'true';
                voiceModal.style.display = 'none';
                if (chatSession) chatSession.sendMessage();
            }
        });
        
        // 点击模态框背景关闭
        voiceModal.addEventListener('click', (e) => {
            if (e.target === voiceModal) {
                voiceModal.style.display = 'none';
            }
        });
        function getImageDescPlaceholderData() {
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f3f3f5"/>
      <stop offset="1" stop-color="#e7e7eb"/>
    </linearGradient>
  </defs>
  <rect width="240" height="240" rx="24" fill="url(#g)"/>
  <circle cx="80" cy="90" r="26" fill="#d7d7de"/>
  <path d="M40 180 L110 120 L150 160 L200 120 L220 180 Z" fill="#d0d0d8"/>
</svg>`;
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
        }

        if (cameraInputBtn && cameraDescModal) {
            cameraInputBtn.addEventListener('click', () => {
                if (cameraDescText) cameraDescText.value = '';
                cameraDescModal.style.display = 'flex';
                if (cameraDescText) cameraDescText.focus();
            });
        }

        if (closeCameraDescModal) {
            closeCameraDescModal.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (cancelCameraDesc) {
            cancelCameraDesc.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (confirmCameraDesc) {
            confirmCameraDesc.addEventListener('click', () => {
                const desc = cameraDescText ? cameraDescText.value.trim() : '';
                if (!desc) return;
                chatInput.value = desc;
                chatInput.dataset.imageData = getImageDescPlaceholderData();
                chatInput.dataset.imageName = '描述图';
                chatInput.dataset.imageText = desc;
                chatInput.dataset.isVoice = 'false';
                if (chatSession) chatSession.sendMessage();
                cameraDescModal.style.display = 'none';
            });
        }

        if (cameraDescModal) {
            cameraDescModal.addEventListener('click', (e) => {
                if (e.target === cameraDescModal) {
                    cameraDescModal.style.display = 'none';
                }
            });
        }

        function closeImageDesc() {
            if (!imageDescModal) return;
            imageDescModal.style.display = 'none';
            pendingImageDesc = null;
        }

        window.openImageDescModal = (messageWrapper, msgId, content) => {
            if (!imageDescModal || !imageDescText) return;
            imageDescText.value = content || '';
            pendingImageDesc = { messageWrapper, msgId };
            imageDescModal.style.display = 'flex';
        };

        if (closeImageDescModal) {
            closeImageDescModal.addEventListener('click', closeImageDesc);
        }

        if (imageDescModal) {
            imageDescModal.addEventListener('click', (e) => {
                if (e.target === imageDescModal) {
                    closeImageDesc();
                }
            });
        }
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (chatSession) chatSession.sendMessage();
            }
        });
        
        // ========== 初始化 ==========

        const appCatalog = [
            { id: 'message', name: '消息', iconClass: 'fa-envelope', styleClass: 'message-icon' },
            { id: 'feixin', name: '甜聊', iconClass: 'fa-comment-dots', styleClass: 'feixin-icon' },
            { id: 'worldbook', name: '世界书', iconClass: 'fa-book-open', styleClass: 'book-icon' },
            { id: 'settings', name: '设置', iconClass: 'fa-cog', styleClass: 'settings-icon' },
            { id: 'beautify', name: '美化', iconClass: 'fa-paint-brush', styleClass: 'brush-icon' },
            { id: 'phone', name: '手机', iconClass: 'fa-mobile-alt', styleClass: 'phone-icon' },
            { id: 'novel', name: '小说', iconClass: 'fa-book', styleClass: 'novel-icon' },
            { id: 'forum', name: '论坛', iconClass: 'fa-comments', styleClass: 'forum-icon' }
        ];

        function renderHomeApps() {
            if (!appGrid) return;
            const selected = APP_ENTRY_POINTS.home || [];
            appGrid.innerHTML = '';
            selected.forEach(appId => {
                const app = appCatalog.find(item => item.id === appId);
                if (!app) return;

                const item = document.createElement('div');
                item.className = 'app-item';
                item.dataset.appId = app.id;

                const icon = document.createElement('div');
                icon.className = `app-icon ${app.styleClass}`;
                icon.innerHTML = `<i class="fas ${app.iconClass}"></i>`;

                const name = document.createElement('div');
                name.className = 'app-name';
                name.textContent = app.name;

                item.appendChild(icon);
                item.appendChild(name);

                item.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });

                item.addEventListener('click', () => {
                    handleAppClick(app.id);
                });

                appGrid.appendChild(item);
            });
        }

        function registerApps() {
            if (!window.appManager || typeof window.appManager.register !== 'function') return;
            appCatalog.forEach(app => {
                try {
                    window.appManager.register(app.id, {
                        name: app.name,
                        icon: app.iconClass,
                        version: '1.0.0'
                    });
                } catch (e) {
                    // 已注册时忽略
                }
            });
        }
        
        // ========== 隐藏状态栏功能 ==========
        function initHideStatusBar() {
            const hideStatusBarToggle = document.getElementById('hideStatusBarToggle');
            if (!hideStatusBarToggle) return;

            // 从 localStorage 读取状态
            const isHidden = localStorage.getItem('hideStatusBar') === 'true';
            hideStatusBarToggle.checked = isHidden;

            // 应用初始状态
            if (isHidden) {
                document.body.classList.add('hide-status-bar');
            }

            // 监听开关变化
            hideStatusBarToggle.addEventListener('change', (e) => {
                const checked = e.target.checked;
                localStorage.setItem('hideStatusBar', checked);

                if (checked) {
                    document.body.classList.add('hide-status-bar');
                } else {
                    document.body.classList.remove('hide-status-bar');
                }
            });
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            friendSystem = new FriendSystem();
            apiService = new ApiService(friendSystem);
            chatSession = new ChatSession(friendSystem, apiService);
            heartVoiceSystem = new HeartVoiceSystem(friendSystem, apiService);
            profileWidget = new ProfileWidget();

            registerApps();
            renderHomeApps();
            loadGreetingText();
            if (greetingText) {
                greetingText.addEventListener('click', enableGreetingEdit);
                greetingText.addEventListener('blur', saveGreetingText);
                greetingText.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        greetingText.blur();
                    }
                });
            }
            if (window.appManager && typeof window.appManager.setStatus === 'function') {
                window.appManager.setStatus({
                    signal: 'fa-signal',
                    wifi: 'fa-wifi',
                    battery: 'fa-battery-three-quarters'
                });
            }
            if (friendSystem) {
                friendSystem.init();
            }

            // ========== 虚拟键盘自动滚动功能 ==========
            // 当虚拟键盘弹出时，自动滚动聊天内容，确保输入框可见且能看到最新消息
            let initialViewportHeight = window.innerHeight;
            let isKeyboardOpen = false;

            // 监听输入框焦点事件
            if (chatInput) {
                chatInput.addEventListener('focus', () => {
                    isKeyboardOpen = true;
                    // 延迟执行，等待键盘完全弹出
                    setTimeout(() => {
                        if (chatMessages) {
                            // 滚动到最新消息
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        // 确保输入框可见
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                });

                chatInput.addEventListener('blur', () => {
                    isKeyboardOpen = false;
                    // 键盘收起后恢复原样
                    setTimeout(() => {
                        initialViewportHeight = window.innerHeight;
                    }, 300);
                });
            }

            // 监听窗口大小变化（键盘弹出/收起会改变viewport高度）
            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;

                // 如果高度变小且输入框有焦点，说明键盘弹出
                if (currentHeight < initialViewportHeight && document.activeElement === chatInput) {
                    if (chatMessages) {
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 100);
                    }
                }
                // 如果高度恢复且输入框失去焦点，说明键盘收起
                else if (currentHeight > initialViewportHeight && !isKeyboardOpen) {
                    initialViewportHeight = currentHeight;
                }
            });
            // ========== 虚拟键盘自动滚动功能结束 ==========
            if (apiService) apiService.updateSettingsDisplay();
            if (profileWidget) profileWidget.init();

            // 初始化隐藏状态栏功能
            initHideStatusBar();
            
            // 为所有图标添加悬停效果
            const allIcons = document.querySelectorAll('.app-icon, .dock-icon, .left-icon, .app-item');
            allIcons.forEach(icon => {
                icon.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });
            });
            
            // 加载已保存的模型列表
            if (apiService) {
                const config = apiService.getConfig();
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            }
        });
})();
    </script>
</body>
</html>
>>>>>>> 71534c32b127b3a5b1416abc96e5bd7b2634047d
